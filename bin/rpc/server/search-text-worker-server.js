"use strict";(()=>{var g=class{static defer(){let e,r,t=new Promise((n,a)=>{e=n,r=a}),s=t;return s.resolve=e,s.reject=r,t}};var c=class i{static THREAD_TYPES=["Window","DedicatedWorkerGlobalScope","ServiceWorkerGlobalScope","SharedWorkerGlobalScope"];static THREAD_TYPE=self.constructor.name;static THREAD_TYPE_IDX=i.THREAD_TYPES.indexOf(i.THREAD_TYPE);static THREAD_ID;static IS_MOBILE_PLATFORM;static _debounceTimer;static deepClone(e){if(e===null||typeof e!="object")return e;if(Array.isArray(e))return e.map(t=>i.deepClone(t));let r={};for(let t in e)e.hasOwnProperty(t)&&(r[t]=i.deepClone(e[t]));return r}static debounce(e,r){clearTimeout(i._debounceTimer),i._debounceTimer=setTimeout(e,r)}static _setIsMobilePlatform(){if(i.IS_MOBILE_PLATFORM!==void 0)return;let e=navigator.userAgent.match(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i),r="ontouchstart"in(i.THREAD_TYPE_IDX===0?window:self),t="accelerometer"in(i.THREAD_TYPE_IDX===0?window:self);i.IS_MOBILE_PLATFORM=!!(e||r||t),console.log(`Thread#[${i.THREAD_TYPE_IDX}].IS_MOBILE=${i.IS_MOBILE_PLATFORM}`)}static _setThreadId(){if(i.THREAD_TYPE_IDX===0)i.THREAD_ID=i.THREAD_TYPE;else if(i.THREAD_TYPE_IDX===2){let e="/indeterminant-scriptURL";"serviceWorker"in self&&"scriptURL"in self.serviceWorker&&(e=self.serviceWorker.scriptURL),i.THREAD_ID=`sw${e.substring(e.lastIndexOf("/"))}`}else if(i.THREAD_ID=self.name,!i.THREAD_ID)throw new Error("IllegalState: All web workers & shared workers must be named via the constructor!")}static{i._setThreadId(),i._setIsMobilePlatform()}};var u=class i{static _resolvedPromise=Promise.resolve(void 0);static _promiseHashMap=new Map;api=NaN;_rpcIdxFuncMap=new Map;_rpcFuncIdxMap=new Map;_orderedTransferredPortMaps=[];_namedTransferredPortMaps=new Map;bindRpcFunc(e,r,t){let s=this._rpcIdxFuncMap.size;this._rpcIdxFuncMap.set(s,{thisArg:e,run:r,...t}),this._rpcFuncIdxMap.set(r,s)}_prepareMessage(e,r){let t={headers:{request:{id:c.THREAD_ID,context:this.__getName__(),portId:"<required>"}},api:this.api,rpc:this._rpcFuncIdxMap.get(e)};if(Number.isNaN(t.api)||t.rpc===void 0)throw new Error(`IllegalArgument: [${JSON.stringify(t)}]; indeterminate API/RPC target!`);let s=this._rpcIdxFuncMap.get(t.rpc);if(!s.hasNoArgs){if(r===void 0)throw new Error(`IllegalArgument: [${JSON.stringify(t)}] requires argument to be set before post!`);t.args=r}return s.hasReturn&&(t.returnPromise=!0),t}_bindMethods(e=!0){this._rpcIdxFuncMap.clear(),this._rpcFuncIdxMap.clear(),e&&this._bindSystemFuncs()}_bindSystemFuncs(){this.bindRpcFunc(this,this.__teardown__,{hasNoArgs:!0}),this.bindRpcFunc(this,this.__transferPorts__,{hasReturn:!0,hasServerTransferredPorts:!0}),this.bindRpcFunc(this,this.__getTransferredPorts__,{hasReturn:!0}),this.bindRpcFunc(this,this.__deleteTransferredPorts__)}async _handleRpc(e){if(e.data?.api!==this.api||e.data?.rpc===void 0||this._returnRpcResultIfResolved(e))return;this._registerTransferredPorts(e);let r=this._rpcIdxFuncMap.get(e.data.rpc);if(e.rpcInvoked=r,r)await this._invokeRpcMethod(e);else throw new Error(`IllegalArgument: rpc[${e.data.rpc}] not supported on Context[${this.__getName__()}]`)}_returnRpcResultIfResolved(e){let r=!1,t=e.data.promiseHash;if(t){let s=i._promiseHashMap.get(t);if(s)e.data.promiseHash=void 0,i._promiseHashMap.delete(t),s.resolve(e.data),r=!0;else if(e.data.resp)throw new Error(`IllegalState: ${c.THREAD_ID} received misdirected promiseHash[${t}]`)}return r}_registerTransferredPorts(e){for(let r=0;r<e.ports.length;r++)this._orderedTransferredPortMaps.push(e.ports[r]),e.ports[r].onmessage=async t=>{await this._onMessageChannelMessage(t)},e.ports[r].rpcPortId="altWorkerMC"}_unregisterTransferredPort(e){let r=this._orderedTransferredPortMaps.indexOf(e);r>-1&&(e.close(),e.onmessage=null,this._orderedTransferredPortMaps.splice(r,1))}async _invokeRpcMethod(e){let r=e.rpcInvoked,t=e.target||self,s=r.hasClientPromiseAwait?g.defer():void 0,n=[];r.hasNoArgs||n.push(e.data.args),r.hasClientPromiseAwait&&n.push(s),r.hasServerTransferredPorts&&n.push(e.ports),r.hasMessageEvent&&n.push(e),n.push(t);let a;if(r.thisArg?(r.runBound===void 0&&(r.runBound=r.run.bind(r.thisArg)),a=await r.runBound(...n)):a=await r.run(...n),s&&(a=await s),r.hasReturn){let o={...e.data,resp:a};o.headers.response={id:c.THREAD_ID,context:this.__getName__(),portId:t.rpcPortId},t.postMessage(o)}}_postMessage(e,r,t){let s=this._preparePostMessageReturnPromise(r);return t=this._preparePostMessageOptions(t),r.headers.request.portId=e.rpcPortId,e.postMessage(r,t),this._alertMessageDispatched(),s}_preparePostMessageReturnPromise(e){let r=i._resolvedPromise;return e.returnPromise&&(e.promiseHash=crypto.randomUUID(),e.returnPromise=void 0,r=g.defer(),i._promiseHashMap.set(e.promiseHash,r)),r}_preparePostMessageOptions(e){return e}_alertMessageDispatched(){}},m=class{isActive=!1;port;constructor(e){this.port=e}setup(){}teardown(){this.port.close()}setRpcPortId(e){this.port.rpcPortId||(this.port.rpcPortId=e)}preparePostMessageOptions(e){return e}getRecipient(){return this.port}alertMessageDispatched(){}setEventListener(e,r,t){this.port.onmessage=r}};var _=class extends u{_multiWorkerHandler;async __teardown__(){let e=arguments[0];if(e instanceof MessagePort&&this._unregisterTransferredPort(e),c.THREAD_TYPE_IDX===1&&"close"in e){let r=e;r.onmessage=null,r.close()}}async __transferPorts__(e,r){let t=r.length-e.portIds.length,s=0;for(let n=0;n<r.length;n++){let a=r[n];n>=t&&(this._namedTransferredPortMaps.set(e.portIds[n-t],a),a.rpcPortId=e.portIds[n-t]),s++}return{count:s}}async __getTransferredPorts__(){return{portIds:Array.from(this._namedTransferredPortMaps.keys())}}async __deleteTransferredPorts__(e){e.portIds.forEach((r,t,s)=>{let n=this._namedTransferredPortMaps.get(r);this._unregisterTransferredPort(n),this._namedTransferredPortMaps.delete(r)})}startServer(e="message"){console.log(`${c.THREAD_ID}>${this.__getName__()}[v${this.__getVersion__()}] started: waiting for messages...`),this._multiWorkerHandler=async r=>{if(e==="connect"&&!r.data){r.ports[0].onmessage=this._multiWorkerHandler,r.ports[0].rpcPortId="DEFAULT";return}await this._handleRpc(r)},e==="connect"&&"onconnect"in self?(self.onconnect=this._multiWorkerHandler,self.rpcPortId="DEFAULT"):e==="message"&&"onmessage"in self&&(self.onmessage=this._multiWorkerHandler,self.rpcPortId="DEFAULT"),this._bindMethods()}async _onMessageChannelMessage(e){await this._multiWorkerHandler(e)}};var f=class{static forEach(e,r,t){let s="",n=!1,a="";for(let o=0;o<e.length;o++){let l=e.charAt(o),d=r.includes(o);n===d?a+=l:(s+=t(a,n),a=l),n=d}return a&&(s+=t(a,n)),s}},h=class{selections;constructor(e){this.selections=new Set(e)}toggle(e){let r=this.selections.has(e);return r?this.selections.delete(e):this.selections.add(e),!r}toString(){if(this.selections.size===0)return"";let e=Array.from(this.selections).sort((a,o)=>a-o),r=[],t=[e[0]];function s(){t.length===1?r.push(`${t[0]}`):t.length>1&&r.push(`${t[0]}-${t[t.length-1]}`)}for(let a=1;a<e.length;a++)e[a-1]+1===e[a]?t.push(e[a]):(s(),t=[e[a]]);return s(),r.join(",")}toNumbers(){let e=Array.from(this.selections);return e.sort(),this.selections=new Set(e),e}fromString(e){this.selections.clear();let r=e.split(",");for(let t=0;t<r.length;t++)if(r[t]){let s=r[t].split("-"),n=[];for(let a=0;a<s.length;a++)n.push(parseInt(s[a]));if(n.length===1)this.selections.add(n[0]);else for(let a=n[0];a<n[1]+1;a++)this.selections.add(a)}return this}fromNumbers(e){let r=[];return e.forEach((t,s,n)=>{let a=String(t);a=a.replace(",","-"),r.push(a)}),this.fromString(r.toString())}};var p=class i{static DIACRITICS_CHR=["\u0101","\u012B","\u016B","\u1E41","\u1E43","\u1E47","\u1E45","\xF1","\u1E63","\u1E6D","\u1E0D","\u1E37","\u1E25"];static DIACRITICS_ALT=["a","i","u","m","m","n","n","n","s","t","d","l","h"];static allIndexesOf(e,r,t=!0){let s=[],n=r.length-1,a=-1,o=0;for(t&&(e=e.toLowerCase(),r=r.toLowerCase());(a=e.indexOf(r,o))>-1;)s.push([a,a+n]),o=a+1;return s}static allIndexOfUsingRegEx(e,r,t="gm"){let s=new RegExp(r,t),n,a=[];for(;(n=s.exec(e))!==null;)n.index===s.lastIndex&&s.lastIndex++,a.push([n.index,n.index+n[0].length-1]);return a}static allLinePositions(e,r){let t=0,s=0,n=[];for(let a=0;a<r.length;a++){let l=e.substring(t,r[a][0]).match(/\n/gm),d=l?l.length:0;a===0&&d++,d+=s,n.push(d),t=r[a][0]+1,s=d}return n}static surroundingTrim(e,r,t){let s=e.length;if(t>=s)return e;let n=Math.floor(t/2),a=r-n,o=r+n;return a<0&&(a=0,o=t),o>s-1&&(o=s,a=Math.max(0,o-t)),e.substring(a,o).trim()}static removeDiacritics(e){for(let r=0;r<i.DIACRITICS_CHR.length;r++)e=e.replaceAll(i.DIACRITICS_CHR[r],i.DIACRITICS_ALT[r]);return e}static replaceAllSequence(e,r){let t=e;for(let s=0;s<r.length;s++)t=t.replaceAll(r[s][0],r[s][1]);return t}static lineLengths(e,r){let t=e.split(`
`),s=[];r&&(r.length=0,r.push(0));for(let n=0;n<t.length;n++)s.push(t[n].length),r&&r.push(r[n]+s[n]+1);return s}static convertToRegExIfValid(e){let r={patternOrSearchExpr:e,ignoreDiacritics:!0,regExFlags:void 0},t=e.lastIndexOf("/");if(!e.startsWith("/")||t<=0)return r;let s=e.substring(1,t),n=e.substring(t+1);if(!/^[gmisdyvuD]*$/.test(n))return r;n.indexOf("D")>-1&&(r.ignoreDiacritics=!0,n=n.replace("D",""));try{let a=new RegExp(s,n);return r.patternOrSearchExpr=s,r.regExFlags=n,r}catch{return r}}static{[i.DIACRITICS_CHR,i.DIACRITICS_ALT].forEach((r,t,s)=>{r.forEach((n,a,o)=>{o.push(n.toUpperCase())})})}};var R=class extends u{_responder;constructor(e){super(),this._responder=e,this._responder.setRpcPortId("DEFAULT")}async __teardown__(){let e=this._prepareMessage(this.__teardown__);await this._postMessage(this._getRecipient(),e)}async __transferPorts__(e,r){let t=this._prepareMessage(this.__transferPorts__,e);e.portIds.forEach((n,a,o)=>{this._namedTransferredPortMaps.set(n,r[a])});let s=await this._postMessage(this._getRecipient(),t,r);if(r.length!==s.resp.count)throw new Error(`IllegalState: port mismatch; sent ${r.length} ports, transfered ${s.resp.count}`);return s.resp}async __getTransferredPorts__(){let e=this._prepareMessage(this.__getTransferredPorts__);return{portIds:(await this._postMessage(this._getRecipient(),e)).resp.portIds}}async __deleteTransferredPorts__(e){let r=this._prepareMessage(this.__deleteTransferredPorts__,e);await this._postMessage(this._getRecipient(),r),e.portIds.forEach((t,s,n)=>{this._namedTransferredPortMaps.delete(t)})}startClient(){this._responder.setup(),this._responder.setEventListener("message",async e=>{await this._handleRpc(e)}),this._bindMethods(),console.log(`${c.THREAD_ID}>${this.__getName__()} started: waiting for messages...`)}async stopClient(){let e=Array.from(this._namedTransferredPortMaps.keys());await this.__deleteTransferredPorts__({portIds:e}),await this.__teardown__(),this._responder.teardown(),this._responder.setEventListener("message",null),this._bindMethods(!1)}_preparePostMessageOptions(e){return this._responder.preparePostMessageOptions(e)}_getRecipient(){return this._responder.getRecipient()}_alertMessageDispatched(){this._responder.alertMessageDispatched()}async _onMessageChannelMessage(e){await this._handleRpc(e)}};var b=class{static bindRpc(e){let r=e;r.api||(r.api=0),r.bindRpcFunc(r,e.updateTrackCacheInfo,{}),r.bindRpcFunc(r,e.selectAllAlbums,{hasNoArgs:!0,hasReturn:!0}),r.bindRpcFunc(r,e.selectAlbumWhere,{hasReturn:!0}),r.bindRpcFunc(r,e.selectAllTracksForAlbumWhere,{hasReturn:!0}),r.bindRpcFunc(r,e.selectTrackWhere,{hasReturn:!0}),r.bindRpcFunc(r,e.selectTracksWhere,{hasReturn:!0}),r.bindRpcFunc(r,e.selectKeywordsList,{hasNoArgs:!0,hasReturn:!0}),r.bindRpcFunc(r,e.readFileAsText,{hasReturn:!0}),r.bindRpcFunc(r,e.readTrackAsMarkdown,{hasReturn:!0})}};var k=class extends R{__getName__(){return"AlbumStoreWorkerClient"}_bindMethods(){super._bindMethods(),b.bindRpc(this)}async updateTrackCacheInfo(e){let r=this._prepareMessage(this.updateTrackCacheInfo,e),t=await this._postMessage(this._getRecipient(),r)}async selectAllAlbums(){let e=this._prepareMessage(this.selectAllAlbums);return(await this._postMessage(this._getRecipient(),e)).resp}async selectAlbumWhere(e){let r=this._prepareMessage(this.selectAlbumWhere,e);return(await this._postMessage(this._getRecipient(),r)).resp}async selectAllTracksForAlbumWhere(e){let r=this._prepareMessage(this.selectAllTracksForAlbumWhere,e);return(await this._postMessage(this._getRecipient(),r)).resp}async selectTrackWhere(e){let r=this._prepareMessage(this.selectTrackWhere,e);return(await this._postMessage(this._getRecipient(),r)).resp}async selectTracksWhere(e){let r=this._prepareMessage(this.selectTracksWhere,e);return(await this._postMessage(this._getRecipient(),r)).resp}async selectKeywordsList(){let e=this._prepareMessage(this.selectKeywordsList);return(await this._postMessage(this._getRecipient(),e)).resp}async readFileAsText(e){let r=this._prepareMessage(this.readFileAsText,e);return(await this._postMessage(this._getRecipient(),r)).resp}async readTrackAsMarkdown(e){let r=this._prepareMessage(this.readTrackAsMarkdown,e);return(await this._postMessage(this._getRecipient(),r)).resp}};var M=class{static bindRpc(e){let r=e;r.api||(r.api=3),r.bindRpcFunc(r,e.setup),r.bindRpcFunc(r,e.teardown,{hasNoArgs:!0}),r.bindRpcFunc(r,e.search,{hasReturn:!0}),r.bindRpcFunc(r,e.onSearch),r.bindRpcFunc(r,e.onMatch)}};var P=class i extends _{static VERSION="2.0.0";albumStoreClient;__getVersion__(){return i.VERSION}__getName__(){return"SearchTextWorkerServer"}onSearch=async e=>{let r=this._prepareMessage(this.onSearch,e);await this._postMessage(self,r,void 0)};onMatch=async e=>{let r=this._prepareMessage(this.onMatch,e);await this._postMessage(self,r,void 0)};async setup(e){let r=this._namedTransferredPortMaps.get(e.albumStorePortId),t=new m(r);this.albumStoreClient=new k(t),this.albumStoreClient.startClient()}async teardown(){await this.albumStoreClient.stopClient()}async search(e){await this.onSearch({trackRef:e.trackRef});let t=await new T(this,e.trackRef,e.criteria,e.maxTeaserSize).search();return t&&await this.onMatch(t),t}_bindMethods(){super._bindMethods(),M.bindRpc(this)}},T=class{server;trackRef;criteria;maxTeaserSize;multiPartSearchFor=[];track;srcContent;constructor(e,r,t,s){this.server=e,this.trackRef=r,this.criteria=t,this.maxTeaserSize=s??150}async search(){await this._fetchTextContent(),this._prepareMultiPartSearchForCritera(),this._prepareContent();let e=this._getMarkupIndicies();if(e.length===0)return;let r=await this.server.albumStoreClient.selectTrackWhere({trackRef:this.trackRef});this.track=r.track;let t=p.allLinePositions(this.srcContent,e),s=this._prepareMatchReferences(e,t);return{track:this.track,matches:s}}_prepareMatchReferences(e,r){let t=[],s=p.lineLengths(this.srcContent,t),n={highlightLineRanges:new h(r).toString(),markTextRanges:new h().fromNumbers(e).toString()},a=[];for(let o=0;o<e.length;o++){let l=this._updateCursorLinePosition(e[o],r[o],t,{...n}),d={displayTeaser:this._prepareMatchedTeaserRef(e[o],r[o]),bookmark:l};a.push(d)}return a}_prepareMatchedTeaserRef(e,r){let t=new h().fromNumbers([e]).toNumbers(),s=f.forEach(this.srcContent,t,(a,o)=>o?`<mark>${a}</mark>`:a);return{lineNumber:r,teaser:p.surroundingTrim(s,Math.max(e[0]-6,0),this.maxTeaserSize)}}_updateCursorLinePosition(e,r,t,s){let n=e[0]-t[r-1],a=t[r]-t[r-1],o=Math.round(100*n/a)/100;return s.cursorLinePosition=r+o,s}_getMarkupIndicies(){let e=[];for(let r=0;r<this.multiPartSearchFor.length;r++){let s=(this.criteria.useRegEx?this._searchWithRegEx:this._searchWithoutRegEx).bind(this)(this.multiPartSearchFor[r]);if(s.length===0){e.length=0;break}e.splice(0,0,...s)}return e.sort((r,t)=>r[0]-t[0]),e}_prepareContent(){this.criteria.ignoreDiacritics&&(this.srcContent=p.removeDiacritics(this.srcContent))}_prepareMultiPartSearchForCritera(){if(this.criteria.ignoreDiacritics&&(this.criteria.searchFor=p.removeDiacritics(this.criteria.searchFor)),this.criteria.applyAndBetweenTerms&&this.criteria.andDelimiter.length>0){this.multiPartSearchFor=this.criteria.searchFor.split(this.criteria.andDelimiter);for(let e=this.multiPartSearchFor.length-1;e>=0;e--)this.multiPartSearchFor[e]=this.multiPartSearchFor[e].trim(),this.multiPartSearchFor[e].length===0&&this.multiPartSearchFor.splice(e,1)}else this.multiPartSearchFor=[this.criteria.searchFor]}async _fetchTextContent(){let{text:e}=await this.server.albumStoreClient.readTrackAsMarkdown({trackRef:this.trackRef,markupHeaders:!0});this.srcContent=e}_searchWithRegEx(e){return p.allIndexOfUsingRegEx(this.srcContent,e,this.criteria.regExFlags)}_searchWithoutRegEx(e){return p.allIndexesOf(this.srcContent,e,!0)}},w=new P;w.startServer();})();
