"use strict";(()=>{var Ri=Object.create;var Gt=Object.defineProperty;var Ai=Object.getOwnPropertyDescriptor;var Ei=Object.getOwnPropertyNames;var _i=Object.getPrototypeOf,Mi=Object.prototype.hasOwnProperty;var Ci=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var Ii=(r,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Ei(e))!Mi.call(r,s)&&s!==t&&Gt(r,s,{get:()=>e[s],enumerable:!(i=Ai(e,s))||i.enumerable});return r};var xi=(r,e,t)=>(t=r!=null?Ri(_i(r)):{},Ii(e||!r||!r.__esModule?Gt(t,"default",{value:r,enumerable:!0}):t,r));var Ti=Ci((lo,yt)=>{"use strict";var es=typeof window<"u"?window:typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope?self:{},ki=function(r){var e=/(?:^|\s)lang(?:uage)?-([\w-]+)(?=\s|$)/i,t=0,i={},s={manual:r.Prism&&r.Prism.manual,disableWorkerMessageHandler:r.Prism&&r.Prism.disableWorkerMessageHandler,util:{encode:function d(h){return h instanceof n?new n(h.type,d(h.content),h.alias):Array.isArray(h)?h.map(d):h.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/\u00a0/g," ")},type:function(d){return Object.prototype.toString.call(d).slice(8,-1)},objId:function(d){return d.__id||Object.defineProperty(d,"__id",{value:++t}),d.__id},clone:function d(h,g){var u,p;switch(g=g||{},s.util.type(h)){case"Object":if(p=s.util.objId(h),g[p])return g[p];for(var P in u={},g[p]=u,h)h.hasOwnProperty(P)&&(u[P]=d(h[P],g));return u;case"Array":return p=s.util.objId(h),g[p]?g[p]:(u=[],g[p]=u,h.forEach(function(y,w){u[w]=d(y,g)}),u);default:return h}},getLanguage:function(d){for(;d;){var h=e.exec(d.className);if(h)return h[1].toLowerCase();d=d.parentElement}return"none"},setLanguage:function(d,h){d.className=d.className.replace(RegExp(e,"gi"),""),d.classList.add("language-"+h)},currentScript:function(){if(typeof document>"u")return null;if("currentScript"in document)return document.currentScript;try{throw new Error}catch(u){var d=(/at [^(\r\n]*\((.*):[^:]+:[^:]+\)$/i.exec(u.stack)||[])[1];if(d){var h=document.getElementsByTagName("script");for(var g in h)if(h[g].src==d)return h[g]}return null}},isActive:function(d,h,g){for(var u="no-"+h;d;){var p=d.classList;if(p.contains(h))return!0;if(p.contains(u))return!1;d=d.parentElement}return!!g}},languages:{plain:i,plaintext:i,text:i,txt:i,extend:function(d,h){var g=s.util.clone(s.languages[d]);for(var u in h)g[u]=h[u];return g},insertBefore:function(d,h,g,u){var p=(u=u||s.languages)[d],P={};for(var y in p)if(p.hasOwnProperty(y)){if(y==h)for(var w in g)g.hasOwnProperty(w)&&(P[w]=g[w]);g.hasOwnProperty(y)||(P[y]=p[y])}var M=u[d];return u[d]=P,s.languages.DFS(s.languages,function(b,j){j===M&&b!=d&&(this[b]=P)}),P},DFS:function d(h,g,u,p){p=p||{};var P=s.util.objId;for(var y in h)if(h.hasOwnProperty(y)){g.call(h,y,h[y],u||y);var w=h[y],M=s.util.type(w);M!=="Object"||p[P(w)]?M!=="Array"||p[P(w)]||(p[P(w)]=!0,d(w,g,y,p)):(p[P(w)]=!0,d(w,g,null,p))}}},plugins:{},highlightAll:function(d,h){s.highlightAllUnder(document,d,h)},highlightAllUnder:function(d,h,g){var u={callback:g,container:d,selector:'code[class*="language-"], [class*="language-"] code, code[class*="lang-"], [class*="lang-"] code'};s.hooks.run("before-highlightall",u),u.elements=Array.prototype.slice.apply(u.container.querySelectorAll(u.selector)),s.hooks.run("before-all-elements-highlight",u);for(var p,P=0;p=u.elements[P++];)s.highlightElement(p,h===!0,u.callback)},highlightElement:function(d,h,g){var u=s.util.getLanguage(d),p=s.languages[u];s.util.setLanguage(d,u);var P=d.parentElement;P&&P.nodeName.toLowerCase()==="pre"&&s.util.setLanguage(P,u);var y={element:d,language:u,grammar:p,code:d.textContent};function w(b){y.highlightedCode=b,s.hooks.run("before-insert",y),y.element.innerHTML=y.highlightedCode,s.hooks.run("after-highlight",y),s.hooks.run("complete",y),g&&g.call(y.element)}if(s.hooks.run("before-sanity-check",y),(P=y.element.parentElement)&&P.nodeName.toLowerCase()==="pre"&&!P.hasAttribute("tabindex")&&P.setAttribute("tabindex","0"),!y.code)return s.hooks.run("complete",y),void(g&&g.call(y.element));if(s.hooks.run("before-highlight",y),y.grammar)if(h&&r.Worker){var M=new Worker(s.filename);M.onmessage=function(b){w(b.data)},M.postMessage(JSON.stringify({language:y.language,code:y.code,immediateClose:!0}))}else w(s.highlight(y.code,y.grammar,y.language));else w(s.util.encode(y.code))},highlight:function(d,h,g){var u={code:d,grammar:h,language:g};if(s.hooks.run("before-tokenize",u),!u.grammar)throw new Error('The language "'+u.language+'" has no grammar.');return u.tokens=s.tokenize(u.code,u.grammar),s.hooks.run("after-tokenize",u),n.stringify(s.util.encode(u.tokens),u.language)},tokenize:function(d,h){var g=h.rest;if(g){for(var u in g)h[u]=g[u];delete h.rest}var p=new l;return c(p,p.head,d),a(d,p,h,p.head,0),function(P){for(var y=[],w=P.head.next;w!==P.tail;)y.push(w.value),w=w.next;return y}(p)},hooks:{all:{},add:function(d,h){var g=s.hooks.all;g[d]=g[d]||[],g[d].push(h)},run:function(d,h){var g=s.hooks.all[d];if(g&&g.length)for(var u,p=0;u=g[p++];)u(h)}},Token:n};function n(d,h,g,u){this.type=d,this.content=h,this.alias=g,this.length=0|(u||"").length}function o(d,h,g,u){d.lastIndex=h;var p=d.exec(g);if(p&&u&&p[1]){var P=p[1].length;p.index+=P,p[0]=p[0].slice(P)}return p}function a(d,h,g,u,p,P){for(var y in g)if(g.hasOwnProperty(y)&&g[y]){var w=g[y];w=Array.isArray(w)?w:[w];for(var M=0;M<w.length;++M){if(P&&P.cause==y+","+M)return;var b=w[M],j=b.inside,we=!!b.lookbehind,ke=!!b.greedy,Fe=b.alias;if(ke&&!b.pattern.global){var K=b.pattern.toString().match(/[imsuy]*$/)[0];b.pattern=RegExp(b.pattern.source,K+"g")}for(var Te=b.pattern||b,R=u.next,x=p;R!==h.tail&&!(P&&x>=P.reach);x+=R.value.length,R=R.next){var O=R.value;if(h.length>d.length)return;if(!(O instanceof n)){var $,de=1;if(ke){if(!($=o(Te,x,d,we))||$.index>=d.length)break;var Oe=$.index,bi=$.index+$[0].length,oe=x;for(oe+=R.value.length;Oe>=oe;)oe+=(R=R.next).value.length;if(x=oe-=R.value.length,R.value instanceof n)continue;for(var be=R;be!==h.tail&&(oe<bi||typeof be.value=="string");be=be.next)de++,oe+=be.value.length;de--,O=d.slice(x,oe),$.index-=x}else if(!($=o(Te,0,O,we)))continue;Oe=$.index;var Ne=$[0],_t=O.slice(0,Oe),Xt=O.slice(Oe+Ne.length),Mt=x+O.length;P&&Mt>P.reach&&(P.reach=Mt);var We=R.prev;if(_t&&(We=c(h,We,_t),x+=_t.length),m(h,We,de),R=c(h,We,new n(y,j?s.tokenize(Ne,j):Ne,Fe,Ne)),Xt&&c(h,R,Xt),de>1){var Ct={cause:y+","+M,reach:Mt};a(d,h,g,R.prev,x,Ct),P&&Ct.reach>P.reach&&(P.reach=Ct.reach)}}}}}}function l(){var d={value:null,prev:null,next:null},h={value:null,prev:d,next:null};d.next=h,this.head=d,this.tail=h,this.length=0}function c(d,h,g){var u=h.next,p={value:g,prev:h,next:u};return h.next=p,u.prev=p,d.length++,p}function m(d,h,g){for(var u=h.next,p=0;p<g&&u!==d.tail;p++)u=u.next;h.next=u,u.prev=h,d.length-=p}if(r.Prism=s,n.stringify=function d(h,g){if(typeof h=="string")return h;if(Array.isArray(h)){var u="";return h.forEach(function(M){u+=d(M,g)}),u}var p={type:h.type,content:d(h.content,g),tag:"span",classes:["token",h.type],attributes:{},language:g},P=h.alias;P&&(Array.isArray(P)?Array.prototype.push.apply(p.classes,P):p.classes.push(P)),s.hooks.run("wrap",p);var y="";for(var w in p.attributes)y+=" "+w+'="'+(p.attributes[w]||"").replace(/"/g,"&quot;")+'"';return"<"+p.tag+' class="'+p.classes.join(" ")+'"'+y+">"+p.content+"</"+p.tag+">"},!r.document)return r.addEventListener&&(s.disableWorkerMessageHandler||r.addEventListener("message",function(d){var h=JSON.parse(d.data),g=h.language,u=h.code,p=h.immediateClose;r.postMessage(s.highlight(u,s.languages[g],g)),p&&r.close()},!1)),s;var f=s.util.currentScript();function S(){s.manual||s.highlightAll()}if(f&&(s.filename=f.src,f.hasAttribute("data-manual")&&(s.manual=!0)),!s.manual){var v=document.readyState;v==="loading"||v==="interactive"&&f&&f.defer?document.addEventListener("DOMContentLoaded",S):window.requestAnimationFrame?window.requestAnimationFrame(S):window.setTimeout(S,16)}return s}(es);typeof yt<"u"&&yt.exports&&(yt.exports=ki),typeof global<"u"&&(global.Prism=ki)});var It=class{appRoot;useHash;pathname;ctxHash;searchParams;originalHref;originalHash;cargo={};constructor(e,t,i,s){this.appRoot=e,this.useHash=t;let n;if(this.originalHref=i,this.originalHash=s,this.useHash){n=new URL(i.replace("#",""));let o=s.indexOf("?");o>-1?this.ctxHash=s.substring(0,o):this.ctxHash=s}else n=new URL(i),this.ctxHash=this.originalHash;this.pathname=n.pathname.substring(this.appRoot.length),this.pathname===""&&(this.pathname="/"),this.searchParams=n.searchParams}prepareHumanReadableLink(e){let t=this.searchParams.toString();t=t?"?"+t:"",t&&(t=t.replaceAll("%2C",","));let i=this.ctxHash+t;if(!e){let s=location.href.indexOf("#");i=(s===-1?location.href:location.href.substring(0,s))+i}return i}},A=class r{static currentUrlRoute;appRoot;useHash;cssSelector;handlers=new Array;prevRouteHandler;prevAnchorClickHref;activeRouteHandler;onroutechange;onrouteerror;constructor(e,t,i="a.spa-nav"){this.appRoot=e,this.useHash=t,this.cssSelector=i}addRouteHandler(e,t=-1){t===-1?this.handlers.push(e):this.handlers.splice(t,0,e)}async start(){document.addEventListener("click",e=>{let t=e.target;!t.matches(this.cssSelector)&&(!t.parentElement||(t=t.parentElement,!t.matches(this.cssSelector)))||(this.prevAnchorClickHref=t.href,window.history.pushState({},"",this.prevAnchorClickHref),this.activeRouteHandler.setScrollPosition(window.scrollX,window.scrollY),e.preventDefault(),this._onHashChange(2))}),window.addEventListener("popstate",e=>{this.activeRouteHandler&&this.activeRouteHandler.setScrollPosition(window.scrollX,window.scrollY)}),window.addEventListener("hashchange",async e=>{window.location.href!==this.prevAnchorClickHref&&await this._onHashChange(1),this.prevAnchorClickHref=null}),await this._onHashChange(0)}getCurrentUrlRoute(){return new It(this.appRoot,this.useHash,window.location.href,window.location.hash)}async _onHashChange(e){if(r.currentUrlRoute=this.getCurrentUrlRoute(),await this._routeRequest(r.currentUrlRoute))this.onroutechange&&(await this.onroutechange(this.prevRouteHandler,this.activeRouteHandler,r.currentUrlRoute,e),this.prevRouteHandler=this.activeRouteHandler);else{let i=`No router|default router registered for: ${window.location.href}`;this.onrouteerror&&await this.onrouteerror(window.location.href,i)}}async _routeRequest(e){let t=!1;for(let i=0;i<this.handlers.length;i++)if(await this.handlers[i].canHandle(e)){this.activeRouteHandler=this.handlers[i];try{await this.handlers[i].handle(e),t=!0;break}catch(n){console.error(n)}}return t}static async loadTemplate(e){let t=await fetch(e),i;return t.ok&&(i=await t.text()),[i,t]}};var ue=class{elementEventMap=new Map;register(e,t,i){let s=this.elementEventMap.get(e);s||(s=new Map,this.elementEventMap.set(e,s));let n=s.get(t);n||(n=[],s.set(t,n)),n.push(i),e.addEventListener(t,i)}dispose(e){let t=this.elementEventMap.get(e);if(t){let i=Array.from(t.keys());for(let s=0;s<i.length;s++){let n=t.get(i[s]);if(n){for(let o=0;o<n.length;o++)e.removeEventListener(i[s],n[o]);n=[]}t.delete(i[s])}this.elementEventMap.delete(e)}}disposeAll(){this.elementEventMap.forEach((e,t,i)=>{e.forEach((s,n,o)=>{s.forEach((a,l)=>{t.removeEventListener(n,a)}),s.length=0}),e.clear()}),this.elementEventMap.clear()}};var C=class{static SELECTED_CSS="border-l-4 border-blue-600";eventRegistry=new ue;isViewLoaded=!1;$PageSection;pageSectionId;$menuItem;menuItemId;hashLocation;templateFile;scrollYPos;visitations=0;app;shell;constructor(e,t,i,s,n,o){this.app=e,this.shell=t,this.pageSectionId=i,this.$PageSection=document.getElementById(this.pageSectionId),this.menuItemId=s,this.menuItemId&&(this.$menuItem=document.getElementById(this.menuItemId)),this.hashLocation=n,this.templateFile=o,e.router.addRouteHandler(this),e.pagesControllers.push(this)}async asyncConstructor(){}async canHandle(e){return this.hashLocation===e.pathname}async handle(e){this.isViewLoaded||(await this.setup(),this.visitations=0)}setScrollPosition(e,t){this.scrollYPos=t}onTrackListIndexChange(e,t,i){}async setup(){let[e,t]=await A.loadTemplate(this.templateFile),i=document.createElement("div");i.innerHTML=e;let s=this.$PageSection.parentElement;this.$PageSection.remove(),s&&s.appendChild(i.children[0]),this.$PageSection=document.getElementById(this.pageSectionId),this.isViewLoaded=!0}async tearDown(){this.isViewLoaded=!1,this.eventRegistry.disposeAll()}async onEnter(e){this.visitations++,this.$PageSection.classList.remove("hidden"),this.shell.view.selectMenuItem(this.$menuItem),this.shell.view.toggleSideMenuIfReqd(),await this._onShow(e)}async _onShow(e){this.moveToScrollPosition(e)}moveToScrollPosition(e){window.scroll({left:0,top:this.scrollYPos,behavior:"smooth"})}async onExit(){this.$PageSection.classList.add("hidden")}isVisible(){return!this.$PageSection.classList.contains("hidden")}getTrackSelections(){return[]}async onAfterOfflineProcessing(e){}setLocationHash(e,t){t&&this.$menuItem&&(this.$menuItem.hash=e),location.hash=e}};var xt=["cursorLinePosition","highlightLineRanges","markTextRanges","startAudio","stopAudio"];var B=class r{static THREAD_TYPES=["Window","DedicatedWorkerGlobalScope","ServiceWorkerGlobalScope","SharedWorkerGlobalScope"];static THREAD_TYPE=self.constructor.name;static THREAD_TYPE_IDX=r.THREAD_TYPES.indexOf(r.THREAD_TYPE);static THREAD_ID;static IS_MOBILE_PLATFORM;static _debounceTimer;static deepClone(e){if(e===null||typeof e!="object")return e;if(Array.isArray(e))return e.map(i=>r.deepClone(i));let t={};for(let i in e)e.hasOwnProperty(i)&&(t[i]=r.deepClone(e[i]));return t}static debounce(e,t){clearTimeout(r._debounceTimer),r._debounceTimer=setTimeout(e,t)}static _setIsMobilePlatform(){if(r.IS_MOBILE_PLATFORM!==void 0)return;let e=navigator.userAgent.match(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i),t="ontouchstart"in(r.THREAD_TYPE_IDX===0?window:self),i="accelerometer"in(r.THREAD_TYPE_IDX===0?window:self);r.IS_MOBILE_PLATFORM=!!(e||t||i),console.log(`Thread#[${r.THREAD_TYPE_IDX}].IS_MOBILE=${r.IS_MOBILE_PLATFORM}`)}static _setThreadId(){if(r.THREAD_TYPE_IDX===0)r.THREAD_ID=r.THREAD_TYPE;else if(r.THREAD_TYPE_IDX===2){let e="/indeterminant-scriptURL";"serviceWorker"in self&&"scriptURL"in self.serviceWorker&&(e=self.serviceWorker.scriptURL),r.THREAD_ID=`sw${e.substring(e.lastIndexOf("/"))}`}else if(r.THREAD_ID=self.name,!r.THREAD_ID)throw new Error("IllegalState: All web workers & shared workers must be named via the constructor!")}static{r._setThreadId(),r._setIsMobilePlatform()}};var Y=class{async read(e,t){let i=localStorage.getItem(e);return i===null&&(i=t),i}async write(e,t){localStorage.setItem(e,t)}async commit(){}async clear(e){localStorage.removeItem(e)}},Ue=class{data;async write(e,t){this.data=t}async clear(e){this.data=""}},ae=class r extends Ue{async read(e,t){if(!r.isReadAvailable())throw new Error("IllegalState: Platform does not support reading from clipboard");return this.data=await r.readText(),this.data}async commit(){await r.writeText(this.data),await this.clear(null)}static isReadAvailable(){return"readText"in navigator.clipboard}static async readText(){return await navigator.clipboard.readText()}static async writeText(e){await navigator.clipboard.writeText(e)}},Ve=class extends Ue{$inputFile;baseFilename;fileExtension;mimeType;onContentLoaded;constructor(e,t="suttaplayer-file",i="application/json",s="json"){super(),this.$inputFile=document.getElementById(e),this.baseFilename=t,this.fileExtension=s,this.mimeType=i,this._registerListener()}async commit(){let e=new Blob([this.data],{type:this.mimeType}),t=URL.createObjectURL(e),i=document.createElement("a");i.href=t;let s=new Date().toLocaleString().replaceAll(" ","_");i.download=`${this.baseFilename}-${s}.${this.fileExtension}`,i.click(),await this.clear(null)}async read(e,t){if(this.data===void 0)throw new Error("IllegalState: No file has been uploaded");return this.data}_registerListener(){this.$inputFile.addEventListener("change",async e=>{let t=this.$inputFile.files[0];this.data=await t.text(),this.onContentLoaded&&this.onContentLoaded(this.data?this.data.length:0)})}},U=class r{delegate;replaceAllIds;constructor(e,t=!1){this.delegate=e,this.replaceAllIds=t}async commit(){await this.delegate.commit()}async read(e,t){let i=t,s=await this.delegate.read(e,t);return s&&this.replaceAllIds&&(s=r.replaceIds(s)),s!==t&&(i=JSON.parse(s)),i}async write(e,t){if(t===void 0)return;let i=JSON.stringify(t);await this.delegate.write(e,i)}async clear(e){await this.delegate.clear(e)}static replaceIds(e){let t=/"id":\s*"([\w\d]{8}-[\w\d]{4}-[\w\d]{4}-[\w\d]{4}-[\w\d]{12})"/gm,i,s=e;for(;(i=t.exec(e))!==null;)i.index===t.lastIndex&&t.lastIndex++,i.forEach((n,o,a)=>{if(o===1){let l=Re.new();s=s.replaceAll(n,l)}});return s}},le=class extends U{data;async read(e,t){let i=t;if(this.data)return this.data[e]?this.data[e]:t;this.data=await super.read("multi-part-container",t);let s=this.data[e];return s||(s=this._getMiscSingletonEntry()),s}_getMiscSingletonEntry(){let e=[];for(let t in this.data)e.push(t);return e.length===1?this.data[e[0]]:null}async write(e,t){t!==void 0&&(this.data||(this.data={}),this.data[e]=B.deepClone(t))}async commit(){await super.write("multi-part-container",this.data),await super.commit()}},Re=class{static new(){return crypto.randomUUID()}};var T=class r{static VER="x.y.z";static VER_TUPLE=[-1,-1,-1];version=r.VER;id=Re.new();type=this.constructor.name;transients=["transients"];constructor(e){e&&(this.id=e)}key(){return this.type}async save(e){this.version=r.VER;let[t,i]=this._saveToSavePoint(),s=this.key();await e.write(s,this),this._restoreFromSavePoint(t,i)}async restore(e){let t=this.key(),i=await e.read(t,this);await this.migrateBeforeAssignment(e,i),Object.assign(this,i)}async migrateBeforeAssignment(e,t){}async remove(e){let t=this.key();await e.clear(t)}_saveToSavePoint(){let e=this,t=this.transients,i=[];for(let s=0;s<t.length;s++){let n=t[s];i.push(e[n]),delete e[n]}return[t,i]}_restoreFromSavePoint(e,t){let i=this;for(let s=0;s<e.length;s++){let n=e[s];i[n]=t[s]}}static toVersionTuple(e){let t=[-1,-1,-1];return e.split(".").forEach((i,s,n)=>{t[s]=parseInt(i)}),t}static toVersionInt(e){return parseInt(e.replaceAll(".",""))}};var H=class{trackRef="";cursorLinePosition;highlightLineRanges;markTextRanges;startAudio;stopAudio;notes;assignFrom(e){return this.trackRef=e.trackRef,this.cursorLinePosition=e.cursorLinePosition,this.highlightLineRanges=e.highlightLineRanges,this.markTextRanges=e.markTextRanges,this.startAudio=e.startAudio,this.stopAudio=e.stopAudio,this.notes=e.notes,this}assignTo(e){return e||(e={}),e.trackRef=this.trackRef,e.cursorLinePosition=this.cursorLinePosition,e.highlightLineRanges=this.highlightLineRanges,e.markTextRanges=this.markTextRanges,e.startAudio=this.startAudio,e.stopAudio=this.stopAudio,e.notes=this.notes,e}toString(e){let t="",i=[...xt],s=[this.cursorLinePosition,this.highlightLineRanges,this.markTextRanges,this.startAudio,this.stopAudio];e===!1&&this.trackRef&&(i.splice(0,0,"trackRef"),s.splice(0,0,this.trackRef));for(let n=0;n<s.length;n++)t=this._formatAsHtml(i[n],s[n],t);return t}_formatAsHtml(e,t,i){return t!==void 0&&(t=t.length>10?t.substring(0,7)+"...":t,i+=`${i?",&nbsp;":""}<i>${e}</i>: ${t}`),i}static toHref(e){let t=new URLSearchParams;xt.forEach((n,o,a)=>{e[n]!==void 0&&t.set(n,e[n])});let i=`#${e.trackRef}`,s=t.toString().replaceAll("%2C",",");return s&&(i+=`?${s}`),i}},D=class r extends T{static KEY_PREFIX="pl.";static DEFAULT_NEW_NAME="New playlist";type="PlaylistModel";_selectedItemIndex=-2;stereoType="P";name=r.DEFAULT_NEW_NAME;selectedPlaylistItem;items=[];transients=["transients","selectedPlaylistItem"];constructor(e,t,i){super(e),t&&(this.stereoType=t),i&&(this.name=i)}isNew(){return this._selectedItemIndex===-2}key(){return r.KEY_PREFIX+this.id}async save(e){this._selectedItemIndex===-2&&this.items.length===0?this._selectedItemIndex=-1:this._selectedItemIndex=this.items.indexOf(this.selectedPlaylistItem),this.name||(this.name=this.id),await super.save(e)}async restore(e){await super.restore(e);for(let t=0;t<this.items.length;t++){let i=new H;i.assignFrom(this.items[t]),this.items[t]=i}this._selectedItemIndex>=0&&(this.selectedPlaylistItem=this.items[this._selectedItemIndex])}setSelectionItem(e){this._selectedItemIndex=e,this.selectedPlaylistItem=this._selectedItemIndex<=-1?null:this.items[this._selectedItemIndex]}getSelectionItem(){return this._selectedItemIndex}reset(){this._selectedItemIndex=-2}load(e,t){this.reset(),this.items=e,t>=0&&this.setSelectionItem(t)}},ge=class extends T{type="PlayListsModel";_selectedListIndex=-1;listIds=[];idNamesMap={};tracks=[];newPlaylist=new D;selectedPlaylist=this.newPlaylist;transients=["transients","selectedPlaylist","tracks","newPlaylist"];async save(e){let t=this._selectedListIndex>-1?this.listIds[this._selectedListIndex]:void 0;this._sort(),this.selectedPlaylist?.isNew()||(this.idNamesMap[this.selectedPlaylist.id]=this.selectedPlaylist.name),t!==void 0&&(this._selectedListIndex=this.listIds.indexOf(t)),await super.save(e)}async migrateBeforeAssignment(e,t){let i=T.toVersionInt(t.version),s=T.toVersionInt(T.VER);if(i<s&&t._listIds){t.listIds=t._listIds,delete t._listIds,delete t.useTransfer;for(let n=0;n<t.listIds.length;n++){let o=t.listIds[n],a=new D(o);await a.restore(e),t.idNamesMap||(t.idNamesMap={}),t.idNamesMap[o]=a.name}}}async loadList(e,t){if(t===this.newPlaylist.id)return this.newPlaylist;let i=await this._fromIdToObject(e,t);return this.idNamesMap[i.id]=i.name,i}getSelectedId(){return this._selectedListIndex>-1?this.listIds[this._selectedListIndex]:this.newPlaylist.id}setSelectedIndex(e){let t;return this._selectedListIndex=e,this._selectedListIndex===-1?(this.selectedPlaylist=this.newPlaylist,t=this.selectedPlaylist.id):t=this.listIds[e],t}getSelectedIndex(){return this._selectedListIndex}addNewPlaylist(){this.addPlaylist(this.newPlaylist),this.newPlaylist=new D}addPlaylist(e){this.listIds.push(e.id),this.idNamesMap[e.id]=e.name}async removePlaylist(e,t){if(t===-1)return;t===this._selectedListIndex&&this.setSelectedIndex(-1);let s=new D(this.listIds[t]);return await s.remove(e),this.listIds.splice(t,1),delete this.idNamesMap[s.id],await this.save(e),t>-1}_sort(){this.listIds.sort((e,t)=>{let i=this.idNamesMap[e],s=this.idNamesMap[t];return i.localeCompare(s)})}async _fromIdToObject(e,t){let i=new D(t);return await i.restore(e),i}};var Ae=class{static defer(){let e,t,i=new Promise((n,o)=>{e=n,t=o}),s=i;return s.resolve=e,s.reject=t,i}};var qe=class r{static _resolvedPromise=Promise.resolve(void 0);static _promiseHashMap=new Map;api=NaN;_rpcIdxFuncMap=new Map;_rpcFuncIdxMap=new Map;_orderedTransferredPortMaps=[];_namedTransferredPortMaps=new Map;bindRpcFunc(e,t,i){let s=this._rpcIdxFuncMap.size;this._rpcIdxFuncMap.set(s,{thisArg:e,run:t,...i}),this._rpcFuncIdxMap.set(t,s)}_prepareMessage(e,t){let i={headers:{request:{id:B.THREAD_ID,context:this.__getName__(),portId:"<required>"}},api:this.api,rpc:this._rpcFuncIdxMap.get(e)};if(Number.isNaN(i.api)||i.rpc===void 0)throw new Error(`IllegalArgument: [${JSON.stringify(i)}]; indeterminate API/RPC target!`);let s=this._rpcIdxFuncMap.get(i.rpc);if(!s.hasNoArgs){if(t===void 0)throw new Error(`IllegalArgument: [${JSON.stringify(i)}] requires argument to be set before post!`);i.args=t}return s.hasReturn&&(i.returnPromise=!0),i}_bindMethods(e=!0){this._rpcIdxFuncMap.clear(),this._rpcFuncIdxMap.clear(),e&&this._bindSystemFuncs()}_bindSystemFuncs(){this.bindRpcFunc(this,this.__teardown__,{hasNoArgs:!0}),this.bindRpcFunc(this,this.__transferPorts__,{hasReturn:!0,hasServerTransferredPorts:!0}),this.bindRpcFunc(this,this.__getTransferredPorts__,{hasReturn:!0}),this.bindRpcFunc(this,this.__deleteTransferredPorts__)}async _handleRpc(e){if(e.data?.api!==this.api||e.data?.rpc===void 0||this._returnRpcResultIfResolved(e))return;this._registerTransferredPorts(e);let t=this._rpcIdxFuncMap.get(e.data.rpc);if(e.rpcInvoked=t,t)await this._invokeRpcMethod(e);else throw new Error(`IllegalArgument: rpc[${e.data.rpc}] not supported on Context[${this.__getName__()}]`)}_returnRpcResultIfResolved(e){let t=!1,i=e.data.promiseHash;if(i){let s=r._promiseHashMap.get(i);if(s)e.data.promiseHash=void 0,r._promiseHashMap.delete(i),s.resolve(e.data),t=!0;else if(e.data.resp)throw new Error(`IllegalState: ${B.THREAD_ID} received misdirected promiseHash[${i}]`)}return t}_registerTransferredPorts(e){for(let t=0;t<e.ports.length;t++)this._orderedTransferredPortMaps.push(e.ports[t]),e.ports[t].onmessage=async i=>{await this._onMessageChannelMessage(i)},e.ports[t].rpcPortId="altWorkerMC"}_unregisterTransferredPort(e){let t=this._orderedTransferredPortMaps.indexOf(e);t>-1&&(e.close(),e.onmessage=null,this._orderedTransferredPortMaps.splice(t,1))}async _invokeRpcMethod(e){let t=e.rpcInvoked,i=e.target||self,s=t.hasClientPromiseAwait?Ae.defer():void 0,n=[];t.hasNoArgs||n.push(e.data.args),t.hasClientPromiseAwait&&n.push(s),t.hasServerTransferredPorts&&n.push(e.ports),t.hasMessageEvent&&n.push(e),n.push(i);let o;if(t.thisArg?(t.runBound===void 0&&(t.runBound=t.run.bind(t.thisArg)),o=await t.runBound(...n)):o=await t.run(...n),s&&(o=await s),t.hasReturn){let a={...e.data,resp:o};a.headers.response={id:B.THREAD_ID,context:this.__getName__(),portId:i.rpcPortId},i.postMessage(a)}}_postMessage(e,t,i){let s=this._preparePostMessageReturnPromise(t);return i=this._preparePostMessageOptions(i),t.headers.request.portId=e.rpcPortId,e.postMessage(t,i),this._alertMessageDispatched(),s}_preparePostMessageReturnPromise(e){let t=r._resolvedPromise;return e.returnPromise&&(e.promiseHash=crypto.randomUUID(),e.returnPromise=void 0,t=Ae.defer(),r._promiseHashMap.set(e.promiseHash,t)),t}_preparePostMessageOptions(e){return e}_alertMessageDispatched(){}},Lt=class{isActive=!1;port;constructor(e){this.port=e}setup(){}teardown(){this.port.close()}setRpcPortId(e){this.port.rpcPortId||(this.port.rpcPortId=e)}preparePostMessageOptions(e){return e}getRecipient(){return this.port}alertMessageDispatched(){}setEventListener(e,t,i){this.port.onmessage=t}},J=class{_worker;_messageChannel;_mcResponder;constructor(e,t){this._worker=e,e instanceof ServiceWorker&&(t=!0),t&&(this._messageChannel=new MessageChannel)}setup(){this._messageChannel&&(this._mcResponder=new Lt(this._messageChannel.port1),this._mcResponder.setup())}teardown(){this._mcResponder&&this._mcResponder.teardown(),this._worker instanceof Worker&&(this._worker.onmessage=null)}setRpcPortId(e){this._mcResponder&&this._mcResponder.setRpcPortId(e.replace("DEFAULT","altWorkerMC")),"port"in this._worker&&(this._worker.port.rpcPortId=e),this._worker.rpcPortId=e}preparePostMessageOptions(e){return this._mcResponder&&!this._mcResponder.isActive&&(e?e=[this._messageChannel.port2,...e]:e=[this._messageChannel.port2],this._messageChannel=null),e}getRecipient(){return this._mcResponder&&this._mcResponder.isActive?this._mcResponder.getRecipient():"port"in this._worker?this._worker.port:this._worker}alertMessageDispatched(){this._mcResponder&&!this._mcResponder.isActive&&(this._mcResponder.isActive=!0)}setEventListener(e,t,i){this._worker.onmessage=t,this._mcResponder&&this._mcResponder.setEventListener(e,t,i)}};var V=class extends qe{_responder;constructor(e){super(),this._responder=e,this._responder.setRpcPortId("DEFAULT")}async __teardown__(){let e=this._prepareMessage(this.__teardown__);await this._postMessage(this._getRecipient(),e)}async __transferPorts__(e,t){let i=this._prepareMessage(this.__transferPorts__,e);e.portIds.forEach((n,o,a)=>{this._namedTransferredPortMaps.set(n,t[o])});let s=await this._postMessage(this._getRecipient(),i,t);if(t.length!==s.resp.count)throw new Error(`IllegalState: port mismatch; sent ${t.length} ports, transfered ${s.resp.count}`);return s.resp}async __getTransferredPorts__(){let e=this._prepareMessage(this.__getTransferredPorts__);return{portIds:(await this._postMessage(this._getRecipient(),e)).resp.portIds}}async __deleteTransferredPorts__(e){let t=this._prepareMessage(this.__deleteTransferredPorts__,e);await this._postMessage(this._getRecipient(),t),e.portIds.forEach((i,s,n)=>{this._namedTransferredPortMaps.delete(i)})}startClient(){this._responder.setup(),this._responder.setEventListener("message",async e=>{await this._handleRpc(e)}),this._bindMethods(),console.log(`${B.THREAD_ID}>${this.__getName__()} started: waiting for messages...`)}async stopClient(){let e=Array.from(this._namedTransferredPortMaps.keys());await this.__deleteTransferredPorts__({portIds:e}),await this.__teardown__(),this._responder.teardown(),this._responder.setEventListener("message",null),this._bindMethods(!1)}_preparePostMessageOptions(e){return this._responder.preparePostMessageOptions(e)}_getRecipient(){return this._responder.getRecipient()}_alertMessageDispatched(){this._responder.alertMessageDispatched()}async _onMessageChannelMessage(e){await this._handleRpc(e)}};var Ye=class{static bindRpc(e){let t=e;t.api||(t.api=1),t.bindRpcFunc(t,e.setup),t.bindRpcFunc(t,e.teardown,{hasNoArgs:!0}),t.bindRpcFunc(t,e.downloadSelections),t.bindRpcFunc(t,e.deleteSelections),t.bindRpcFunc(t,e.onProgressUpdate),t.bindRpcFunc(t,e.onFinished)}},ze=class{static bindRpc(e){let t=e;t.api||(t.api=2),t.bindRpcFunc(t,e.downloadTrack,{hasReturn:!0}),t.bindRpcFunc(t,e.deleteTrack,{hasReturn:!0}),t.bindRpcFunc(t,e.onProcessed)}};var je=class extends V{__getName__(){return"OfflineAudioManagerWorkerClient"}onProgressUpdate_;onProgressUpdate=async e=>{await this.onProgressUpdate_(e)};onFinished_;onFinished=async e=>{await this.onFinished_(e)};async setup(e){let t=this._prepareMessage(this.setup,e);await this._postMessage(this._getRecipient(),t)}async teardown(){let e=this._prepareMessage(this.teardown);await this._postMessage(this._getRecipient(),e)}async downloadSelections(e){let t=this._prepareMessage(this.downloadSelections,e);await this._postMessage(this._getRecipient(),t)}async deleteSelections(e){let t=this._prepareMessage(this.deleteSelections,e);await this._postMessage(this._getRecipient(),t)}_bindMethods(){super._bindMethods(),Ye.bindRpc(this)}};var Je=class extends V{__getName__(){return"OfflineAudioWorkerClient"}onProcessed_;onProcessed=async e=>{await this.onProcessed_(e)};async downloadTrack(e){let t=this._prepareMessage(this.downloadTrack,e);return(await this._postMessage(this._getRecipient(),t)).resp}async deleteTrack(e){let t=this._prepareMessage(this.deleteTrack,e);return(await this._postMessage(this._getRecipient(),t)).resp}_bindMethods(){super._bindMethods(),ze.bindRpc(this)}};var _e=Math.min,ie=Math.max,Me=Math.round;var Q=r=>({x:r,y:r}),Li={left:"right",right:"left",bottom:"top",top:"bottom"},$i={start:"end",end:"start"};function $t(r,e,t){return ie(r,_e(e,t))}function Ce(r,e){return typeof r=="function"?r(e):r}function se(r){return r.split("-")[0]}function Ie(r){return r.split("-")[1]}function Dt(r){return r==="x"?"y":"x"}function Ht(r){return r==="y"?"height":"width"}function xe(r){return["top","bottom"].includes(se(r))?"y":"x"}function Bt(r){return Dt(xe(r))}function Kt(r,e,t){t===void 0&&(t=!1);let i=Ie(r),s=Bt(r),n=Ht(s),o=s==="x"?i===(t?"end":"start")?"right":"left":i==="start"?"bottom":"top";return e.reference[n]>e.floating[n]&&(o=Ee(o)),[o,Ee(o)]}function Qt(r){let e=Ee(r);return[Xe(r),e,Xe(e)]}function Xe(r){return r.replace(/start|end/g,e=>$i[e])}function Di(r,e,t){let i=["left","right"],s=["right","left"],n=["top","bottom"],o=["bottom","top"];switch(r){case"top":case"bottom":return t?e?s:i:e?i:s;case"left":case"right":return e?n:o;default:return[]}}function Zt(r,e,t,i){let s=Ie(r),n=Di(se(r),t==="start",i);return s&&(n=n.map(o=>o+"-"+s),e&&(n=n.concat(n.map(Xe)))),n}function Ee(r){return r.replace(/left|right|bottom|top/g,e=>Li[e])}function Hi(r){return{top:0,right:0,bottom:0,left:0,...r}}function ei(r){return typeof r!="number"?Hi(r):{top:r,right:r,bottom:r,left:r}}function ce(r){return{...r,top:r.y,left:r.x,right:r.x+r.width,bottom:r.y+r.height}}function ti(r,e,t){let{reference:i,floating:s}=r,n=xe(e),o=Bt(e),a=Ht(o),l=se(e),c=n==="y",m=i.x+i.width/2-s.width/2,f=i.y+i.height/2-s.height/2,S=i[a]/2-s[a]/2,v;switch(l){case"top":v={x:m,y:i.y-s.height};break;case"bottom":v={x:m,y:i.y+i.height};break;case"right":v={x:i.x+i.width,y:f};break;case"left":v={x:i.x-s.width,y:f};break;default:v={x:i.x,y:i.y}}switch(Ie(e)){case"start":v[o]-=S*(t&&c?-1:1);break;case"end":v[o]+=S*(t&&c?-1:1);break}return v}var ii=async(r,e,t)=>{let{placement:i="bottom",strategy:s="absolute",middleware:n=[],platform:o}=t,a=n.filter(Boolean),l=await(o.isRTL==null?void 0:o.isRTL(e)),c=await o.getElementRects({reference:r,floating:e,strategy:s}),{x:m,y:f}=ti(c,i,l),S=i,v={},d=0;for(let h=0;h<a.length;h++){let{name:g,fn:u}=a[h],{x:p,y:P,data:y,reset:w}=await u({x:m,y:f,initialPlacement:i,placement:S,strategy:s,middlewareData:v,rects:c,platform:o,elements:{reference:r,floating:e}});m=p??m,f=P??f,v={...v,[g]:{...v[g],...y}},w&&d<=50&&(d++,typeof w=="object"&&(w.placement&&(S=w.placement),w.rects&&(c=w.rects===!0?await o.getElementRects({reference:r,floating:e,strategy:s}):w.rects),{x:m,y:f}=ti(c,S,l)),h=-1)}return{x:m,y:f,placement:S,strategy:s,middlewareData:v}};async function Ft(r,e){var t;e===void 0&&(e={});let{x:i,y:s,platform:n,rects:o,elements:a,strategy:l}=r,{boundary:c="clippingAncestors",rootBoundary:m="viewport",elementContext:f="floating",altBoundary:S=!1,padding:v=0}=Ce(e,r),d=ei(v),g=a[S?f==="floating"?"reference":"floating":f],u=ce(await n.getClippingRect({element:(t=await(n.isElement==null?void 0:n.isElement(g)))==null||t?g:g.contextElement||await(n.getDocumentElement==null?void 0:n.getDocumentElement(a.floating)),boundary:c,rootBoundary:m,strategy:l})),p=f==="floating"?{...o.floating,x:i,y:s}:o.reference,P=await(n.getOffsetParent==null?void 0:n.getOffsetParent(a.floating)),y=await(n.isElement==null?void 0:n.isElement(P))?await(n.getScale==null?void 0:n.getScale(P))||{x:1,y:1}:{x:1,y:1},w=ce(n.convertOffsetParentRelativeRectToViewportRelativeRect?await n.convertOffsetParentRelativeRectToViewportRelativeRect({elements:a,rect:p,offsetParent:P,strategy:l}):p);return{top:(u.top-w.top+d.top)/y.y,bottom:(w.bottom-u.bottom+d.bottom)/y.y,left:(u.left-w.left+d.left)/y.x,right:(w.right-u.right+d.right)/y.x}}var si=function(r){return r===void 0&&(r={}),{name:"flip",options:r,async fn(e){var t,i;let{placement:s,middlewareData:n,rects:o,initialPlacement:a,platform:l,elements:c}=e,{mainAxis:m=!0,crossAxis:f=!0,fallbackPlacements:S,fallbackStrategy:v="bestFit",fallbackAxisSideDirection:d="none",flipAlignment:h=!0,...g}=Ce(r,e);if((t=n.arrow)!=null&&t.alignmentOffset)return{};let u=se(s),p=se(a)===a,P=await(l.isRTL==null?void 0:l.isRTL(c.floating)),y=S||(p||!h?[Ee(a)]:Qt(a));!S&&d!=="none"&&y.push(...Zt(a,h,d,P));let w=[a,...y],M=await Ft(e,g),b=[],j=((i=n.flip)==null?void 0:i.overflows)||[];if(m&&b.push(M[u]),f){let K=Kt(s,o,P);b.push(M[K[0]],M[K[1]])}if(j=[...j,{placement:s,overflows:b}],!b.every(K=>K<=0)){var we,ke;let K=(((we=n.flip)==null?void 0:we.index)||0)+1,Te=w[K];if(Te)return{data:{index:K,overflows:j},reset:{placement:Te}};let R=(ke=j.filter(x=>x.overflows[0]<=0).sort((x,O)=>x.overflows[1]-O.overflows[1])[0])==null?void 0:ke.placement;if(!R)switch(v){case"bestFit":{var Fe;let x=(Fe=j.map(O=>[O.placement,O.overflows.filter($=>$>0).reduce(($,de)=>$+de,0)]).sort((O,$)=>O[1]-$[1])[0])==null?void 0:Fe[0];x&&(R=x);break}case"initialPlacement":R=a;break}if(s!==R)return{reset:{placement:R}}}return{}}}};async function Bi(r,e){let{placement:t,platform:i,elements:s}=r,n=await(i.isRTL==null?void 0:i.isRTL(s.floating)),o=se(t),a=Ie(t),l=xe(t)==="y",c=["left","top"].includes(o)?-1:1,m=n&&l?-1:1,f=Ce(e,r),{mainAxis:S,crossAxis:v,alignmentAxis:d}=typeof f=="number"?{mainAxis:f,crossAxis:0,alignmentAxis:null}:{mainAxis:0,crossAxis:0,alignmentAxis:null,...f};return a&&typeof d=="number"&&(v=a==="end"?d*-1:d),l?{x:v*m,y:S*c}:{x:S*c,y:v*m}}var Ot=function(r){return r===void 0&&(r=0),{name:"offset",options:r,async fn(e){var t,i;let{x:s,y:n,placement:o,middlewareData:a}=e,l=await Bi(e,r);return o===((t=a.offset)==null?void 0:t.placement)&&(i=a.arrow)!=null&&i.alignmentOffset?{}:{x:s+l.x,y:n+l.y,data:{...l,placement:o}}}}},ri=function(r){return r===void 0&&(r={}),{name:"shift",options:r,async fn(e){let{x:t,y:i,placement:s}=e,{mainAxis:n=!0,crossAxis:o=!1,limiter:a={fn:g=>{let{x:u,y:p}=g;return{x:u,y:p}}},...l}=Ce(r,e),c={x:t,y:i},m=await Ft(e,l),f=xe(se(s)),S=Dt(f),v=c[S],d=c[f];if(n){let g=S==="y"?"top":"left",u=S==="y"?"bottom":"right",p=v+m[g],P=v-m[u];v=$t(p,v,P)}if(o){let g=f==="y"?"top":"left",u=f==="y"?"bottom":"right",p=d+m[g],P=d-m[u];d=$t(p,d,P)}let h=a.fn({...e,[S]:v,[f]:d});return{...h,data:{x:h.x-t,y:h.y-i}}}}};function Z(r){return oi(r)?(r.nodeName||"").toLowerCase():"#document"}function F(r){var e;return(r==null||(e=r.ownerDocument)==null?void 0:e.defaultView)||window}function ee(r){var e;return(e=(oi(r)?r.ownerDocument:r.document)||window.document)==null?void 0:e.documentElement}function oi(r){return r instanceof Node||r instanceof F(r).Node}function X(r){return r instanceof Element||r instanceof F(r).Element}function z(r){return r instanceof HTMLElement||r instanceof F(r).HTMLElement}function ni(r){return typeof ShadowRoot>"u"?!1:r instanceof ShadowRoot||r instanceof F(r).ShadowRoot}function pe(r){let{overflow:e,overflowX:t,overflowY:i,display:s}=N(r);return/auto|scroll|overlay|hidden|clip/.test(e+i+t)&&!["inline","contents"].includes(s)}function ai(r){return["table","td","th"].includes(Z(r))}function Ke(r){let e=Qe(),t=N(r);return t.transform!=="none"||t.perspective!=="none"||(t.containerType?t.containerType!=="normal":!1)||!e&&(t.backdropFilter?t.backdropFilter!=="none":!1)||!e&&(t.filter?t.filter!=="none":!1)||["transform","perspective","filter"].some(i=>(t.willChange||"").includes(i))||["paint","layout","strict","content"].some(i=>(t.contain||"").includes(i))}function Nt(r){let e=he(r);for(;z(e)&&!Le(e);){if(Ke(e))return e;e=he(e)}return null}function Qe(){return typeof CSS>"u"||!CSS.supports?!1:CSS.supports("-webkit-backdrop-filter","none")}function Le(r){return["html","body","#document"].includes(Z(r))}function N(r){return F(r).getComputedStyle(r)}function $e(r){return X(r)?{scrollLeft:r.scrollLeft,scrollTop:r.scrollTop}:{scrollLeft:r.pageXOffset,scrollTop:r.pageYOffset}}function he(r){if(Z(r)==="html")return r;let e=r.assignedSlot||r.parentNode||ni(r)&&r.host||ee(r);return ni(e)?e.host:e}function li(r){let e=he(r);return Le(e)?r.ownerDocument?r.ownerDocument.body:r.body:z(e)&&pe(e)?e:li(e)}function Ge(r,e,t){var i;e===void 0&&(e=[]),t===void 0&&(t=!0);let s=li(r),n=s===((i=r.ownerDocument)==null?void 0:i.body),o=F(s);return n?e.concat(o,o.visualViewport||[],pe(s)?s:[],o.frameElement&&t?Ge(o.frameElement):[]):e.concat(s,Ge(s,[],t))}function di(r){let e=N(r),t=parseFloat(e.width)||0,i=parseFloat(e.height)||0,s=z(r),n=s?r.offsetWidth:t,o=s?r.offsetHeight:i,a=Me(t)!==n||Me(i)!==o;return a&&(t=n,i=o),{width:t,height:i,$:a}}function ui(r){return X(r)?r:r.contextElement}function me(r){let e=ui(r);if(!z(e))return Q(1);let t=e.getBoundingClientRect(),{width:i,height:s,$:n}=di(e),o=(n?Me(t.width):t.width)/i,a=(n?Me(t.height):t.height)/s;return(!o||!Number.isFinite(o))&&(o=1),(!a||!Number.isFinite(a))&&(a=1),{x:o,y:a}}var Fi=Q(0);function gi(r){let e=F(r);return!Qe()||!e.visualViewport?Fi:{x:e.visualViewport.offsetLeft,y:e.visualViewport.offsetTop}}function Oi(r,e,t){return e===void 0&&(e=!1),!t||e&&t!==F(r)?!1:e}function De(r,e,t,i){e===void 0&&(e=!1),t===void 0&&(t=!1);let s=r.getBoundingClientRect(),n=ui(r),o=Q(1);e&&(i?X(i)&&(o=me(i)):o=me(r));let a=Oi(n,t,i)?gi(n):Q(0),l=(s.left+a.x)/o.x,c=(s.top+a.y)/o.y,m=s.width/o.x,f=s.height/o.y;if(n){let S=F(n),v=i&&X(i)?F(i):i,d=S.frameElement;for(;d&&i&&v!==S;){let h=me(d),g=d.getBoundingClientRect(),u=N(d),p=g.left+(d.clientLeft+parseFloat(u.paddingLeft))*h.x,P=g.top+(d.clientTop+parseFloat(u.paddingTop))*h.y;l*=h.x,c*=h.y,m*=h.x,f*=h.y,l+=p,c+=P,d=F(d).frameElement}}return ce({width:m,height:f,x:l,y:c})}var Ni=[":popover-open",":modal"];function pi(r){let e=!1,t=0,i=0;function s(n){try{e=e||r.matches(n)}catch{}}if(Ni.forEach(n=>{s(n)}),e){let n=Nt(r);if(n){let o=n.getBoundingClientRect();t=o.x,i=o.y}}return[e,t,i]}function Wi(r){let{elements:e,rect:t,offsetParent:i,strategy:s}=r,n=ee(i),[o]=e?pi(e.floating):[!1];if(i===n||o)return t;let a={scrollLeft:0,scrollTop:0},l=Q(1),c=Q(0),m=z(i);if((m||!m&&s!=="fixed")&&((Z(i)!=="body"||pe(n))&&(a=$e(i)),z(i))){let f=De(i);l=me(i),c.x=f.x+i.clientLeft,c.y=f.y+i.clientTop}return{width:t.width*l.x,height:t.height*l.y,x:t.x*l.x-a.scrollLeft*l.x+c.x,y:t.y*l.y-a.scrollTop*l.y+c.y}}function Ui(r){return Array.from(r.getClientRects())}function mi(r){return De(ee(r)).left+$e(r).scrollLeft}function Vi(r){let e=ee(r),t=$e(r),i=r.ownerDocument.body,s=ie(e.scrollWidth,e.clientWidth,i.scrollWidth,i.clientWidth),n=ie(e.scrollHeight,e.clientHeight,i.scrollHeight,i.clientHeight),o=-t.scrollLeft+mi(r),a=-t.scrollTop;return N(i).direction==="rtl"&&(o+=ie(e.clientWidth,i.clientWidth)-s),{width:s,height:n,x:o,y:a}}function qi(r,e){let t=F(r),i=ee(r),s=t.visualViewport,n=i.clientWidth,o=i.clientHeight,a=0,l=0;if(s){n=s.width,o=s.height;let c=Qe();(!c||c&&e==="fixed")&&(a=s.offsetLeft,l=s.offsetTop)}return{width:n,height:o,x:a,y:l}}function Yi(r,e){let t=De(r,!0,e==="fixed"),i=t.top+r.clientTop,s=t.left+r.clientLeft,n=z(r)?me(r):Q(1),o=r.clientWidth*n.x,a=r.clientHeight*n.y,l=s*n.x,c=i*n.y;return{width:o,height:a,x:l,y:c}}function ci(r,e,t){let i;if(e==="viewport")i=qi(r,t);else if(e==="document")i=Vi(ee(r));else if(X(e))i=Yi(e,t);else{let s=gi(r);i={...e,x:e.x-s.x,y:e.y-s.y}}return ce(i)}function fi(r,e){let t=he(r);return t===e||!X(t)||Le(t)?!1:N(t).position==="fixed"||fi(t,e)}function zi(r,e){let t=e.get(r);if(t)return t;let i=Ge(r,[],!1).filter(a=>X(a)&&Z(a)!=="body"),s=null,n=N(r).position==="fixed",o=n?he(r):r;for(;X(o)&&!Le(o);){let a=N(o),l=Ke(o);!l&&a.position==="fixed"&&(s=null),(n?!l&&!s:!l&&a.position==="static"&&!!s&&["absolute","fixed"].includes(s.position)||pe(o)&&!l&&fi(r,o))?i=i.filter(m=>m!==o):s=a,o=he(o)}return e.set(r,i),i}function ji(r){let{element:e,boundary:t,rootBoundary:i,strategy:s}=r,o=[...t==="clippingAncestors"?zi(e,this._c):[].concat(t),i],a=o[0],l=o.reduce((c,m)=>{let f=ci(e,m,s);return c.top=ie(f.top,c.top),c.right=_e(f.right,c.right),c.bottom=_e(f.bottom,c.bottom),c.left=ie(f.left,c.left),c},ci(e,a,s));return{width:l.right-l.left,height:l.bottom-l.top,x:l.left,y:l.top}}function Ji(r){let{width:e,height:t}=di(r);return{width:e,height:t}}function Xi(r,e,t,i){let s=z(e),n=ee(e),o=t==="fixed",a=De(r,!0,o,e),l={scrollLeft:0,scrollTop:0},c=Q(0);if(s||!s&&!o)if((Z(e)!=="body"||pe(n))&&(l=$e(e)),s){let h=De(e,!0,o,e);c.x=h.x+e.clientLeft,c.y=h.y+e.clientTop}else n&&(c.x=mi(n));let m=a.left+l.scrollLeft-c.x,f=a.top+l.scrollTop-c.y,[S,v,d]=pi(i);return S&&(m+=v,f+=d,s&&(m+=e.clientLeft,f+=e.clientTop)),{x:m,y:f,width:a.width,height:a.height}}function hi(r,e){return!z(r)||N(r).position==="fixed"?null:e?e(r):r.offsetParent}function Pi(r,e){let t=F(r);if(!z(r))return t;let i=hi(r,e);for(;i&&ai(i)&&N(i).position==="static";)i=hi(i,e);return i&&(Z(i)==="html"||Z(i)==="body"&&N(i).position==="static"&&!Ke(i))?t:i||Nt(r)||t}var Gi=async function(r){let e=this.getOffsetParent||Pi,t=this.getDimensions;return{reference:Xi(r.reference,await e(r.floating),r.strategy,r.floating),floating:{x:0,y:0,...await t(r.floating)}}};function Ki(r){return N(r).direction==="rtl"}var Qi={convertOffsetParentRelativeRectToViewportRelativeRect:Wi,getDocumentElement:ee,getClippingRect:ji,getOffsetParent:Pi,getElementRects:Gi,getClientRects:Ui,getDimensions:Ji,getScale:me,isElement:X,isRTL:Ki};var yi=ri,Si=si;var vi=(r,e,t)=>{let i=new Map,s={platform:Qi,...t},n={...s.platform,_c:i};return ii(r,e,{...s,platform:n})};var Ze=class{static async position(e,t){let i=await vi(e,t,{placement:"bottom-start",middleware:[Ot(6),Si(),yi({padding:5})]});Object.assign(t.style,{left:`${i.x}px`,top:`${i.y}px`})}};var E=class{$triggerEl;$toggleComponent;dropDownGroup;clickHandler=e=>{this.dropDownGroup.forEach((t,i,s)=>{t!==this&&t.$toggleComponent.hide()}),this.$toggleComponent.isVisible()?this.$toggleComponent.hide():(Ze.position(this.$triggerEl,this.$toggleComponent.$element),this.$toggleComponent.show())};constructor(e,t,i=[]){this.$triggerEl=e,this.$toggleComponent=t,this.dropDownGroup=i,this.dropDownGroup.push(this)}};var k=class{$element;clsHidden;oppositeHidden;showCount=0;hideOnCountZero;onShow;onHide;constructor(e,t="hidden",i=[],s=!1){this.$element=e,this.clsHidden=t,this.oppositeHidden=i,this.hideOnCountZero=s}isVisible(){return!this.$element.classList.contains(this.clsHidden)}show(){this.showCount++,this.$element.classList.remove(this.clsHidden),this.oppositeHidden.forEach((e,t,i)=>{this.$element.classList.add(e)}),this.onShow&&this.onShow()}hide(){this.showCount--,!(this.hideOnCountZero&&this.showCount>0)&&(this.$element.classList.add(this.clsHidden),this.oppositeHidden.forEach((e,t,i)=>{this.$element.classList.remove(e)}),this.onHide&&this.onHide())}toggle(){let e=this.isVisible();return e?this.hide():this.show(),!e}};var et=class{app;model;view;bookmarks=[];eventRegistry=new ue;coordinator;offlineTrackRefJson={};clipboardStore=new ae;fileStore;constructor(e){this.app=e,this.model=e.model.shell,this.view=new Wt(this),this.fileStore=new Ve("fileTransferManageActionShellPgInput")}launch(){this.view.bind(),this._registerModelListeners(),this._registerAudioControlListeners(),this._registerMediaButtonListeners(),this._registerSettingsMenuListeners(),this._registerOfflineCacheListeners(),this.view.initialiseView()}terminate(){}setBookmark(e){this.addBookmarks([e])}addBookmarks(e){this.clearBookmarks(),this.bookmarks.splice(0,0,...e),this.showMessage(`${e.length} bookmark(s) copied!`)}clearBookmarks(){this.bookmarks.length=0}showMessage(e,t=3e3){this.view.showMessage(e,t)}hideMessage(){this.view.hideMessage()}showPrompt(e,t){this.view.showPrompt(e,t)}async _processOfflineSelections(e){let t=this.app.router.activeRouteHandler.getTrackSelections();if(t.length===0){this.showMessage("No offline processing selections made!");return}await this._setupCoordinator(t,e),await this.coordinator.process()}async _setupCoordinator(e,t){this.coordinator=new Ut(this,e,t),await this.coordinator.setup()}async _teardownCoordinator(){if(this.view.refreshOfflineElements(!1),Object.keys(this.offlineTrackRefJson).length>0){await this.app.albumStoreWorkerClient.updateTrackCacheInfo({trackRefsIsInCache:this.offlineTrackRefJson});for(let e=0;e<this.app.pagesControllers.length;e++)await this.app.pagesControllers[e].onAfterOfflineProcessing(this.offlineTrackRefJson)}this.offlineTrackRefJson={},this.coordinator&&(await this.coordinator.teardown(),this.coordinator=null)}_registerModelListeners(){this.model.onAudioPlayEnd=async()=>{let e=!1;if(this.app.model.audioSettings.playNext)e=this.model.playNext();else if(this.app.model.audioSettings.repeat){let[t]=this.model.adjustTimeWithinStartStopRangesIfReqd(0,this.app.model.audioSettings.applyStopStartRange);this.model.onAudioResetTimeTo(t)}else this.model.onAudioResetTimeTo(this.model.currentTime);return e},this.model.onAudioResetTimeTo=e=>{e&&(this.view.$controlShellPgAudio.currentTime=e)},this.model.onAudioStateChange=(e,t)=>{(t===1||t===4||t===5)&&this.view.refreshPlayPause(),e<3&&t<3||this.view.refreshAudioPlaybackControls(),t===3&&this.view.refreshPlaylistControls()},this.model.onAudioTimeChange=e=>{this.view.$currentTimeShellPgInput.value=`${e}`},this.model.onAudioTrackConfigChange=()=>{this.view.refreshStartStopRange()},this.model.onAudioTrackSrcChange=async(e,t)=>{await this.model.setAudioState(0),this.view.$controlShellPgAudio.src=e,this.view.$trackRefShellPgSpan.textContent=this.model.playlist.selectedPlaylistItem.trackRef,await this.model.setAudioState(1),this.view.$controlShellPgAudio.currentTime=this.model.startTime,this.view.$currentTimeShellPgInput.value=String(this.model.startTime),this.view.refreshStartStopRange()},this.model.onMountChange=e=>{this.view.refreshMountedPlaylist()},this.model.onPlayToggle=async e=>{e?this.view.$controlShellPgAudio.pause():await this.view.$controlShellPgAudio.play()},this.model.onSkipWithinTrack=e=>{let t=this.view.$controlShellPgAudio.currentTime;this.view.$controlShellPgAudio.currentTime=t+e},this.model.onSyncTextWithAudioIfReqd=(e,t)=>{if(this.app.model.textSettings.autoScrollWithAudio&&this.app.trackPage.isVisible()){let[i,s]=this.app.model.track.estimateTextSyncPosition(t);this.app.trackPage.scrollToLineWithPerc(i+s)}},this.model.onTrackIndexChange=(e,t,i)=>{this.view.refreshPlaylistControls(),this.model.playlistController.onTrackListIndexChange(e,t,i);let s=H.toHref(this.model.playlist.selectedPlaylistItem);this.app.trackPage.$menuItem.href=s,this.app.trackPage.isVisible()&&(location.hash=s)}}_registerAudioControlListeners(){this.view.$controlShellPgAudio.onloadedmetadata=async()=>{await this.model.setAudioState(2)},this.view.$controlShellPgAudio.onloadeddata=async()=>{await this.model.setAudioState(3)},this.view.$controlShellPgAudio.onplay=async()=>{await this.model.setAudioState(4)},this.view.$controlShellPgAudio.onpause=async()=>{await this.model.setAudioState(5)},this.view.$controlShellPgAudio.onended=async()=>{await this.model.setAudioState(6)},this.view.$controlShellPgAudio.ontimeupdate=async()=>{this.model.preventOnTimeUpdate||await this.model.receiveTimeUpdate(this.view.$controlShellPgAudio.currentTime,this.app.model.audioSettings.applyStopStartRange),this.model.preventOnTimeUpdate=!1}}_registerMediaButtonListeners(){this.eventRegistry.register(this.view.$prevTrackShellPgBtn,"click",e=>{this.model.playPrevious()}),this.eventRegistry.register(this.view.$skipBackShellPgBtn,"click",e=>{let t=parseFloat(this.view.$skipSizeShellPgInput.value);isNaN(t)||this.model.skipWithinTrack(-t)}),this.eventRegistry.register(this.view.$playPauseToggleShellPgBtn,"click",async e=>{await this.model.playToggle(this.model.audioState===4)}),this.eventRegistry.register(this.view.$skipForwardShellPgBtn,"click",e=>{let t=parseFloat(this.view.$skipSizeShellPgInput.value);isNaN(t)||this.model.skipWithinTrack(t)}),this.eventRegistry.register(this.view.$nextTrackShellPgBtn,"click",e=>{this.model.playNext()}),this.eventRegistry.register(this.view.$currentTimeShellPgInput,"change",e=>{let t=parseFloat(this.view.$currentTimeShellPgInput.value);isNaN(t)||(this.view.$controlShellPgAudio.currentTime=t)})}_registerSettingsMenuListeners(){this.eventRegistry.register(this.view.$playbackRateShellPgInput,"change",e=>{this.app.model.audioSettings.playbackRate=parseFloat(this.view.$playbackRateShellPgInput.value),this.view.refreshPlaybackRate()}),this.eventRegistry.register(this.view.$startAudioShellPgBtn,"click",e=>{this.app.trackPage.isVisible()?this.app.trackPage.toggleAudioStart(!1):this.showMessage("Switch to Reader page view 1st to change start from time")}),this.eventRegistry.register(this.view.$stopAudioShellPgBtn,"click",e=>{this.app.trackPage.isVisible()?this.app.trackPage.toggleAudioStop(!1):this.showMessage("Switch to Reader page view 1st to change stop at time")}),this.eventRegistry.register(this.view.$autoPlayShellPgInput,"change",e=>{this.app.model.audioSettings.autoPlay=this.view.$autoPlayShellPgInput.checked,this.view.$controlShellPgAudio.autoplay=this.app.model.audioSettings.autoPlay}),this.eventRegistry.register(this.view.$playNextShellPgInput,"change",e=>{this.app.model.audioSettings.playNext=this.view.$playNextShellPgInput.checked,this.app.model.audioSettings.playNext&&(this.view.$repeatShellPgInput.checked=!1,this.app.model.audioSettings.repeat=!1)}),this.eventRegistry.register(this.view.$repeatShellPgInput,"change",e=>{this.app.model.audioSettings.repeat=this.view.$repeatShellPgInput.checked,this.view.$controlShellPgAudio.loop=this.app.model.audioSettings.repeat,this.app.model.audioSettings.repeat&&(this.view.$playNextShellPgInput.checked=!1,this.app.model.audioSettings.playNext=!1)}),this.eventRegistry.register(this.view.$skipSizeShellPgInput,"change",e=>{let t=parseFloat(this.view.$skipSizeShellPgInput.value);isNaN(t)&&(t=.25),this.app.model.audioSettings.skipSize=t,this.view.$currentTimeShellPgInput.step=String(t)}),this.eventRegistry.register(this.view.$applyStopStartShellPgInput,"change",e=>{this.app.model.audioSettings.applyStopStartRange=this.view.$applyStopStartShellPgInput.checked,this.view.refreshStartStopRange()}),this.eventRegistry.register(this.view.$scrollToTopShellPgA,"click",e=>{e.preventDefault(),window.scrollTo({top:0,behavior:"smooth"})}),this.eventRegistry.register(this.view.$findInPageShellPgForm,"submit",e=>{e.preventDefault(),this.app.model.textSettings.findInPageCriteria=this.view.$findInPageShellPgInput.value,"find"in window?window.find(this.app.model.textSettings.findInPageCriteria):this.showMessage("Platform does not support find text in page")}),this.eventRegistry.register(this.view.$copyUrlShellPgA,"click",async e=>{e.preventDefault();let t=this.app.router.getCurrentUrlRoute();t.searchParams.set("olo","1");let i=t.prepareHumanReadableLink(!1);await navigator.clipboard.writeText(i),this.showMessage("URL copied to clipboard")}),this.eventRegistry.register(this.view.$gotoPasteUrlShellPgA,"click",async e=>{if(e.preventDefault(),ae.isReadAvailable()){let t=await navigator.clipboard.readText();location.href=t}else this.showMessage("Platform does not support reading from clipboard")}),this.eventRegistry.register(this.view.$useTransferManageActionShellPgSelect,"change",async e=>{this.app.model.generalSettings.useTransfer=parseInt(this.view.$useTransferManageActionShellPgSelect.value),this.view.refreshUploadFileFromModel()}),this.eventRegistry.register(this.view.$darkThemeShellPgBtn,"click",e=>{this.app.model.generalSettings.darkTheme=!this.app.model.generalSettings.darkTheme,this.view.refreshDarkTheme()}),this.eventRegistry.register(this.view.$resetAppShellPgBtn,"click",e=>{this.showPrompt(`Are you sure you want to reset app v${tt.VERSION} and lose downloaded audio?`,async t=>{await this.app.reset()})}),this.fileStore.onContentLoaded=e=>{this.showMessage(`Content of length [${e}] loaded`)}}_registerOfflineCacheListeners(){this.eventRegistry.register(this.view.$downloadSelsShellPgA,"click",async e=>{e.preventDefault(),await this._processOfflineSelections(!0)}),this.eventRegistry.register(this.view.$deleteSelsShellPgA,"click",async e=>{e.preventDefault(),await this._processOfflineSelections(!1)}),this.eventRegistry.register(this.view.$abortOfflineShellPgBtn,"click",async e=>{this.view.$abortOfflineShellPgBtn.textContent="Aborted",await this._teardownCoordinator()})}},Wt=class{prompt;lastSbTimeoutHdl;$mainMenuShellPgBtn=document.getElementById("mainMenuShellPgBtn");$mainMenuShellPgAside=document.getElementById("mainMenuShellPgAside");$backdropShellPgDiv=document.getElementById("backdropShellPgDiv");$settingsDrpDnShellPgA=document.getElementById("settingsDrpDnShellPgA");$settingsDrpDnShellPgDiv=document.getElementById("settingsDrpDnShellPgDiv");$trackRefShellPgSpan=document.getElementById("trackRefShellPgSpan");$controlShellPgAudio=document.getElementById("controlShellPgAudio");$prevTrackShellPgBtn=document.getElementById("prevTrackShellPgBtn");$playPauseToggleShellPgBtn=document.getElementById("playPauseToggleShellPgBtn");$nextTrackShellPgBtn=document.getElementById("nextTrackShellPgBtn");$steroTypeShellPgDiv=document.getElementById("steroTypeShellPgDiv");$playToggleShellSvg=document.getElementById("playToggleShellSvg");$pauseToggleShellSvg=document.getElementById("pauseToggleShellSvg");$audioDrpDnShellPgBtn=document.getElementById("audioDrpDnShellPgBtn");$audioDrpDnShellPgDiv=document.getElementById("audioDrpDnShellPgDiv");$textDrpDnShellPgBtn=document.getElementById("textDrpDnShellPgBtn");$textDrpDnShellPgDiv=document.getElementById("textDrpDnShellPgDiv");$offlineDrpDnShellPgBtn=document.getElementById("offlineDrpDnShellPgBtn");$offlineDrpDnShellPgDiv=document.getElementById("offlineDrpDnShellPgDiv");$shareDrpDnShellPgBtn=document.getElementById("shareDrpDnShellPgBtn");$shareDrpDnShellPgDiv=document.getElementById("shareDrpDnShellPgDiv");$playbackRateShellPgLabel=document.getElementById("playbackRateShellPgLabel");$playbackRateShellPgInput=document.getElementById("playbackRateShellPgInput");$skipBackShellPgBtn=document.getElementById("skipBackShellPgBtn");$currentTimeShellPgInput=document.getElementById("currentTimeShellPgInput");$skipForwardShellPgBtn=document.getElementById("skipForwardShellPgBtn");$skipSizeShellPgInput=document.getElementById("skipSizeShellPgInput");$applyStopStartShellPgInput=document.getElementById("applyStopStartShellPgInput");$startAudioShellPgBtn=document.getElementById("startAudioShellPgBtn");$stopAudioShellPgBtn=document.getElementById("stopAudioShellPgBtn");$autoPlayShellPgInput=document.getElementById("autoPlayShellPgInput");$playNextShellPgInput=document.getElementById("playNextShellPgInput");$repeatShellPgInput=document.getElementById("repeatShellPgInput");$scrollToTopShellPgA=document.getElementById("scrollToTopShellPgA");$findInPageShellPgForm=document.getElementById("findInPageShellPgForm");$findInPageShellPgInput=document.getElementById("findInPageShellPgInput");$copyUrlShellPgA=document.getElementById("copyUrlShellPgA");$gotoPasteUrlShellPgA=document.getElementById("gotoPasteUrlShellPgA");$useTransferManageActionShellPgSelect=document.getElementById("useTransferManageActionShellPgSelect");$fileTransferManageActionShellPgInput=document.getElementById("fileTransferManageActionShellPgInput");$darkThemeShellPgBtn=document.getElementById("darkThemeShellPgBtn");$resetAppShellPgBtn=document.getElementById("resetAppShellPgBtn");$toastShellPgDiv=document.getElementById("toastShellPgDiv");$toastMsgShellPgDiv=document.getElementById("toastMsgShellPgDiv");$toastCloseShellPgBtn=document.getElementById("toastCloseShellPgBtn");$promptShellPgDiv=document.getElementById("promptShellPgDiv");$promptShellPgH3=document.getElementById("promptShellPgH3");$closePromptShellPgBtn=document.getElementById("closePromptShellPgBtn");$okayPromptShellPgBtn=document.getElementById("okayPromptShellPgBtn");$cancelPromptShellPgBtn=document.getElementById("cancelPromptShellPgBtn");$abortOfflineShellPgBtn=document.getElementById("abortOfflineShellPgBtn");$progrOfflineShellPgDiv=document.getElementById("progrOfflineShellPgDiv");$downloadSelsShellPgA=document.getElementById("downloadSelsShellPgA");$deleteSelsShellPgA=document.getElementById("deleteSelsShellPgA");$offlineInfoShellPgDiv=document.getElementById("offlineInfoShellPgDiv");$prevMenuShellPgA;promptHandler;toast;mainMenu;backgroundBlur;shell;constructor(e){this.shell=e}toggleSideMenuIfReqd(e=!0){if(getComputedStyle(this.$mainMenuShellPgBtn).display!=="none"){if(e&&!this.mainMenu.isVisible())return;this.mainMenu.toggle()?this.backgroundBlur.show():this.backgroundBlur.hide()}}bind(){let e=[];this._registerSideMenuListeners(e),this._registerTitlebarListeners(e),this._registerToastListeners(),this._registerPromptListeners()}_registerSideMenuListeners(e){this.mainMenu=new k(this.$mainMenuShellPgAside,"-translate-x-full",["transform-none"]),this.backgroundBlur=new k(this.$backdropShellPgDiv,"hidden",[],!0);let t=new k(this.$settingsDrpDnShellPgDiv),i=new E(this.$settingsDrpDnShellPgA,t,e);this.$settingsDrpDnShellPgA.addEventListener("click",i.clickHandler),this.$mainMenuShellPgBtn.addEventListener("click",s=>{this.toggleSideMenuIfReqd(!1)})}_registerTitlebarListeners(e){let t=new k(this.$audioDrpDnShellPgDiv),i=new E(this.$audioDrpDnShellPgBtn,t,e);this.$audioDrpDnShellPgBtn.addEventListener("click",i.clickHandler);let s=new k(this.$textDrpDnShellPgDiv),n=new E(this.$textDrpDnShellPgBtn,s,e);this.$textDrpDnShellPgBtn.addEventListener("click",n.clickHandler);let o=new k(this.$offlineDrpDnShellPgDiv),a=new E(this.$offlineDrpDnShellPgBtn,o,e);this.$offlineDrpDnShellPgBtn.addEventListener("click",a.clickHandler);let l=new k(this.$shareDrpDnShellPgDiv),c=new E(this.$shareDrpDnShellPgBtn,l,e);this.$shareDrpDnShellPgBtn.addEventListener("click",c.clickHandler)}_registerToastListeners(){this.toast=new k(this.$toastShellPgDiv),this.$toastCloseShellPgBtn.addEventListener("click",e=>{this.hideMessage()})}_registerPromptListeners(){this.prompt=new k(this.$promptShellPgDiv),this.prompt.onShow=()=>{this.backgroundBlur.show()},this.prompt.onHide=()=>{this.backgroundBlur.hide()},this.shell.eventRegistry.register(this.$closePromptShellPgBtn,"click",e=>{this.prompt.toggle()}),this.shell.eventRegistry.register(this.$cancelPromptShellPgBtn,"click",e=>{this.prompt.toggle()}),this.shell.eventRegistry.register(this.$okayPromptShellPgBtn,"click",async e=>{this.prompt.toggle(),this.promptHandler&&this.promptHandler(e)})}selectMenuItem(e){e&&(e.parentElement.className=C.SELECTED_CSS),this.$prevMenuShellPgA&&(this.$prevMenuShellPgA.parentElement.className=""),this.$prevMenuShellPgA=e}showMessage(e,t=3e3){this._clearMessageTimeout(),this.toast.show(),this.$toastMsgShellPgDiv.innerHTML=e,t>0&&(this.lastSbTimeoutHdl=setTimeout(()=>{this.hideMessage()},t))}hideMessage(){this.toast.hide(),this.$toastMsgShellPgDiv.innerHTML="",this._clearMessageTimeout()}_clearMessageTimeout(){this.lastSbTimeoutHdl||(clearTimeout(this.lastSbTimeoutHdl),this.lastSbTimeoutHdl=null)}showPrompt(e,t){this.$promptShellPgH3.innerHTML=e,this.promptHandler=t,this.prompt.show()}initialiseView(){this.$controlShellPgAudio.autoplay=this.shell.app.model.audioSettings.autoPlay,this.$autoPlayShellPgInput.checked=this.shell.app.model.audioSettings.autoPlay,this.$playNextShellPgInput.checked=this.shell.app.model.audioSettings.playNext,this.$repeatShellPgInput.checked=this.shell.app.model.audioSettings.repeat,this.$skipSizeShellPgInput.value=String(this.shell.app.model.audioSettings.skipSize),this.$applyStopStartShellPgInput.checked=this.shell.app.model.audioSettings.applyStopStartRange,this.$useTransferManageActionShellPgSelect.selectedIndex=this.shell.app.model.generalSettings.useTransfer,this.$currentTimeShellPgInput.step=this.$skipSizeShellPgInput.value,this.refreshMountedPlaylist(),this.refreshPlaybackRate(),this.refreshPlaylistControls(),this.refreshAudioPlaybackControls(),this.refreshPlayPause(),this.refreshUploadFileFromModel(),this.refreshDarkTheme()}refreshMountedPlaylist(){this.$steroTypeShellPgDiv.textContent=this.shell.model.playlist?.stereoType??"-"}refreshPlaybackRate(){let e=this.shell.app.model.audioSettings.playbackRate;this.$controlShellPgAudio.playbackRate=e,this.$playbackRateShellPgInput.value=String(e),this.$playbackRateShellPgLabel.textContent=`Rate: x${e}`}refreshStartStopRange(){this.$applyStopStartShellPgInput.checked?(this.$currentTimeShellPgInput.min=String(this.shell.model.startTime),this.$currentTimeShellPgInput.max=String(this.shell.model.stopTime),this.$startAudioShellPgBtn.textContent=this.shell.model.startTime.toFixed(2),this.$stopAudioShellPgBtn.textContent=this.shell.model.stopTime.toFixed(2),this.$controlShellPgAudio.currentTime<this.shell.model.startTime?this.$controlShellPgAudio.currentTime=this.shell.model.startTime:this.$controlShellPgAudio.currentTime>this.shell.model.stopTime&&(this.$controlShellPgAudio.currentTime=this.shell.model.stopTime)):(this.$currentTimeShellPgInput.min="0",this.$currentTimeShellPgInput.max=String(this.shell.model.trackModel.trackRecord.duration))}refreshPlaylistControls(){this.$prevTrackShellPgBtn.disabled=!this.shell.model.hasPrevious(),this.$nextTrackShellPgBtn.disabled=!this.shell.model.hasNext()}refreshAudioPlaybackControls(){let e=this.shell.model.audioState<3;this.$skipBackShellPgBtn.disabled=e,this.$playPauseToggleShellPgBtn.disabled=e,this.$skipForwardShellPgBtn.disabled=e,this.$applyStopStartShellPgInput.disabled=e}refreshPlayPause(){this.shell.model.audioState===4?(this.$playToggleShellSvg.classList.add("hidden"),this.$pauseToggleShellSvg.classList.remove("hidden")):(this.$playToggleShellSvg.classList.remove("hidden"),this.$pauseToggleShellSvg.classList.add("hidden"))}refreshOfflineElements(e){[this.$downloadSelsShellPgA,this.$deleteSelsShellPgA].forEach((i,s,n)=>{e?i.classList.add("pointer-events-none"):i.classList.remove("pointer-events-none")}),this.$abortOfflineShellPgBtn.disabled=!e}refreshUploadFileFromModel(){this.shell.app.model.generalSettings.useTransfer===0?this.$fileTransferManageActionShellPgInput.classList.add("hidden"):this.$fileTransferManageActionShellPgInput.classList.remove("hidden")}refreshDarkTheme(){let e=this.shell.app.model.generalSettings.darkTheme,t=document.getElementById("darkThemeToggleShellPgSvg"),i=document.getElementById("lightThemeToggleShellPgSvg");t.classList.add("hidden"),i.classList.add("hidden"),e?(t.classList.remove("hidden"),document.documentElement.classList.add("dark")):(i.classList.remove("hidden"),document.documentElement.classList.remove("dark"))}},Ut=class r{static MAX_WORKERS=5;trackRefs;isDownloadMode;shell;offlineAudioManagerWorkerClient;offlineAudioWorkerClients=[];constructor(e,t,i){this.shell=e,this.trackRefs=t,this.isDownloadMode=i}async setup(){let e=this.shell.app.appConfig.offlineAudioManagerWorker,t=new Worker(e.scriptURL,{...e,name:"offlineAudioManagerWorker"});this.offlineAudioManagerWorkerClient=new je(new J(t)),this.offlineAudioManagerWorkerClient.startClient();let i=[],s=[];for(let o=0;o<r.MAX_WORKERS;o++){let a=new MessageChannel,l=`cat_oamw_oaw_${o}`;i.push(l),s.push(a.port2);let c=this.shell.app.appConfig.offlineAudioWorker_n,m=new Worker(c.scriptURL,{...c,name:`offlineAudioWorker_${o}`}),f=new Je(new J(m));f.startClient();let S=await f.__transferPorts__({portIds:[l]},[a.port1]);this.offlineAudioWorkerClients.push(f)}let n=await this.offlineAudioManagerWorkerClient.__transferPorts__({portIds:i},s);await this.offlineAudioManagerWorkerClient.setup({portIds:i}),this._registerWorkerListeners()}async teardown(){this._unregisterWorkerListeners();for(let e=0;e<r.MAX_WORKERS;e++)await this.offlineAudioWorkerClients[e].stopClient();await this.offlineAudioManagerWorkerClient.teardown(),await this.offlineAudioManagerWorkerClient.stopClient(),this.trackRefs=null,this.shell=null,this.offlineAudioWorkerClients.length=0,this.offlineAudioManagerWorkerClient=null}_registerWorkerListeners(){this.offlineAudioManagerWorkerClient.onProgressUpdate_=async e=>{let t=parseInt(`${e.progress*100}`);this.shell.view.$progrOfflineShellPgDiv.style.width=`${t}%`},this.offlineAudioManagerWorkerClient.onFinished_=async e=>{this.shell.view.refreshOfflineElements(!1),this.shell.view.$abortOfflineShellPgBtn.textContent="Finished",this.shell.view.$offlineInfoShellPgDiv.innerText=`Processed: ${e.count}`,this.shell.view.$progrOfflineShellPgDiv.style.width="0%",this.shell.showMessage("Offline processing finished"),await this.shell._teardownCoordinator()};for(let e=0;e<r.MAX_WORKERS;e++)this.offlineAudioWorkerClients[e].onProcessed_=async t=>{this.shell.view.$offlineInfoShellPgDiv.innerText=t.trackRef,this.shell.offlineTrackRefJson[t.trackRef]=t.isInCache}}_unregisterWorkerListeners(){this.offlineAudioManagerWorkerClient.onProgressUpdate_=null,this.offlineAudioManagerWorkerClient.onFinished_=null;for(let e=0;e<r.MAX_WORKERS;e++)this.offlineAudioWorkerClients[e].onProcessed_=null}async process(){this.shell.offlineTrackRefJson={},this.shell.view.$abortOfflineShellPgBtn.textContent="Abort",this.shell.view.refreshOfflineElements(!0),this.isDownloadMode?this.offlineAudioManagerWorkerClient.downloadSelections({selections:this.trackRefs}):this.offlineAudioManagerWorkerClient.deleteSelections({selections:this.trackRefs})}};var it=class extends C{constructor(e,t,i,s){super(e,t,i,s,"sectionId/404","./templates/E404.html")}async canHandle(e){return!0}};var Ar=window.Prism,st=class extends C{constructor(e,t,i,s){super(e,t,i,s,"/about","./templates/about.html")}async setup(){await super.setup();let[e,t]=await A.loadTemplate("./templates/README.html"),i=document.getElementById("aboutPageArticle");i.innerHTML=e}};var L=class r{static DIACRITICS_CHR=["\u0101","\u012B","\u016B","\u1E41","\u1E43","\u1E47","\u1E45","\xF1","\u1E63","\u1E6D","\u1E0D","\u1E37","\u1E25"];static DIACRITICS_ALT=["a","i","u","m","m","n","n","n","s","t","d","l","h"];static allIndexesOf(e,t,i=!0){let s=[],n=t.length-1,o=-1,a=0;for(i&&(e=e.toLowerCase(),t=t.toLowerCase());(o=e.indexOf(t,a))>-1;)s.push([o,o+n]),a=o+1;return s}static allIndexOfUsingRegEx(e,t,i="gm"){let s=new RegExp(t,i),n,o=[];for(;(n=s.exec(e))!==null;)n.index===s.lastIndex&&s.lastIndex++,o.push([n.index,n.index+n[0].length-1]);return o}static allLinePositions(e,t){let i=0,s=0,n=[];for(let o=0;o<t.length;o++){let l=e.substring(i,t[o][0]).match(/\n/gm),c=l?l.length:0;o===0&&c++,c+=s,n.push(c),i=t[o][0]+1,s=c}return n}static surroundingTrim(e,t,i){let s=e.length;if(i>=s)return e;let n=Math.floor(i/2),o=t-n,a=t+n;return o<0&&(o=0,a=i),a>s-1&&(a=s,o=Math.max(0,a-i)),e.substring(o,a).trim()}static removeDiacritics(e){for(let t=0;t<r.DIACRITICS_CHR.length;t++)e=e.replaceAll(r.DIACRITICS_CHR[t],r.DIACRITICS_ALT[t]);return e}static replaceAllSequence(e,t){let i=e;for(let s=0;s<t.length;s++)i=i.replaceAll(t[s][0],t[s][1]);return i}static lineLengths(e,t){let i=e.split(`
`),s=[];t&&(t.length=0,t.push(0));for(let n=0;n<i.length;n++)s.push(i[n].length),t&&t.push(t[n]+s[n]+1);return s}static convertToRegExIfValid(e){let t={patternOrSearchExpr:e,ignoreDiacritics:!0,regExFlags:void 0},i=e.lastIndexOf("/");if(!e.startsWith("/")||i<=0)return t;let s=e.substring(1,i),n=e.substring(i+1);if(!/^[gmisdyvuD]*$/.test(n))return t;n.indexOf("D")>-1&&(t.ignoreDiacritics=!0,n=n.replace("D",""));try{let o=new RegExp(s,n);return t.patternOrSearchExpr=s,t.regExFlags=n,t}catch{return t}}static{[r.DIACRITICS_CHR,r.DIACRITICS_ALT].forEach((t,i,s)=>{t.forEach((n,o,a)=>{a.push(n.toUpperCase())})})}};var rt=class{static removeLeadingZeros(e){let t=!0,i=[];for(let s of e)(s!==0||!t)&&(t=!1,i.push(s));return i}};var re=class r{static secToHhMmSsMmmSegs(e){let t=[0,0,0],i=Math.floor(e),s=Math.floor((e-i)*1e3)/1e3,n=i/(60*60);n>1&&(t[0]=Math.floor(n));let o=(n-t[0])*60;return o>1&&(t[1]=Math.floor(o)),t[2]=Math.ceil((o-t[1])*60)+s,t}static secToHhMmSsMmm(e,t=!0){let i=r.secToHhMmSsMmmSegs(e);t&&(i=rt.removeLeadingZeros(i));let s=i.join(":");return s||(s="0"),s}static HhMmSsMmmToSec(e){let t=e.split(":"),i=0;for(let s=t.length-1,n=0;s>-1;s--,n++)i+=parseFloat(t[s])*Math.pow(60,n);return i}static secToMm(e,t=!0){let i=e/60;return t&&(i=Math.ceil(i)),i}};var G=class extends T{type="CatalogModel";selectedAlbum=0;transients=["transients","tracks","playlist"];tracks=[];playlist=new D(void 0,"C","Catalog tracks playlist");static toHref(e){return`#catalog?ref=${e}`}};var Zi="dhamma-initiative.github.io",Vt=`https://${Zi}`;var q=class{static queryTrackTextUrl(e){return`${Vt}/${e}.txt`}static queryTrackHtmlAudioSrcRef(e){return`${Vt}/${e}.wav.mp3`}static parseTrackRefElements(e){let t=e.replace(/^.*[\\\/]/,""),i=e.substring(0,e.length-t.length);return i.startsWith("/")&&(i=i.substring(1)),i.endsWith("/")&&(i=i.substring(0,i.length-1)),[i,t]}static jsonToQueryString(e,t){let i=new URLSearchParams;return Object.getOwnPropertyNames(e).forEach((o,a,l)=>{e[o]!==void 0&&(!t||t&&t[o]!==e[o])&&i.set(o,e[o])}),i.toString().replaceAll("%2C",",")}static getSearchParamValueAsFloat(e,t){let i=parseFloat(e);return isNaN(i)?t:i}};var W=class{static removeAllChildren(e){for(;e.firstChild;)e.firstChild.remove()}static isElementInViewport(e){let t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)}static getElementScreenCenterScrollTo(e,t=1){let i=e.scrollHeight,n=e.getBoundingClientRect().top+window.scrollY+i*t,o=window.innerHeight||document.documentElement.clientHeight;return n-o/2}};var qt=class{_delegate;constructor(e){this._delegate=e}_prepareFilter(){this._delegate&&this._delegate._prepareFilter()}applyToTrack(e){let t=!0;return this.isCheckRequired()&&(t=this.isMatched(e)),t&&this._delegate&&(t=this._delegate.applyToTrack(e)),t}apply(e,t){this._prepareFilter();for(let i=0;i<e.length;i++){let s=this.applyToTrack(e[i]);t(i,e[i],s)}}},He=class r extends qt{options;constructor(e,t){super(e),t?this.options=t:this.resetOptions()}resetOptions(){this.options=B.deepClone(this.getEmptyOptions()),this._delegate instanceof r&&this._delegate.resetOptions()}},nt=class r extends He{static EMPTY_FILTER={_9_19_29_39_49_50p:[!1,!1,!1,!1,!1,!1]};getEmptyOptions(){return r.EMPTY_FILTER}isCheckRequired(){return this.options._9_19_29_39_49_50p.indexOf(!0)>-1}isMatched(e){let t=Math.ceil(e.duration/60),i=Math.min(Math.floor(t/10),5);return this.options._9_19_29_39_49_50p[i]}},ot=class r extends He{static EMPTY_FILTER={cached_nonCached:[!1,!1]};getEmptyOptions(){return r.EMPTY_FILTER}isCheckRequired(){return this.options.cached_nonCached.indexOf(!0)>-1}isMatched(e){let t=e.isAudioCached?0:1;return!!this.options.cached_nonCached[t]}},at=class r extends He{static EMPTY_FILTER={title:"",ignoreDiacritics:!0,useRegEx:!1,regExFlags:""};getEmptyOptions(){return r.EMPTY_FILTER}isCheckRequired(){return this.options.title.length>0}isMatched(e){let t=this.options.cargo,i=`${e.trackRef} ${e.title}`,s=!1;if(this.options.ignoreDiacritics&&(i=L.removeDiacritics(i)),this.options.useRegEx)s=i.match(t)!==null;else{i=i.toLowerCase();let n=this.options.title.toLowerCase();s=i.indexOf(n)>-1}return s}_prepareFilter(){super._prepareFilter();let e=null;this.options.ignoreDiacritics&&(this.options.title=L.removeDiacritics(this.options.title)),this.options.useRegEx&&(e=new RegExp(this.options.title,this.options.regExFlags)),this.options.cargo=e}};var I=class r{static SELECTED_CSS="border-l-4 border-blue-600";static NON_SELECTED_CSS="border-b dark:border-gray-700";static CACHE_STATUS_COLOR_CSS=["bg-red-500","bg-green-500"];shell;eventRegistry;albumConfig;tracksConfig;filterConfig;audioCacheFilter=new ot(null);duraIntvFilter=new nt(this.audioCacheFilter);titleFilter=new at(this.duraIntvFilter);constructor(e,t,i,s,n){this.shell=e,this.eventRegistry=t,this.albumConfig=i,this.albumConfig.albumsPgSelectId&&(this.albumConfig.$albumsPgSelect=document.getElementById(this.albumConfig.albumsPgSelectId)),this.tracksConfig=s,this.tracksConfig.$tracksPgTbody=document.getElementById(this.tracksConfig.tracksPgTbodyId),this.tracksConfig.$selectAllTracksPgInput=document.getElementById(this.tracksConfig.selectAllTracksPgInputId),this.filterConfig=n,this.filterConfig.$critSrchPgForm=document.getElementById(this.filterConfig.titleFilterPgFormId),this.filterConfig.$critSrchPgInput=document.getElementById(this.filterConfig.titleFilterPgInputId),this.filterConfig.$resetFilterPgBtn=document.getElementById(this.filterConfig.resetFilterPgBtnId),this.filterConfig.$filterDrpDnPgDiv=document.getElementById(this.filterConfig.filterDrpDnPgDivId)}refreshTrackCacheInfo(e){for(let t=0;t<this.tracksConfig.trackRows.length;t++){let i=this.tracksConfig.trackRows[t];if(e[i.trackRef]!==void 0){i.isAudioCached=e[i.trackRef];let s=this.tracksConfig.$tracksPgTbody.querySelector(`span[data-cache-flag-trackref="${i.trackRef}"]`);s.classList.remove(r.CACHE_STATUS_COLOR_CSS[0]),s.classList.remove(r.CACHE_STATUS_COLOR_CSS[1]);let n=r.CACHE_STATUS_COLOR_CSS[i.isAudioCached?1:0];s.classList.add(n)}}}registerListeners(){this.eventRegistry.register(this.filterConfig.$critSrchPgForm,"submit",e=>{e.preventDefault(),this._onFilterTextElemChange(e),this.applyFilter()}),this.eventRegistry.register(this.tracksConfig.$selectAllTracksPgInput,"change",e=>{this.selectAll(this.tracksConfig.$selectAllTracksPgInput.checked)}),this.eventRegistry.register(this.filterConfig.$resetFilterPgBtn,"click",e=>{this.titleFilter.resetOptions(),this._resetFilterViews(),this.applyFilter()}),this.eventRegistry.register(this.filterConfig.$filterDrpDnPgDiv,"change",e=>{this._onFilterDrpDnElemChange(e)}),this.tracksConfig.trackRowClickClosestElemType&&this.eventRegistry.register(this.tracksConfig.$tracksPgTbody,"click",e=>{this._onTableRowClick(e)})}_onTableRowClick(e){let t=e.target;t instanceof HTMLTableRowElement||(t=t.closest(this.tracksConfig.trackRowClickClosestElemType)),t&&t.localName===this.tracksConfig.trackRowClickClosestElemType?this.tracksConfig.onTrackRowClick(e,t):(t=e.target.closest("tr"),t&&this.tracksConfig.onTrackRowClick(e,t))}_onFilterDrpDnElemChange(e){if(e.target instanceof HTMLInputElement&&e.target.type==="checkbox"){let t=e.target.getAttribute("data-filter-dur"),i=t?this.duraIntvFilter.options._9_19_29_39_49_50p:this.audioCacheFilter.options.cached_nonCached;t||(t=e.target.getAttribute("data-filter-cache")),i[parseInt(t)]=e.target.checked,this.applyFilter()}}_onFilterTextElemChange(e){let t=this.filterConfig.$critSrchPgInput.value,i=L.convertToRegExIfValid(t);this.titleFilter.options.useRegEx=i.regExFlags!==void 0,this.titleFilter.options.regExFlags=i.regExFlags,this.titleFilter.options.title=i.patternOrSearchExpr}showHideTableRow(e,t){let i=document.getElementById(e);return t?i.classList.remove("hidden"):i.classList.add("hidden"),i}uncheckFilteredOutSelections(e,t){let i=document.getElementById(e);!t&&i.checked&&(i.checked=!1)}applyFilter(e){let t=e??this.tracksConfig.trackRows;this.titleFilter.apply(t,(i,s,n)=>{e&&(i=this.tracksConfig.trackRows.length-1);let o=`${i}.${this.tracksConfig.rowTableId}`,a=this.showHideTableRow(o,n),l=parseInt(a.getAttribute("data-cols"));if(l)for(let c=0;c<l;c++){let m=`${i}.${c}.${this.tracksConfig.rowColTableId}`,f=this.showHideTableRow(m,n),S=`${i}.${c}.${this.tracksConfig.rowColCheckboxId}`;this.uncheckFilteredOutSelections(S,n)}else{let c=`${i}.${this.tracksConfig.rowCheckboxId}`;this.uncheckFilteredOutSelections(c,n)}})}_resetFilterViews(){this.filterConfig.$critSrchPgInput.value=this.titleFilter.options.title,this.filterConfig.$filterDrpDnPgDiv.querySelectorAll("input[data-filter-dur]").forEach((e,t)=>{let i=parseInt(e.getAttribute("data-filter-dur"));e.checked=this.duraIntvFilter.options._9_19_29_39_49_50p[i]}),this.filterConfig.$filterDrpDnPgDiv.querySelectorAll("input[data-filter-cache]").forEach((e,t)=>{let i=parseInt(e.getAttribute("data-filter-cache"));e.checked=this.audioCacheFilter.options.cached_nonCached[i]})}selectAll(e){this.tracksConfig.$tracksPgTbody.childNodes.forEach((t,i)=>{if(t instanceof HTMLTableRowElement&&t.getAttribute("data-tr-type")==="body"){let n=t.getAttribute("data-row"),o=t.getAttribute("data-col");if(!t.classList.contains("hidden")){let a=o?`${n}.${o}.${this.tracksConfig.rowColCheckboxId}`:`${n}.${this.tracksConfig.rowCheckboxId}`,l=document.getElementById(a);l.checked=e}}})}getRowColSelections(){let e=this.tracksConfig.$tracksPgTbody.querySelectorAll('input[type="checkbox"]:checked');return Array.from(e).map(s=>{let n=[parseInt(s.getAttribute("data-row"))];return this.tracksConfig.rowColCheckboxId&&n.push(parseInt(s.getAttribute("data-col"))),n}).filter(s=>s!==null)}loadAlbums(){let e=this.shell.app.catalog;for(let t=0;t<e.length;t++){let i=document.createElement("option");i.value=e[t].id,i.setAttribute("data-album-index",String(e[t].index)),i.setAttribute("data-album-size",String(e[t].size)),i.innerHTML=e[t].name,this.albumConfig.$albumsPgSelect.append(i)}}};var lt=class extends C{model;view;filterAdapter;constructor(e,t,i,s){super(e,t,i,s,"/catalog","./templates/catalog.html"),this.model=this.app.model.catalog}onTrackListIndexChange(e,t,i){let s=G.toHref(this.model.playlist.selectedPlaylistItem.trackRef);this.app.catalogPage.$menuItem.href=s,this.view.selectTableRowTrack(this.model.playlist.getSelectionItem(),void 0)}async setup(){await super.setup(),this._setupFilterAdapter(),this.view=new fe(this),await this.view.loadTableRowTemplates(),this._registerListeners(),await this._initialiseView()}async _onShow(e){let t=e.urlRoute.searchParams.get("ref");t?await this.view.select(t):this.view.selectTableRowTrack(this.model.playlist.getSelectionItem(),void 0),super._onShow(e)}getTrackSelections(){let e=[];return this.filterAdapter.getRowColSelections().forEach((i,s,n)=>{let o=this.model.tracks[i[0]].trackRef;e.push(o)}),e}async onAfterOfflineProcessing(e){this.isViewLoaded&&this.filterAdapter.refreshTrackCacheInfo(e)}async refreshView(){await this.view.loadTableRowTracks(this.model.selectedAlbum,!0),this.view.selectTableRowTrack(this.model.playlist.getSelectionItem(),void 0)}_setupFilterAdapter(){this.filterAdapter=new I(this.shell,this.eventRegistry,fe.ALBUM_CFG,fe.TRACKS_CFG,fe.FILTER_CFG),this.filterAdapter.tracksConfig.trackRows=this.model.tracks,this.filterAdapter.tracksConfig.onTrackRowClick=(e,t)=>{let i=t.getAttribute("data-trackref");this.view.selectTableRowTrack(void 0,i),e.target.localName==="a"&&this.app.model.shell.mount(this.model.playlist,this),i&&this.setLocationHash(G.toHref(i),!0)}}async _initialiseView(){let e=[],t=new k(this.view.$actionsDrpDnCatPgDiv),i=new E(this.view.$actionsDrpDnCatPgBtn,t,e);this.eventRegistry.register(this.view.$actionsDrpDnCatPgBtn,"click",i.clickHandler);let s=new k(this.view.$filterDrpDnCatPgDiv),n=new E(this.view.$filterDrpDnCatPgBtn,s,e);this.eventRegistry.register(this.view.$filterDrpDnCatPgBtn,"click",n.clickHandler),this.filterAdapter.loadAlbums(),this.filterAdapter.albumConfig.$albumsPgSelect.selectedIndex=this.model.selectedAlbum,await this.refreshView()}_registerListeners(){this.filterAdapter.registerListeners(),this.eventRegistry.register(this.filterAdapter.albumConfig.$albumsPgSelect,"change",e=>{let t=this.app.catalog[this.filterAdapter.albumConfig.$albumsPgSelect.selectedIndex].id,i=G.toHref(t);this.setLocationHash(i,!0)}),this.eventRegistry.register(this.view.$copyActionCatPgA,"click",e=>{e.preventDefault(),this._onCopySelectionsClick(e)}),this.eventRegistry.register(this.view.$gotoActiveActionCatPgA,"click",e=>{e.preventDefault(),this._onGotoActiveSelectionClick(e)}),this.eventRegistry.register(this.view.$randomActionCatPgA,"click",async e=>{e.preventDefault(),this._onSelectRandomTrackClick(e)})}_onCopySelectionsClick(e){let t=this.filterAdapter.getRowColSelections();if(t.length===0){this.shell.showMessage("No selections have been made!");return}let i=[];t.forEach((s,n,o)=>{let a=this.model.tracks[s[0]].trackRef;i.push({trackRef:a})}),this.shell.addBookmarks(i)}_onGotoActiveSelectionClick(e){this.view.$prevSelectionTr&&(this.scrollYPos=W.getElementScreenCenterScrollTo(this.view.$prevSelectionTr),this.moveToScrollPosition({urlRoute:A.currentUrlRoute,restorePosition:!0}))}async _onSelectRandomTrackClick(e){let t=Math.floor(Math.random()*(this.app.catalog.length-1)),i=Math.floor(Math.random()*(this.app.catalog[t].size-1)),n=(await this.app.albumStoreWorkerClient.selectAllTracksForAlbumWhere({albumIdx:t})).tracks[i].trackRef,o=this.scrollYPos;await this.view.select(n),o!==this.scrollYPos&&this.moveToScrollPosition({urlRoute:A.currentUrlRoute,restorePosition:!0})}},fe=class r{static ROW_TMPL_HTML;static ALBUM_CFG={albumsPgSelectId:"albumsCatPgSelect"};static TRACKS_CFG={tracksPgTbodyId:"tracksCatPgTbody",rowTableId:"trackCatPgTr",rowCheckboxId:"trackCatPgInput",rowColTableId:null,rowColCheckboxId:null,selectAllTracksPgInputId:"selectAllTracksCatPgInput",trackRowClickClosestElemType:"tr"};static FILTER_CFG={titleFilterPgFormId:"titleFilterCatPgForm",titleFilterPgInputId:"titleFilterCatPgInput",resetFilterPgBtnId:"resetFilterCatPgBtn",filterDrpDnPgDivId:"filterDrpDnCatPgDiv"};$actionsDrpDnCatPgBtn=document.getElementById("actionsDrpDnCatPgBtn");$actionsDrpDnCatPgDiv=document.getElementById("actionsDrpDnCatPgDiv");$filterDrpDnCatPgBtn=document.getElementById("filterDrpDnCatPgBtn");$filterDrpDnCatPgDiv=document.getElementById("filterDrpDnCatPgDiv");$copyActionCatPgA=document.getElementById("copyActionCatPgA");$gotoActiveActionCatPgA=document.getElementById("gotoActiveActionCatPgA");$randomActionCatPgA=document.getElementById("randomActionCatPgA");$prevSelectionTr;controller;prevAlbIdx=-1;constructor(e){this.controller=e}async select(e){let t=this.controller.filterAdapter.albumConfig.$albumsPgSelect.querySelector(`option[value="${e}"]`);if(!t){let i=q.parseTrackRefElements(e);t=this.controller.filterAdapter.albumConfig.$albumsPgSelect.querySelector(`option[value="${i[0]}"]`)}if(t){let i=parseInt(t.getAttribute("data-album-index"));this.controller.model.selectedAlbum!==i&&(this.controller.model.selectedAlbum=i,this.controller.filterAdapter.albumConfig.$albumsPgSelect.selectedIndex=i,await this.loadTableRowTracks(i),this.controller.filterAdapter.applyFilter())}this.selectTableRowTrack(void 0,e)||this.selectTableRowTrack(this.controller.model.playlist.getSelectionItem(),void 0)}selectTableRowTrack(e,t){let i=t?`tr[data-trackref="${t}"]`:`tr[data-row="${e}"]`,s=this.controller.filterAdapter.tracksConfig.$tracksPgTbody.querySelector(i);return s&&(t&&(e=parseInt(s.getAttribute("data-row"))),this.$prevSelectionTr&&(this.$prevSelectionTr.className=I.NON_SELECTED_CSS),this.$prevSelectionTr=s,this.$prevSelectionTr.className=I.SELECTED_CSS,this.controller.model.playlist.setSelectionItem(e),!W.isElementInViewport(this.$prevSelectionTr)&&this.controller.visitations===1&&this.controller.setScrollPosition(void 0,W.getElementScreenCenterScrollTo(this.$prevSelectionTr))),s!==null}async loadTableRowTemplates(){let[e,t]=await A.loadTemplate("./templates/catalog.tracksCatPgTbody.trackCatPgTr.html");r.ROW_TMPL_HTML=e}async loadTableRowTracks(e,t=!1){let i=await this.controller.shell.app.albumStoreWorkerClient.selectAllTracksForAlbumWhere({albumIdx:e,forceRefresh:t});this._setTrackSource(i.tracks),W.removeAllChildren(this.controller.filterAdapter.tracksConfig.$tracksPgTbody);for(let s=0;s<i.tracks.length;s++){let n=this._prepareRow(i.tracks[s]),o=document.createElement("tr");this.controller.filterAdapter.tracksConfig.$tracksPgTbody.append(o),o.outerHTML=n;let a=new H;a.trackRef=i.tracks[s].trackRef}this.$prevSelectionTr=null,this.prevAlbIdx=e,this.controller.visitations=1}_setTrackSource(e){this.controller.model.tracks=e,this.controller.filterAdapter.tracksConfig.trackRows=e,this.controller.model.playlist.load(e,-1)}_prepareRow(e){let t=[["$ROW",`${e.index}`],["$TRACKREF",e.trackRef],["$TITLE",e.title],["$CACHE_STATUS_COLOR",I.CACHE_STATUS_COLOR_CSS[e.isAudioCached?1:0]],["$DUR",`${re.secToMm(e.duration)}`]];return L.replaceAllSequence(r.ROW_TMPL_HTML,t)}};var hn=window.Prism,ct=class extends C{constructor(e,t,i,s){super(e,t,i,s,"/help","./templates/help.html")}async setup(){await super.setup();let[e,t]=await A.loadTemplate("./templates/help-intro.html"),i=document.getElementById("helpPageArticle");i.innerHTML=e}};var wi;(function(r){"use strict";var e=function(){function i(){this._dropEffect="move",this._effectAllowed="all",this._data={}}return Object.defineProperty(i.prototype,"dropEffect",{get:function(){return this._dropEffect},set:function(s){this._dropEffect=s},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"effectAllowed",{get:function(){return this._effectAllowed},set:function(s){this._effectAllowed=s},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"types",{get:function(){return Object.keys(this._data)},enumerable:!0,configurable:!0}),i.prototype.clearData=function(s){s!=null?delete this._data[s]:this._data=null},i.prototype.getData=function(s){return this._data[s]||""},i.prototype.setData=function(s,n){this._data[s]=n},i.prototype.setDragImage=function(s,n,o){var a=t._instance;a._imgCustom=s,a._imgOffset={x:n,y:o}},i}();r.DataTransfer=e;var t=function(){function i(){if(this._lastClick=0,i._instance)throw"DragDropTouch instance already created.";var s=!1;if(document.addEventListener("test",function(){},{get passive(){return s=!0,!0}}),"ontouchstart"in document){var n=document,o=this._touchstart.bind(this),a=this._touchmove.bind(this),l=this._touchend.bind(this),c=s?{passive:!1,capture:!1}:!1;n.addEventListener("touchstart",o,c),n.addEventListener("touchmove",a,c),n.addEventListener("touchend",l),n.addEventListener("touchcancel",l)}}return i.getInstance=function(){return i._instance},i.prototype._touchstart=function(s){var n=this;if(this._shouldHandle(s)){if(Date.now()-this._lastClick<i._DBLCLICK&&this._dispatchEvent(s,"dblclick",s.target)){s.cancelable&&s.preventDefault(),this._reset();return}this._reset();var o=this._closestDraggable(s.target);o&&!this._dispatchEvent(s,"mousemove",s.target)&&!this._dispatchEvent(s,"mousedown",s.target)&&(this._dragSource=o,this._ptDown=this._getPoint(s),this._lastTouch=s,s.cancelable&&s.preventDefault(),setTimeout(function(){n._dragSource==o&&n._img==null&&n._dispatchEvent(s,"contextmenu",o)&&n._reset()},i._CTXMENU),i._ISPRESSHOLDMODE&&(this._pressHoldInterval=setTimeout(function(){n._isDragEnabled=!0,n._touchmove(s)},i._PRESSHOLDAWAIT)))}},i.prototype._touchmove=function(s){if(this._shouldCancelPressHoldMove(s)){this._reset();return}if(this._shouldHandleMove(s)||this._shouldHandlePressHoldMove(s)){var n=this._getTarget(s);if(this._dispatchEvent(s,"mousemove",n)){this._lastTouch=s,s.cancelable&&s.preventDefault();return}this._dragSource&&!this._img&&this._shouldStartDragging(s)&&(this._dispatchEvent(s,"dragstart",this._dragSource),this._createImage(s),this._dispatchEvent(s,"dragenter",n)),this._img&&(this._lastTouch=s,s.cancelable&&s.preventDefault(),n!=this._lastTarget&&(this._dispatchEvent(this._lastTouch,"dragleave",this._lastTarget),this._dispatchEvent(s,"dragenter",n),this._lastTarget=n),this._moveImage(s),this._isDropZone=this._dispatchEvent(s,"dragover",n))}},i.prototype._touchend=function(s){if(this._shouldHandle(s)){if(this._dispatchEvent(this._lastTouch,"mouseup",s.target)){s.cancelable&&s.preventDefault();return}this._img||(this._dragSource=null,this._dispatchEvent(this._lastTouch,"click",s.target),this._lastClick=Date.now()),this._destroyImage(),this._dragSource&&(s.type.indexOf("cancel")<0&&this._isDropZone&&this._dispatchEvent(this._lastTouch,"drop",this._lastTarget),this._dispatchEvent(this._lastTouch,"dragend",this._dragSource),this._reset())}},i.prototype._shouldHandle=function(s){return s&&!s.defaultPrevented&&s.touches&&s.touches.length<2},i.prototype._shouldHandleMove=function(s){return!i._ISPRESSHOLDMODE&&this._shouldHandle(s)},i.prototype._shouldHandlePressHoldMove=function(s){return i._ISPRESSHOLDMODE&&this._isDragEnabled&&s&&s.touches&&s.touches.length},i.prototype._shouldCancelPressHoldMove=function(s){return i._ISPRESSHOLDMODE&&!this._isDragEnabled&&this._getDelta(s)>i._PRESSHOLDMARGIN},i.prototype._shouldStartDragging=function(s){var n=this._getDelta(s);return n>i._THRESHOLD||i._ISPRESSHOLDMODE&&n>=i._PRESSHOLDTHRESHOLD},i.prototype._reset=function(){this._destroyImage(),this._dragSource=null,this._lastTouch=null,this._lastTarget=null,this._ptDown=null,this._isDragEnabled=!1,this._isDropZone=!1,this._dataTransfer=new e,clearInterval(this._pressHoldInterval)},i.prototype._getPoint=function(s,n){return s&&s.touches&&(s=s.touches[0]),{x:n?s.pageX:s.clientX,y:n?s.pageY:s.clientY}},i.prototype._getDelta=function(s){if(i._ISPRESSHOLDMODE&&!this._ptDown)return 0;var n=this._getPoint(s);return Math.abs(n.x-this._ptDown.x)+Math.abs(n.y-this._ptDown.y)},i.prototype._getTarget=function(s){for(var n=this._getPoint(s),o=document.elementFromPoint(n.x,n.y);o&&getComputedStyle(o).pointerEvents=="none";)o=o.parentElement;return o},i.prototype._createImage=function(s){this._img&&this._destroyImage();var n=this._imgCustom||this._dragSource;if(this._img=n.cloneNode(!0),this._copyStyle(n,this._img),this._img.style.top=this._img.style.left="-9999px",!this._imgCustom){var o=n.getBoundingClientRect(),a=this._getPoint(s);this._imgOffset={x:a.x-o.left,y:a.y-o.top},this._img.style.opacity=i._OPACITY.toString()}this._moveImage(s),document.body.appendChild(this._img)},i.prototype._destroyImage=function(){this._img&&this._img.parentElement&&this._img.parentElement.removeChild(this._img),this._img=null,this._imgCustom=null},i.prototype._moveImage=function(s){var n=this;requestAnimationFrame(function(){if(n._img){var o=n._getPoint(s,!0),a=n._img.style;a.position="absolute",a.pointerEvents="none",a.zIndex="999999",a.left=Math.round(o.x-n._imgOffset.x)+"px",a.top=Math.round(o.y-n._imgOffset.y)+"px"}})},i.prototype._copyProps=function(s,n,o){for(var a=0;a<o.length;a++){var l=o[a];s[l]=n[l]}},i.prototype._copyStyle=function(s,n){if(i._rmvAtts.forEach(function(f){n.removeAttribute(f)}),s instanceof HTMLCanvasElement){var o=s,a=n;a.width=o.width,a.height=o.height,a.getContext("2d").drawImage(o,0,0)}for(var l=getComputedStyle(s),c=0;c<l.length;c++){var m=l[c];m.indexOf("transition")<0&&(n.style[m]=l[m])}n.style.pointerEvents="none";for(var c=0;c<s.children.length;c++)this._copyStyle(s.children[c],n.children[c])},i.prototype._dispatchEvent=function(s,n,o){if(s&&o){var a=document.createEvent("Event"),l=s.touches?s.touches[0]:s;return a.initEvent(n,!0,!0),a.button=0,a.which=a.buttons=1,this._copyProps(a,s,i._kbdProps),this._copyProps(a,l,i._ptProps),a.dataTransfer=this._dataTransfer,o.dispatchEvent(a),a.defaultPrevented}return!1},i.prototype._closestDraggable=function(s){for(;s;s=s.parentElement)if(s.hasAttribute("draggable")&&s.draggable)return s;return null},i}();t._instance=new t,t._THRESHOLD=5,t._OPACITY=.5,t._DBLCLICK=500,t._CTXMENU=900,t._ISPRESSHOLDMODE=!1,t._PRESSHOLDAWAIT=400,t._PRESSHOLDMARGIN=25,t._PRESSHOLDTHRESHOLD=0,t._rmvAtts="id,class,style,draggable".split(","),t._kbdProps="altKey,ctrlKey,metaKey,shiftKey".split(","),t._ptProps="pageX,pageY,clientX,clientY,screenX,screenY".split(","),r.DragDropTouch=t})(wi||(wi={}));var ht=class extends C{model;newPlaylistItem;view;filterAdapter;jsonLocalStore=new U(new Y);constructor(e,t,i,s){super(e,t,i,s,"/playlist","./templates/playlist.html"),this.model=this.app.model.playlists}getTrackSelections(){let e=[],[t,i]=this._getBookmarkSelections();return i.forEach((s,n,o)=>{e.indexOf(s.trackRef)===-1&&e.push(s.trackRef)}),e}async onAfterOfflineProcessing(e){this.isViewLoaded&&this.filterAdapter.refreshTrackCacheInfo(e)}onTrackListIndexChange(e,t,i){let s=this.view.getTableRow(i);this.view.selectListItem(null,s,!1),this.app.model.shell.playlist.setSelectionItem(this.model.selectedPlaylist.getSelectionItem())}async setup(){await super.setup(),this._setupFilterAdapter(),this.view=new Pe(this),await this.view.loadTableRowTemplates(),this._registerListeners(),this._registerDragDrop(),await this._initialiseView()}_setupFilterAdapter(){this.filterAdapter=new I(this.shell,this.eventRegistry,Pe.ALBUM_CFG,Pe.TRACKS_CFG,Pe.FILTER_CFG),this.filterAdapter.tracksConfig.trackRows=[...this.model.tracks],this.filterAdapter.tracksConfig.onTrackRowClick=(e,t)=>{let i=e.target.localName==="a";this.view.selectListItem(e,t,i),i&&this.app.model.shell.mount(this.model.selectedPlaylist,this)}}async _initialiseView(){let e=[],t=new k(this.view.$actionsDrpDnPlayPgDiv),i=new E(this.view.$actionsDrpDnPlayPgBtn,t,e);this.eventRegistry.register(this.view.$actionsDrpDnPlayPgBtn,"click",i.clickHandler);let s=new k(this.view.$filterDrpDnPlayPgDiv),n=new E(this.view.$filterDrpDnPlayPgBtn,s,e);this.eventRegistry.register(this.view.$filterDrpDnPlayPgBtn,"click",n.clickHandler);let o=new k(this.view.$manageDrpDnPlayPgDiv,"hidden",["block"]),a=new E(this.view.$manageDrpDnPlayPgBtn,o,e);this.eventRegistry.register(this.view.$manageDrpDnPlayPgBtn,"click",a.clickHandler),await this._refreshView()}async _refreshView(){this.view.refreshPlaylistsSelectElement();let e=this.model.getSelectedId();this.view.restoreListFromModel(e),this.model.selectedPlaylist=await this.model.loadList(this.jsonLocalStore,e),await this.view.loadTableRowPlaylist()}_registerListeners(){this.filterAdapter.registerListeners(),this.eventRegistry.register(this.view.$playlistPlayPgSelect,"change",async e=>{let t=this.model.setSelectedIndex(parseInt(this.view.$playlistPlayPgSelect.value));this.model.selectedPlaylist=await this.model.loadList(this.jsonLocalStore,t),await this.view.loadTableRowPlaylist()}),this.eventRegistry.register(this.view.$listEntryPlayPgForm,"submit",async e=>{e.preventDefault(),await this._onSaveSubmit()}),this.eventRegistry.register(this.view.$removeManageActionPlayPgA,"click",e=>{e.preventDefault(),this._onRemovePlaylistClick()}),this.eventRegistry.register(this.view.$purgeAllManageActionPlayPgA,"click",e=>{e.preventDefault(),this._onPurgeAllPlaylistsClick()}),this.eventRegistry.register(this.view.$newItemActionPlayPgA,"click",e=>{e.preventDefault(),this._onNewlistClick()}),this.eventRegistry.register(this.view.$editItemActionPlayPgA,"click",e=>{e.preventDefault(),this._onEditListClick()}),this.eventRegistry.register(this.view.$copyActionPlayPgA,"click",e=>{e.preventDefault(),this._onCopySelectionsClick()}),this.eventRegistry.register(this.view.$gotoActiveActionPlayPgA,"click",e=>{e.preventDefault(),this._onGotoActiveSelectionClick(e)}),this.eventRegistry.register(this.view.$pasteActionPlayPgA,"click",async e=>{e.preventDefault(),await this._onPasteBookmarksClick()}),this.eventRegistry.register(this.view.$importManageActionPlayPgA,"click",async e=>{e.preventDefault(),await this._onImportFromClick()}),this.eventRegistry.register(this.view.$exportManageActionPlayPgA,"click",async e=>{e.preventDefault(),await this._onExportToClick()}),this.eventRegistry.register(this.view.$restoreAllManageActionPlayPgA,"click",async e=>{e.preventDefault(),await this._onRestoreAllFromClick()}),this.eventRegistry.register(this.view.$backupAllManageActionPlayPgA,"click",async e=>{e.preventDefault(),await this._onBackupAllToClick()}),this.eventRegistry.register(this.view.$deleteActionPlayPgA,"click",async e=>{e.preventDefault(),await this._onDeleteSelectionsClick()}),this.eventRegistry.register(this.view.$saveModalEditPlayPgBtn,"click",async e=>{await this._onModalSaveClick()}),this.eventRegistry.register(this.view.$pasteBookmarkEditPlayPgBtn,"click",e=>{this._onModalPasteClick()}),this.eventRegistry.register(this.view.$closeModalPlayPgBtn,"click",e=>{this.view.updateTrackModal.toggle()})}async _onImportFromClick(){let e=this._getBasePersistenceSourceForRead();if(e===null)return;let t=new le(e),i=new D,s=i.id;try{await i.restore(t),i.id=s,this.model.addPlaylist(i),this.model.setSelectedIndex(this.model.listIds.length-1),await this.model.save(this.jsonLocalStore),await i.save(this.jsonLocalStore),await this.jsonLocalStore.commit(),this.model.selectedPlaylist=await this.model.loadList(this.jsonLocalStore,s),await this._refreshView()}catch(n){console.error(n),this._showPersistenceMessage("Playlist in ${source} is invalid for import");return}this._showPersistenceMessage(`Playlist[${i.name}] was imported from \${source}`)}_getBasePersistenceSourceForRead(){let e=null;return this.app.model.generalSettings.useTransfer===0?ae.isReadAvailable()?e=this.shell.clipboardStore:this._showPersistenceMessage("Platform does not support reading from ${source}"):e=this.shell.fileStore,e}_showPersistenceMessage(e){let t=this.app.model.generalSettings.useTransfer===0?"clipboard":"file",i=e.replaceAll("${source}",t);this.app.shell.showMessage(i)}async _onRestoreAllFromClick(){let e=this._getBasePersistenceSourceForRead();if(e===null)return;let t=this.app.model.generalSettings.useTransfer===0?"clipboard":"file";this.shell.showPrompt(`Are you sure you want to restore backup from ${t}?`,async i=>{await this._onRestoreConfirmed(e)})}async _onRestoreConfirmed(e){let t=new le(e,!0),i=new ge;try{await i.restore(t);for(let s=0;s<i.listIds.length;s++){let n=await i.loadList(t,i.listIds[s]);this.model.addPlaylist(n),await n.save(this.jsonLocalStore),await this.jsonLocalStore.commit()}if(i.listIds.length>0){let s=this.model.listIds.indexOf(i.listIds[0]);this.model.setSelectedIndex(s)}await this.model.save(this.jsonLocalStore),await this.jsonLocalStore.commit()}catch(s){console.error(s),this._showPersistenceMessage("Playlists in ${source} are invalid for restoration");return}await this._refreshView(),this._showPersistenceMessage("Playlists were restored from ${source}")}async _onBackupAllToClick(){if(this.model.listIds.length===0){this.app.shell.showMessage("There are no playlists to export");return}let e=this.app.model.generalSettings.useTransfer===0?this.shell.clipboardStore:this.shell.fileStore,t=new le(e);try{this.app.model.generalSettings.useTransfer===1&&(this.shell.fileStore.baseFilename="suttaplayer-backup"),await this.model.save(t);for(let i=0;i<this.model.listIds.length;i++)await(await this.model.loadList(this.jsonLocalStore,this.model.listIds[i])).save(t);await t.commit()}catch{this.app.shell.showMessage("Content is invalid for import");return}this._showPersistenceMessage("All Playlists were backed up to ${source}")}async _onExportToClick(){if(!this.model.selectedPlaylist){this.app.shell.showMessage("Select a playlist to export first");return}let e=this.app.model.generalSettings.useTransfer===0?this.shell.clipboardStore:this.shell.fileStore,t=new le(e),i=this.model.selectedPlaylist;this.app.model.generalSettings.useTransfer===1&&(this.shell.fileStore.baseFilename=`suttaplayer-${i.name}`),await i.save(t),await t.commit(),this._showPersistenceMessage(`Playlist[${i.name}] was export to \${source}`)}_onModalPasteClick(){let e=this.shell.bookmarks[Math.max(0,this.shell.bookmarks.length-1)];e&&this.view.restoreListItem(e)}async _onModalSaveClick(){let e=this.newPlaylistItem??this.model.selectedPlaylist.selectedPlaylistItem;if(this.view.saveListItemToModel(e),(await this.app.albumStoreWorkerClient.selectTrackWhere({trackRef:e.trackRef})).track===void 0){let i=`${e.trackRef} is an invalid track reference`;throw this.shell.showMessage(i,0),new Error(i)}this.newPlaylistItem&&(this.model.selectedPlaylist.items.push(e),this.model.selectedPlaylist.selectedPlaylistItem=e),await this._saveSelectedPlaylist(),await this.view.loadTableRowPlaylist(),this.view.updateTrackModal.toggle()}async _onDeleteSelectionsClick(){let[e,t]=this._getBookmarkSelections();if(e.length===0){this.shell.showMessage("No selections have been made to delete!");return}this.shell.showPrompt(`Are you sure you want to delete the ${e.length} selections?`,async i=>{for(let s=e.length-1;s>-1;s--)this.model.selectedPlaylist.items.splice(e[s][0],1);await this._saveSelectedPlaylist(),await this.view.loadTableRowPlaylist()})}async _onPasteBookmarksClick(){if(this.shell.bookmarks.length===0){this.shell.showMessage("No bookmarks copied to paste");return}this.shell.bookmarks.forEach((t,i,s)=>{let n=new H;n.assignFrom(t),this.model.selectedPlaylist.items.push(n)});let e=await this._saveSelectedPlaylist();this.shell.bookmarks.length>0&&this.shell.showMessage(`${this.shell.bookmarks.length} saved bookmark(s) added!`),e?await this._refreshView():await this.view.loadTableRowPlaylist()}_onCopySelectionsClick(){let[e,t]=this._getBookmarkSelections();if(e.length===0){this.shell.showMessage("No selections have been made!");return}this.shell.addBookmarks(t)}_onGotoActiveSelectionClick(e){this.view.$prevSelectionTr&&(this.scrollYPos=W.getElementScreenCenterScrollTo(this.view.$prevSelectionTr),this.moveToScrollPosition({urlRoute:A.currentUrlRoute,restorePosition:!0}))}_onEditListClick(){if(!this.model.selectedPlaylist?.selectedPlaylistItem){this.shell.showMessage("Click on a row 1st to select the playlist item");return}this.view.restoreListItem(this.model.selectedPlaylist.selectedPlaylistItem),this.view.updateTrackModal.toggle()}_onNewlistClick(){this.newPlaylistItem=new H,this.view.restoreListItem(this.newPlaylistItem),this.view.updateTrackModal.toggle()}_onRemovePlaylistClick(){this.shell.showPrompt(`Are you sure you want to remove [${this.model.selectedPlaylist.name}]`,async e=>{let t=this.model.selectedPlaylist;if(t.isNew()&&t===this.model.newPlaylist)return;let i=new U(new Y);await this.model.removePlaylist(i,this.model.getSelectedIndex()),await this.model.save(i),await this._refreshView()})}_onPurgeAllPlaylistsClick(){this.shell.showPrompt("Are you sure you want to purge ALL playlists? Consider doing a backup before purge!",async e=>{let t=new U(new Y);for(let i=this.model.listIds.length-1;i>-1;i--)await this.model.removePlaylist(t,i);await this.model.save(t),await this._refreshView()})}async _onSaveSubmit(){if(!this.view.$listEntryPlayPgInput.value){this.shell.showMessage("Playlist name is required and used for sorting");return}await this._saveSelectedPlaylist(),this.view.refreshPlaylistsSelectElement()}async _saveSelectedPlaylist(){this.model.selectedPlaylist.name=this.view.$listEntryPlayPgInput.value;let e=this.model.selectedPlaylist.isNew();e&&this.model.addNewPlaylist();let t=new U(new Y);return await this.model.selectedPlaylist.save(t),this.model.setSelectedIndex(this.model.listIds.indexOf(this.model.selectedPlaylist.id)),await this.model.save(t),e}_registerDragDrop(){this.eventRegistry.register(this.filterAdapter.tracksConfig.$tracksPgTbody,"dragstart",e=>{this.view.handleDragStart(e)}),this.eventRegistry.register(this.filterAdapter.tracksConfig.$tracksPgTbody,"dragover",e=>(e.preventDefault(),this.view.handleDragOver(e))),this.eventRegistry.register(this.filterAdapter.tracksConfig.$tracksPgTbody,"drop",async e=>{await this._onDrop(e)})}async _onDrop(e){e.preventDefault(),await this.view.handleDrop(e)&&await this._saveSelectedPlaylist()}_getBookmarkSelections(){let e=this.filterAdapter.getRowColSelections(),t=[];for(let i=0;i<e.length;i++){let s=this.model.selectedPlaylist.items[e[i][0]];t.push(s)}return[e,t]}},Pe=class r{static ROW_TMPL_HTML;static ALBUM_CFG={albumsPgSelectId:null};static TRACKS_CFG={tracksPgTbodyId:"tracksPlayPgTbody",rowTableId:"trackPlayPgTr",rowCheckboxId:"trackPlayPgInput",rowColTableId:null,rowColCheckboxId:null,selectAllTracksPgInputId:"selectAllTracksPlayPgInput",trackRowClickClosestElemType:"tr"};static FILTER_CFG={titleFilterPgFormId:"titleFilterPlayPgForm",titleFilterPgInputId:"titleFilterPlayPgInput",resetFilterPgBtnId:"resetFilterPlayPgBtn",filterDrpDnPgDivId:"filterDrpDnPlayPgDiv"};$actionsDrpDnPlayPgBtn=document.getElementById("actionsDrpDnPlayPgBtn");$actionsDrpDnPlayPgDiv=document.getElementById("actionsDrpDnPlayPgDiv");$manageDrpDnPlayPgBtn=document.getElementById("manageDrpDnPlayPgBtn");$manageDrpDnPlayPgDiv=document.getElementById("manageDrpDnPlayPgDiv");$filterDrpDnPlayPgBtn=document.getElementById("filterDrpDnPlayPgBtn");$filterDrpDnPlayPgDiv=document.getElementById("filterDrpDnPlayPgDiv");$playlistPlayPgSelect=document.getElementById("playlistPlayPgSelect");$listEntryPlayPgForm=document.getElementById("listEntryPlayPgForm");$listEntryPlayPgInput=document.getElementById("listEntryPlayPgInput");$importManageActionPlayPgA=document.getElementById("importManageActionPlayPgA");$exportManageActionPlayPgA=document.getElementById("exportManageActionPlayPgA");$restoreAllManageActionPlayPgA=document.getElementById("restoreAllManageActionPlayPgA");$backupAllManageActionPlayPgA=document.getElementById("backupAllManageActionPlayPgA");$removeManageActionPlayPgA=document.getElementById("removeManageActionPlayPgA");$purgeAllManageActionPlayPgA=document.getElementById("purgeAllManageActionPlayPgA");$newItemActionPlayPgA=document.getElementById("newItemActionPlayPgA");$editItemActionPlayPgA=document.getElementById("editItemActionPlayPgA");$copyActionPlayPgA=document.getElementById("copyActionPlayPgA");$gotoActiveActionPlayPgA=document.getElementById("gotoActiveActionPlayPgA");$pasteActionPlayPgA=document.getElementById("pasteActionPlayPgA");$deleteActionPlayPgA=document.getElementById("deleteActionPlayPgA");$draggableTr=document.getElementById("draggableTr");$updTrklistEntryModalPlayPgDiv=document.getElementById("updTrklistEntryModalPlayPgDiv");$closeModalPlayPgBtn=document.getElementById("closeModalPlayPgBtn");$trackRefEditPlayPgInput=document.getElementById("trackRefEditPlayPgInput");$linePosEditPlayPgInput=document.getElementById("linePosEditPlayPgInput");$mtRangesEditPlayPgInput=document.getElementById("mtRangesEditPlayPgInput");$hlRangesEditPlayPgInput=document.getElementById("hlRangesEditPlayPgInput");$startAudioEditPlayPgInput=document.getElementById("startAudioEditPlayPgInput");$stopAudioEditPlayPgInput=document.getElementById("stopAudioEditPlayPgInput");$notesEditPlayPgTextArea=document.getElementById("notesEditPlayPgTextArea");$saveModalEditPlayPgBtn=document.getElementById("saveModalEditPlayPgBtn");$pasteBookmarkEditPlayPgBtn=document.getElementById("pasteBookmarkEditPlayPgBtn");$prevSelectionTr;$dragImgEl;updateTrackModal=new k(this.$updTrklistEntryModalPlayPgDiv);controller;constructor(e){this.controller=e,this.updateTrackModal.onShow=()=>{e.shell.view.backgroundBlur.show()},this.updateTrackModal.onHide=()=>{e.shell.view.backgroundBlur.hide()}}async loadTableRowTemplates(){let[e,t]=await A.loadTemplate("./templates/playlist.tracksPlayPgTbody.trackPlayPgTr.html");r.ROW_TMPL_HTML=e}restoreListFromModel(e){this.$listEntryPlayPgInput.value=this.controller.model.idNamesMap[e]}restoreListItem(e){this.$trackRefEditPlayPgInput.value=e.trackRef??"",this.$linePosEditPlayPgInput.value=`${e.cursorLinePosition??""}`,this.$mtRangesEditPlayPgInput.value=e.markTextRanges??"",this.$hlRangesEditPlayPgInput.value=e.highlightLineRanges??"",this.$startAudioEditPlayPgInput.value=`${e.startAudio??""}`,this.$stopAudioEditPlayPgInput.value=`${e.stopAudio??""}`,this.$notesEditPlayPgTextArea.value=e.notes??""}saveListItemToModel(e){e.trackRef=this.$trackRefEditPlayPgInput.value.trim().length>0?this.$trackRefEditPlayPgInput.value.trim():void 0,e.cursorLinePosition=isNaN(parseFloat(this.$linePosEditPlayPgInput.value))?void 0:parseFloat(this.$linePosEditPlayPgInput.value),e.markTextRanges=this.$mtRangesEditPlayPgInput.value.trim().length>0?this.$mtRangesEditPlayPgInput.value.trim():void 0,e.highlightLineRanges=this.$hlRangesEditPlayPgInput.value.trim().length>0?this.$hlRangesEditPlayPgInput.value.trim():void 0,e.startAudio=isNaN(parseFloat(this.$startAudioEditPlayPgInput.value))?void 0:parseFloat(this.$startAudioEditPlayPgInput.value),e.stopAudio=isNaN(parseFloat(this.$stopAudioEditPlayPgInput.value))?void 0:parseFloat(this.$stopAudioEditPlayPgInput.value),e.notes=this.$notesEditPlayPgTextArea.value.trim().length>0?this.$notesEditPlayPgTextArea.value.trim():void 0}getTableRow(e){return this.controller.filterAdapter.tracksConfig.$tracksPgTbody.querySelector(`tr[data-row="${e}"]`)}selectListItem(e,t,i){let s=parseInt(t.getAttribute("data-row"));if(this.controller.model.selectedPlaylist.setSelectionItem(s),this.$prevSelectionTr){if(this._refreshDraggable(this.$prevSelectionTr,!1),this.$prevSelectionTr===t&&!i){this.$prevSelectionTr.className=I.NON_SELECTED_CSS,this.$prevSelectionTr=null;return}this.$prevSelectionTr.className=I.NON_SELECTED_CSS}(async()=>{let n=new U(new Y);await this.controller.model.selectedPlaylist.save(n)})(),this.$prevSelectionTr=t,this._refreshDraggable(this.$prevSelectionTr,!0),this.$prevSelectionTr.className=I.SELECTED_CSS}refreshPlaylistsSelectElement(){let e=Array.from(this.$playlistPlayPgSelect.options).filter(i=>i.value!=="-1").forEach(i=>i.remove()),t=this.controller.model.listIds;for(let i=0;i<t.length;i++){let s=document.createElement("option");s.value=i.toString(),s.setAttribute("data-id",t[i]),s.innerHTML=this.controller.model.idNamesMap[t[i]],this.$playlistPlayPgSelect.append(s)}this.$playlistPlayPgSelect.selectedIndex=this.controller.model.getSelectedIndex()+1}async loadTableRowPlaylist(){let e=this.controller.model.selectedPlaylist;this.$listEntryPlayPgInput.value=e.name,W.removeAllChildren(this.controller.filterAdapter.tracksConfig.$tracksPgTbody),this.controller.filterAdapter.tracksConfig.trackRows.length=0,this.$prevSelectionTr=null;let t=e.getSelectionItem();for(let i=0,s=0;i<e.items.length;i++){let n=e.items[i],o=await this.controller.app.albumStoreWorkerClient.selectTrackWhere({trackRef:n.trackRef});if(o.track===void 0){e.items.splice(i,1),t===i?(t=-1,e.setSelectionItem(t)):i<t&&(t--,e.setSelectionItem(t));continue}this.controller.filterAdapter.tracksConfig.trackRows.push(o.track);let a=this._prepareRow(s,n,o.track),l=document.createElement("tr");this.controller.filterAdapter.tracksConfig.$tracksPgTbody.append(l),l.outerHTML=a,s===t&&(this.$prevSelectionTr=document.getElementById(`${s}.trackPlayPgTr`),this.$prevSelectionTr.className=C.SELECTED_CSS,this._refreshDraggable(this.$prevSelectionTr,!0)),s++}}handleDragStart(e){let t=e.target;if(this.$draggableTr=t.closest("tr"),this.$draggableTr?.getAttribute("data-row")!==null){this.$dragImgEl&&this.$dragImgEl.remove();let i=this.$draggableTr.getBoundingClientRect(),s=e.clientX-i.left,n=e.clientY-i.top;e.dataTransfer.effectAllowed="move";let o=this.$draggableTr.querySelector('td[data-td-type="body"]');this.$dragImgEl=o.cloneNode(!0),this.$dragImgEl.draggable=!1,this.$dragImgEl.style.top="-1000px",this.$dragImgEl.querySelector('div[data-div-type="dragHandle"]').remove(),document.body.appendChild(this.$dragImgEl),e.dataTransfer.setDragImage(this.$dragImgEl,s,n)}}handleDragOver(e){return e.dataTransfer.dropEffect="move",!1}async handleDrop(e){this.$dragImgEl&&this.$dragImgEl.remove();let t=e.target.closest("tr");if(t===this.$draggableTr)return this.$draggableTr=null,!1;if(this.$draggableTr&&t instanceof HTMLTableRowElement){let i=parseInt(this.$draggableTr.getAttribute("data-row")),s=parseInt(t.getAttribute("data-row"));i<s&&s--;let n=this.controller.model.tracks.splice(i,1);this.controller.model.tracks.splice(s,0,n[0]);let o=this.controller.model.selectedPlaylist.items.splice(i,1);return this.controller.model.selectedPlaylist.items.splice(s,0,o[0]),this.$draggableTr.parentNode.insertBefore(this.$draggableTr,t),this._reorganiseTablesRows(i,s),this.$draggableTr=null,this.controller.model.selectedPlaylist.setSelectionItem(s),!0}return!1}_reorganiseTablesRows(e,t){let i=Math.min(e,t),s=Math.max(e,t),n=this.controller.filterAdapter.tracksConfig.$tracksPgTbody;for(let o=i;o<=s;o++){let a=n.children[o],l=o.toString();a.id=`${o}.trackPlayPgTr`,a.setAttribute("data-row",l);let c=a.querySelector("input[data-row]");c.id=`${o}.trackPlayPgInput`,c.setAttribute("data-row",l);let m=a.querySelector("label");m.setAttribute("for",`${o}.trackPlayPgInput`),m.setAttribute("data-row",l)}}_refreshDraggable(e,t){let i=e.querySelector('td div[data-div-type="dragHandle"]');i.draggable=t,t?i.classList.remove("hidden"):i.classList.add("hidden")}_prepareRow(e,t,i){let s=H.toHref(t),n=[["$ROW",`${e}`],["$TRACKREF",t.trackRef],["$TRACK_QUERYSTR_HREF",s],["$TITLE",i.title],["$CACHE_STATUS_COLOR",I.CACHE_STATUS_COLOR_CSS[i.isAudioCached?1:0]],["$DUR",`${re.secToMm(i.duration)}`],["$PROPERTIES_QS",t.toString(!0)]];return L.replaceAllSequence(r.ROW_TMPL_HTML,n)}};var dt=class{static bindRpc(e){let t=e;t.api||(t.api=3),t.bindRpcFunc(t,e.setup),t.bindRpcFunc(t,e.teardown,{hasNoArgs:!0}),t.bindRpcFunc(t,e.search),t.bindRpcFunc(t,e.onQueryState,{hasNoArgs:!0,hasReturn:!0}),t.bindRpcFunc(t,e.onPaused),t.bindRpcFunc(t,e.onUnpausedAwait,{hasNoArgs:!0,hasClientPromiseAwait:!0,hasReturn:!0}),t.bindRpcFunc(t,e.onProgressUpdate),t.bindRpcFunc(t,e.onFinished)}},ut=class{static bindRpc(e){let t=e;t.api||(t.api=3),t.bindRpcFunc(t,e.setup),t.bindRpcFunc(t,e.teardown,{hasNoArgs:!0}),t.bindRpcFunc(t,e.search,{hasReturn:!0}),t.bindRpcFunc(t,e.onSearch),t.bindRpcFunc(t,e.onMatch)}};var gt=class extends V{__getName__(){return"SearchTextManagerWorkerClient"}onQueryState_;onQueryState=async()=>await this.onQueryState_();onPaused_;onPaused=async e=>{await this.onPaused_(e)};onUnpausedAwait_;onUnpausedAwait=async e=>await this.onUnpausedAwait_(e);onProgressUpdate_;onProgressUpdate=async e=>{await this.onProgressUpdate_(e)};onFinished_;onFinished=async e=>{await this.onFinished_(e)};async setup(e){let t=this._prepareMessage(this.setup,e);await this._postMessage(this._getRecipient(),t)}async teardown(){let e=this._prepareMessage(this.teardown);await this._postMessage(this._getRecipient(),e)}async search(e){let t=this._prepareMessage(this.search,e);await this._postMessage(this._getRecipient(),t)}_bindMethods(){super._bindMethods(),dt.bindRpc(this)}};var pt=class extends V{id=-1;__getName__(){return"SearchTextWorkerClient"}constructor(e,t){super(e),this.id=t}onSearch_;onSearch=async e=>{await this.onSearch_(e)};onMatch_;onMatch=async e=>{await this.onMatch_(e)};async setup(e){let t=this._prepareMessage(this.setup,e);await this._postMessage(this._getRecipient(),t)}async teardown(){let e=this._prepareMessage(this.teardown);await this._postMessage(this._getRecipient(),e)}async search(e){let t=this._prepareMessage(this.search,e);return(await this._postMessage(this._getRecipient(),t)).resp}_bindMethods(){super._bindMethods(),ut.bindRpc(this)}};var Be={selectedAlbum:0,searchAllAlbums:!1,criteria:"",applyAndBetweenTerms:!0,andDelimiter:";"},ye=class extends T{type="SearchModel";selectedAlbum=Be.selectedAlbum;searchAllAlbums=Be.searchAllAlbums;criteria=Be.criteria;applyAndBetweenTerms=Be.applyAndBetweenTerms;andDelimiter=Be.andDelimiter;transients=["transients","coordinatorState","tracks","trackMatches","matchCount","playlist"];coordinatorState;tracks=[];trackMatches=[];matchCount=0;playlist=new D(void 0,"S","Search results playlist");fromSearchParams(e){let t=parseInt(e.get("selectedAlbum")),i=e.get("searchAllAlbums"),s=e.get("criteria"),n=e.get("applyAndBetweenTerms"),o=e.get("andDelimiter");return Number.isNaN(t)||(this.selectedAlbum=t),i&&(this.searchAllAlbums=i==="true"),s&&(this.criteria=s),n&&(this.applyAndBetweenTerms=n==="true"),o&&(this.andDelimiter=o),this}toJson(){return{selectedAlbum:this.selectedAlbum,searchAllAlbums:this.searchAllAlbums,criteria:this.criteria,applyAndBetweenTerms:this.applyAndBetweenTerms,andDelimiter:this.andDelimiter}}static toHref(e){return`#search?${q.jsonToQueryString(e)}`}};var mt=class extends C{model;view;drpDwnGrp=[];filterAdapter;coordinator;constructor(e,t,i,s){super(e,t,i,s,"/search","./templates/search.html"),this.model=this.app.model.search,this.model.coordinatorState={isStarted:!1,isPaused:!1,unPauseAwait:null}}getTrackSelections(){let e=[];return this._getSearchResultSelections().forEach((i,s,n)=>{e.indexOf(i.trackRef)===-1&&e.push(i.trackRef)}),e}async onAfterOfflineProcessing(e){this.isViewLoaded&&this.filterAdapter.refreshTrackCacheInfo(e)}onTrackListIndexChange(e,t,i){this.view.selectTableHeaderRow(null,"body",!0)}async _onShow(e){e.urlRoute.searchParams.size>0&&(this.model.fromSearchParams(e.urlRoute.searchParams),this.view.restoreFromModel()),this.model.playlist.getSelectionItem()>-1&&this.view.selectTableHeaderRow(null,"body",!0),super._onShow(e)}async setup(){await super.setup(),this._setupFilterAdapter(),this.view=new Se(this),await this.view.loadTableRowTemplates(),this._registerListeners(),this._initialiseView()}onSearch=async e=>{this.view.$searchInfoSrchPgDiv.innerText=e.trackRef};onMatch=async e=>{this.model.tracks.push(e.track),this.model.trackMatches.push(e.matches),this.model.matchCount+=e.matches.length;let t=new H;t.assignFrom({...e.matches[0].bookmark,trackRef:e.track.trackRef}),this.model.playlist.items.push(t);let i=this.model.tracks.length-1;this.view.createTableRowMatchEntries(i,e.track,e.matches),this.filterAdapter.applyFilter([e.track])};onQueryState=async()=>({isPaused:this.model.coordinatorState.isPaused});onPaused=async e=>{e.isPaused&&this.shell.showMessage("Search paused")};onUnpausedAwait=async e=>{this.model.coordinatorState.unPauseAwait=e;let t=await this.model.coordinatorState.unPauseAwait;return this.model.coordinatorState.unPauseAwait=null,t};onProgressUpdate=async e=>{let t=parseInt(`${e.progress*100}`);this.view.$progrSearchSrchPgDiv.style.width=`${t}%`};onFinished=async e=>{this.view.resetSearchProgress(this.model),this._prepareSrchResultTallyMessage("Finished"),await this._teardownCoordinator(),this.shell.showMessage("Search finished")};_setupFilterAdapter(){this.filterAdapter=new I(this.shell,this.eventRegistry,Se.ALBUM_CFG,Se.TRACKS_CFG,Se.FILTER_CFG),this.filterAdapter.tracksConfig.trackRows=this.model.tracks,this.filterAdapter.tracksConfig.onTrackRowClick=(e,t)=>{this.view.onTableRowClick(e,t)}}_initialiseView(){let e=new k(this.view.$actionsDrpDnSrchPgDiv),t=new E(this.view.$actionsDrpDnSrchPgBtn,e,this.drpDwnGrp);this.eventRegistry.register(this.view.$actionsDrpDnSrchPgBtn,"click",t.clickHandler);let i=new k(this.view.$filterDrpDnSrchPgDiv),s=new E(this.view.$filterDrpDnSrchPgBtn,i,this.drpDwnGrp);this.eventRegistry.register(this.view.$filterDrpDnSrchPgBtn,"click",s.clickHandler);let n=new k(this.view.$critDrpDnSrchPgDiv,"hidden",["block"]),o=new E(this.view.$critDrpDnSrchPgBtn,n,this.drpDwnGrp);this.eventRegistry.register(this.view.$critDrpDnSrchPgBtn,"click",o.clickHandler),this.filterAdapter.loadAlbums(),this.filterAdapter.albumConfig.$albumsPgSelect.selectedIndex=this.model.selectedAlbum,this.view.restoreFromModel()}_registerListeners(){this.filterAdapter.registerListeners(),this.eventRegistry.register(this.filterAdapter.albumConfig.$albumsPgSelect,"change",e=>{this.model.selectedAlbum=this.filterAdapter.albumConfig.$albumsPgSelect.selectedIndex}),this.eventRegistry.register(this.view.$allAlbumsSrchPgInput,"change",e=>{this.model.searchAllAlbums=this.view.$allAlbumsSrchPgInput.checked}),this.eventRegistry.register(this.view.$critSrchPgDiv,"change",e=>{this._onCritSrchPgDivChange(e)}),this.eventRegistry.register(this.view.$critSrchPgForm,"submit",async e=>{e.preventDefault(),await this._onSearchSubmit(e)}),this.eventRegistry.register(this.view.$pauseToggleSrchPgA,"click",e=>{e.preventDefault(),this.model.coordinatorState.isPaused=!this.model.coordinatorState.isPaused,this.model.coordinatorState.unPauseAwait&&this.model.coordinatorState.unPauseAwait.resolve({isPaused:this.model.coordinatorState.isPaused})}),this.eventRegistry.register(this.view.$abortSearchSrchPgBtn,"click",async e=>{this.coordinator&&(this._prepareSrchResultTallyMessage("Aborted"),await this._teardownCoordinator())}),this.eventRegistry.register(this.view.$copyActionSrchPgA,"click",e=>{e.preventDefault(),this._onCopySelectionsClick(e)}),this.eventRegistry.register(this.view.$gotoActiveActionSrchPgA,"click",e=>{e.preventDefault(),this._onGotoActiveSelectionClick(e)})}_prepareSrchResultTallyMessage(e){let t=this.model.tracks.length,i=`${this.model.matchCount} results in ${t} file(s)`;this.model.coordinatorState.isPaused=!1,this.view.$pauseToggleSrchPgA.classList.add("hidden"),this.view.$abortSearchSrchPgBtn.textContent=e,this.view.$searchInfoSrchPgDiv.textContent=i}_onCritSrchPgDivChange(e){this.view.saveToModel()}_onCopySelectionsClick(e){let t=this._getSearchResultSelections();if(t.length===0){this.shell.showMessage("No selections have been made!");return}this.shell.addBookmarks(t)}_onGotoActiveSelectionClick(e){this.view.$prevSelectionTr&&(this.scrollYPos=W.getElementScreenCenterScrollTo(this.view.$prevSelectionTr),this.moveToScrollPosition({urlRoute:A.currentUrlRoute,restorePosition:!0}))}async _onSearchSubmit(e){if(this.model.coordinatorState.isStarted){this.shell.showMessage("Search currently in execution");return}this.drpDwnGrp[0].$toggleComponent.show(),this.model.coordinatorState.isStarted=!0,this.view.$pauseToggleSrchPgA.classList.remove("hidden"),this.view.$abortSearchSrchPgBtn.textContent="Abort",await this._startSearch();let t=ye.toHref(this.model.toJson());this.setLocationHash(t,!0)}_getSearchResultSelections(){let e=this.filterAdapter.getRowColSelections(),t=[];for(let i=0;i<e.length;i++){let s=this.model.trackMatches[e[i][0]][e[i][1]],n={trackRef:this.model.tracks[e[i][0]].trackRef,...s.bookmark};t.push(n)}return t}async _startSearch(){this.model.tracks.length=0,this.model.trackMatches.length=0,this.model.matchCount=0,this.model.playlist.items.length=0,this.model.playlist.setSelectionItem(-1),W.removeAllChildren(this.filterAdapter.tracksConfig.$tracksPgTbody),await this._setupCoordinator();let e=this.view.createSearchTextScope(),t=this.view.createSearchTextCriteria();await this.coordinator.search(e,t)}async _setupCoordinator(){this.coordinator=new Yt(this),await this.coordinator.setup()}async _teardownCoordinator(){this.coordinator&&(await this.coordinator.teardown(),this.coordinator=null),this.view.resetSearchProgress(this.model)}},Se=class r{static ROW_MATCH_TMPL_HTML;static ROW_HEADER_TMPL_HTML;static ALBUM_CFG={albumsPgSelectId:"albumsSrchPgSelect"};static TRACKS_CFG={tracksPgTbodyId:"resultSrchPgTbody",rowTableId:"trackRsltHdrSrchPgTr",rowCheckboxId:null,rowColTableId:"matchRsltSrchPgTr",rowColCheckboxId:"matchRsltSrchPgInput",selectAllTracksPgInputId:"selectAllResultsSrchPgInput",trackRowClickClosestElemType:"button"};static FILTER_CFG={titleFilterPgFormId:"titleFilterSrchPgForm",titleFilterPgInputId:"titleFilterSrchPgInput",resetFilterPgBtnId:"resetFilterSrchPgBtn",filterDrpDnPgDivId:"filterDrpDnSrchPgDiv"};static convertToQueryString=new H;$actionsDrpDnSrchPgBtn=document.getElementById("actionsDrpDnSrchPgBtn");$actionsDrpDnSrchPgDiv=document.getElementById("actionsDrpDnSrchPgDiv");$filterDrpDnSrchPgBtn=document.getElementById("filterDrpDnSrchPgBtn");$filterDrpDnSrchPgDiv=document.getElementById("filterDrpDnSrchPgDiv");$critDrpDnSrchPgBtn=document.getElementById("critDrpDnSrchPgBtn");$critDrpDnSrchPgDiv=document.getElementById("critDrpDnSrchPgDiv");$allAlbumsSrchPgInput=document.getElementById("allAlbumsSrchPgInput");$critSrchPgForm=document.getElementById("critSrchPgForm");$critSrchPgDiv=document.getElementById("critSrchPgDiv");$critSrchPgInput=document.getElementById("critSrchPgInput");$applyAndSrchPgInput=document.getElementById("applyAndSrchPgInput");$andDelimiterSrchPgInput=document.getElementById("andDelimiterSrchPgInput");$abortSearchSrchPgBtn=document.getElementById("abortSearchSrchPgBtn");$searchInfoSrchPgDiv=document.getElementById("searchInfoSrchPgDiv");$progrSearchSrchPgDiv=document.getElementById("progrSearchSrchPgDiv");$copyActionSrchPgA=document.getElementById("copyActionSrchPgA");$gotoActiveActionSrchPgA=document.getElementById("gotoActiveActionSrchPgA");$pauseToggleSrchPgA=document.getElementById("pauseToggleSrchPgA");$prevSelectionTr;controller;constructor(e){this.controller=e}async loadTableRowTemplates(){let[e,t]=await A.loadTemplate("./templates/search.resultSrchPgTbody.trackRsltHdrSrchPgTr.html");r.ROW_HEADER_TMPL_HTML=e;let[i,s]=await A.loadTemplate("./templates/search.resultSrchPgTbody.matchRsltSrchPgTr.html");r.ROW_MATCH_TMPL_HTML=i}createTableRowMatchEntries(e,t,i){let s=document.createElement("tr");this.controller.filterAdapter.tracksConfig.$tracksPgTbody.append(s),s.outerHTML=this._prepareHeaderRow(e,i.length,t);for(let n=0;n<i.length;n++){let o=document.createElement("tr");this.controller.filterAdapter.tracksConfig.$tracksPgTbody.append(o),o.outerHTML=this._prepareMatchRow(e,n,t,i[n])}}onTableRowClick(e,t){if(!(e.target instanceof HTMLInputElement&&e.target.type==="checkbox"))if(t instanceof HTMLButtonElement)this.toggleTableHeaderExpandCollapse(t);else{let i=t.getAttribute("data-tr-type"),s=e.target.localName==="a";this.selectTableHeaderRow(t,i,s),s&&this.controller.app.model.shell.mount(this.controller.model.playlist,this.controller)}}selectTableHeaderRow(e,t,i=!1){let s=-1,n=!1;if(e?s=parseInt(e.getAttribute("data-row")):(s=this.controller.model.playlist.getSelectionItem(),n=!0),t==="body"&&(i=!0,e=this.controller.filterAdapter.tracksConfig.$tracksPgTbody.querySelector(`tr[data-tr-type="head"][data-row="${s}"]`)),this.controller.model.playlist.getSelectionItem()!==s||n)this.$prevSelectionTr&&(this.$prevSelectionTr.className=I.NON_SELECTED_CSS),this.$prevSelectionTr=e,this.$prevSelectionTr.className=I.SELECTED_CSS,this.controller.model.playlist.setSelectionItem(s);else if(!i){let o=e.getAttribute("data-checked")==="1";e.setAttribute("data-checked",o?"0":"1"),this.controller.filterAdapter.tracksConfig.$tracksPgTbody.querySelectorAll(`input[type="checkbox"][data-row="${s}"]`).forEach((a,l)=>{a.checked=!o})}}toggleTableHeaderExpandCollapse(e){if(!(e.id&&e.id.endsWith(".trackRsltHdrSrchPgBtn")))return;let t=e.getAttribute("data-btn-state")!=="+",i=parseInt(e.id.replace(".trackRsltHdrSrchPgBtn",""));e.setAttribute("data-btn-state",t?"+":"-");let s=this.controller.model.trackMatches[i];for(let n=0;n<s.length;n++){let o=`${i}.${n}.${this.controller.filterAdapter.tracksConfig.rowColTableId}`,a=`${i}.${n}.${this.controller.filterAdapter.tracksConfig.rowColCheckboxId}`;t||this.controller.filterAdapter.uncheckFilteredOutSelections(a,t),this.controller.filterAdapter.showHideTableRow(o,t)}}restoreFromModel(){this.controller.filterAdapter.albumConfig.$albumsPgSelect.selectedIndex=this.controller.model.selectedAlbum,this.$allAlbumsSrchPgInput.checked=this.controller.model.searchAllAlbums,this.$critSrchPgInput.value=this.controller.model.criteria,this.$applyAndSrchPgInput.checked=this.controller.model.applyAndBetweenTerms,this.$andDelimiterSrchPgInput.value=this.controller.model.andDelimiter}saveToModel(){this.controller.model.criteria=this.$critSrchPgInput.value,this.controller.model.applyAndBetweenTerms=this.$applyAndSrchPgInput.checked,this.controller.model.andDelimiter=this.$andDelimiterSrchPgInput.value,this.controller.model.applyAndBetweenTerms&&!this.controller.model.andDelimiter&&(this.controller.shell.showMessage("A delimiter representing 'and' is required"),this.$applyAndSrchPgInput.checked=!1,this.controller.model.applyAndBetweenTerms=!1)}resetSearchProgress(e){e.coordinatorState.isStarted=!1,this.$progrSearchSrchPgDiv.style.width="0%"}createSearchTextScope(){return{startFromAlbumIndex:this.controller.filterAdapter.albumConfig.$albumsPgSelect.selectedIndex,searchAllAlbums:this.$allAlbumsSrchPgInput.checked}}createSearchTextCriteria(){let e=L.convertToRegExIfValid(this.$critSrchPgInput.value),t=e.regExFlags!==void 0;return{searchFor:e.patternOrSearchExpr,ignoreDiacritics:e.ignoreDiacritics,applyAndBetweenTerms:!t&&this.$applyAndSrchPgInput.checked,andDelimiter:this.$andDelimiterSrchPgInput.value,useRegEx:t,regExFlags:e.regExFlags}}_prepareHeaderRow(e,t,i){let s=[["$ROW",`${e}`],["$COLS",`${t}`],["$TRACKREF",i.trackRef],["$TITLE",i.title],["$CACHE_STATUS_COLOR",I.CACHE_STATUS_COLOR_CSS[i.isAudioCached?1:0]],["$DUR",`${re.secToMm(i.duration)}`]];return L.replaceAllSequence(r.ROW_HEADER_TMPL_HTML,s)}_prepareMatchRow(e,t,i,s){let n=H.toHref({trackRef:i.trackRef,...s.bookmark}),o=[["$ROW",`${e}`],["$COL",`${t}`],["$TRACKREF",i.trackRef],["$LINENUM",`${s.displayTeaser.lineNumber}`],["$TRACK_QUERYSTR_HREF",n],["$TEASER",s.displayTeaser.teaser]];return L.replaceAllSequence(r.ROW_MATCH_TMPL_HTML,o)}},Yt=class r{static MAX_WORKERS=5;page;searchTextManagerWorkerClient;searchTextWorkerClients=[];albumStorePortIds=[];constructor(e){this.page=e}async setup(){let e=this.page.app.appConfig.searchTextManagerWorker,t=new Worker(e.scriptURL,{...e,name:"searchTextManagerWorker"});this.searchTextManagerWorkerClient=new gt(new J(t)),this.searchTextManagerWorkerClient.startClient();let i=[],s=new MessageChannel;this.albumStorePortIds.push("srch_asw_stmw"),i.push(s.port2);let n=[],o=[];this._createSearchWorkers();let a=await this._dispatchSearchWorkerTranfserPorts(i,n,o);await this._initiateSearchWorkerSetup(a);let l=await this.page.shell.app.albumStoreWorkerClient.__transferPorts__({portIds:this.albumStorePortIds},i),c=await this.searchTextManagerWorkerClient.__transferPorts__({portIds:[this.albumStorePortIds[0],...n]},[s.port1,...o]);await this.searchTextManagerWorkerClient.setup({albumStorePortId:this.albumStorePortIds[0],portIds:n}),this._registerWorkerListeners()}_createSearchWorkers(){let e=this.page.app.appConfig.searchTextWorker_n;for(let t=0;t<r.MAX_WORKERS;t++){let i=new Worker(e.scriptURL,{...e,name:`searchTextWorker_${t}`}),s=new pt(new J(i),t);this.searchTextWorkerClients.push(s)}}async _dispatchSearchWorkerTranfserPorts(e,t,i){let s=[],n=[];for(let a=0;a<this.searchTextWorkerClients.length;a++){let l=new MessageChannel,c=`srch_asw_stw_${a}`;this.albumStorePortIds.push(c),e.push(l.port2);let m=new MessageChannel,f=`srch_stmw_stw_${a}`;t.push(f),i.push(m.port2),s.push(c),this.searchTextWorkerClients[a].startClient();let S=this.searchTextWorkerClients[a].__transferPorts__({portIds:[c,f]},[l.port1,m.port1]);n.push(S)}let o=await Promise.all(n);return s}async _initiateSearchWorkerSetup(e){let t=[];for(let i=0;i<this.searchTextWorkerClients.length;i++){let s=this.searchTextWorkerClients[i].setup({albumStorePortId:e[i]});t.push(s)}await Promise.all(t)}async teardown(){this._unregisterWorkerListeners();for(let e=0;e<this.searchTextWorkerClients.length;e++)await this.searchTextWorkerClients[e].teardown(),await this.searchTextWorkerClients[e].stopClient();await this.searchTextManagerWorkerClient.teardown(),await this.searchTextManagerWorkerClient.stopClient(),this.page=null,this.albumStorePortIds.length=0,this.searchTextManagerWorkerClient=null,this.searchTextWorkerClients.length=0,this.searchTextWorkerClients=null}async search(e,t){await this.searchTextManagerWorkerClient.search({scope:e,criteria:t})}_registerWorkerListeners(){this.searchTextManagerWorkerClient.onQueryState_=this.page.onQueryState,this.searchTextManagerWorkerClient.onPaused_=this.page.onPaused,this.searchTextManagerWorkerClient.onUnpausedAwait_=this.page.onUnpausedAwait,this.searchTextManagerWorkerClient.onProgressUpdate_=this.page.onProgressUpdate,this.searchTextManagerWorkerClient.onFinished_=this.page.onFinished;for(let e=0;e<this.searchTextWorkerClients.length;e++)this.searchTextWorkerClients[e].onSearch_=this.page.onSearch,this.searchTextWorkerClients[e].onMatch_=this.page.onMatch}_unregisterWorkerListeners(){this.searchTextManagerWorkerClient.onQueryState_=null,this.searchTextManagerWorkerClient.onPaused_=null,this.searchTextManagerWorkerClient.onUnpausedAwait_=null,this.searchTextManagerWorkerClient.onProgressUpdate_=null,this.searchTextManagerWorkerClient.onFinished_=null;for(let e=0;e<this.searchTextWorkerClients.length;e++)this.searchTextWorkerClients[e].onSearch_=null,this.searchTextWorkerClients[e].onMatch_=null}};var ft=class{static forEach(e,t,i){let s="",n=!1,o="";for(let a=0;a<e.length;a++){let l=e.charAt(a),c=t.includes(a);n===c?o+=l:(s+=i(o,n),o=l),n=c}return o&&(s+=i(o,n)),s}},te=class{selections;constructor(e){this.selections=new Set(e)}toggle(e){let t=this.selections.has(e);return t?this.selections.delete(e):this.selections.add(e),!t}toString(){if(this.selections.size===0)return"";let e=Array.from(this.selections).sort((o,a)=>o-a),t=[],i=[e[0]];function s(){i.length===1?t.push(`${i[0]}`):i.length>1&&t.push(`${i[0]}-${i[i.length-1]}`)}for(let o=1;o<e.length;o++)e[o-1]+1===e[o]?i.push(e[o]):(s(),i=[e[o]]);return s(),t.join(",")}toNumbers(){let e=Array.from(this.selections);return e.sort(),this.selections=new Set(e),e}fromString(e){this.selections.clear();let t=e.split(",");for(let i=0;i<t.length;i++)if(t[i]){let s=t[i].split("-"),n=[];for(let o=0;o<s.length;o++)n.push(parseInt(s[o]));if(n.length===1)this.selections.add(n[0]);else for(let o=n[0];o<n[1]+1;o++)this.selections.add(o)}return this}fromNumbers(e){let t=[];return e.forEach((i,s,n)=>{let o=String(i);o=o.replace(",","-"),t.push(o)}),this.fromString(t.toString())}};var Pt=class r{static markupContent(e,t,i){return t&&(e=r._markupHeaders(e)),i&&(e=this._markupTextRanges(e,i)),e}static _markupHeaders(e){let t=e.indexOf(`
`),i=e.substring(0,t);i="# "+i;let s=e.indexOf(`
`,t+1),n=e.substring(t+1,s).trim();n.length>0&&(n="## "+n);let o=e.substring(s+1);return e=`${i}
${n}
${o}`,e}static _markupTextRanges(e,t){let i=new te;return i.fromString(t),i.selections.size>0&&(e=ft.forEach(e,i.toNumbers(),(s,n)=>n?`==${s}==`:s)),e}};var co=xi(Ti(),1);Prism.languages.markup={comment:{pattern:/<!--(?:(?!<!--)[\s\S])*?-->/,greedy:!0},prolog:{pattern:/<\?[\s\S]+?\?>/,greedy:!0},doctype:{pattern:/<!DOCTYPE(?:[^>"'[\]]|"[^"]*"|'[^']*')+(?:\[(?:[^<"'\]]|"[^"]*"|'[^']*'|<(?!!--)|<!--(?:[^-]|-(?!->))*-->)*\]\s*)?>/i,greedy:!0,inside:{"internal-subset":{pattern:/(^[^\[]*\[)[\s\S]+(?=\]>$)/,lookbehind:!0,greedy:!0,inside:null},string:{pattern:/"[^"]*"|'[^']*'/,greedy:!0},punctuation:/^<!|>$|[[\]]/,"doctype-tag":/^DOCTYPE/i,name:/[^\s<>'"]+/}},cdata:{pattern:/<!\[CDATA\[[\s\S]*?\]\]>/i,greedy:!0},tag:{pattern:/<\/?(?!\d)[^\s>\/=$<%]+(?:\s(?:\s*[^\s>\/=]+(?:\s*=\s*(?:"[^"]*"|'[^']*'|[^\s'">=]+(?=[\s>]))|(?=[\s/>])))+)?\s*\/?>/,greedy:!0,inside:{tag:{pattern:/^<\/?[^\s>\/]+/,inside:{punctuation:/^<\/?/,namespace:/^[^\s>\/:]+:/}},"special-attr":[],"attr-value":{pattern:/=\s*(?:"[^"]*"|'[^']*'|[^\s'">=]+)/,inside:{punctuation:[{pattern:/^=/,alias:"attr-equals"},{pattern:/^(\s*)["']|["']$/,lookbehind:!0}]}},punctuation:/\/?>/,"attr-name":{pattern:/[^\s>\/]+/,inside:{namespace:/^[^\s>\/:]+:/}}}},entity:[{pattern:/&[\da-z]{1,8};/i,alias:"named-entity"},/&#x?[\da-f]{1,8};/i]},Prism.languages.markup.tag.inside["attr-value"].inside.entity=Prism.languages.markup.entity,Prism.languages.markup.doctype.inside["internal-subset"].inside=Prism.languages.markup,Prism.hooks.add("wrap",function(r){r.type==="entity"&&(r.attributes.title=r.content.replace(/&amp;/,"&"))}),Object.defineProperty(Prism.languages.markup.tag,"addInlined",{value:function(r,e){var t={};t["language-"+e]={pattern:/(^<!\[CDATA\[)[\s\S]+?(?=\]\]>$)/i,lookbehind:!0,inside:Prism.languages[e]},t.cdata=/^<!\[CDATA\[|\]\]>$/i;var i={"included-cdata":{pattern:/<!\[CDATA\[[\s\S]*?\]\]>/i,inside:t}};i["language-"+e]={pattern:/[\s\S]+/,inside:Prism.languages[e]};var s={};s[r]={pattern:RegExp("(<__[^>]*>)(?:<!\\[CDATA\\[(?:[^\\]]|\\](?!\\]>))*\\]\\]>|(?!<!\\[CDATA\\[)[^])*?(?=</__>)".replace(/__/g,function(){return r}),"i"),lookbehind:!0,greedy:!0,inside:i},Prism.languages.insertBefore("markup","cdata",s)}}),Object.defineProperty(Prism.languages.markup.tag,"addAttribute",{value:function(r,e){Prism.languages.markup.tag.inside["special-attr"].push({pattern:RegExp(`(^|["'\\s])(?:`+r+`)\\s*=\\s*(?:"[^"]*"|'[^']*'|[^\\s'">=]+(?=[\\s>]))`,"i"),lookbehind:!0,inside:{"attr-name":/^[^\s=]+/,"attr-value":{pattern:/=[\s\S]+/,inside:{value:{pattern:/(^=\s*(["']|(?!["'])))\S[\s\S]*(?=\2$)/,lookbehind:!0,alias:[e,"language-"+e],inside:Prism.languages[e]},punctuation:[{pattern:/^=/,alias:"attr-equals"},/"|'/]}}}})}}),Prism.languages.html=Prism.languages.markup,Prism.languages.mathml=Prism.languages.markup,Prism.languages.svg=Prism.languages.markup,Prism.languages.xml=Prism.languages.extend("markup",{}),Prism.languages.ssml=Prism.languages.xml,Prism.languages.atom=Prism.languages.xml,Prism.languages.rss=Prism.languages.xml;(function(r){function e(l){return l=l.replace(/<inner>/g,function(){return`(?:\\\\.|[^\\\\
\r]|(?:
|\r
?)(?![\r
]))`}),RegExp("((?:^|[^\\\\])(?:\\\\{2})*)(?:"+l+")")}var t="(?:\\\\.|``(?:[^`\r\n]|`(?!`))+``|`[^`\r\n]+`|[^\\\\|\r\n`])+",i=`\\|?__(?:\\|__)+\\|?(?:(?:
|\r
?)|(?![^]))`.replace(/__/g,function(){return t}),s=`\\|?[ 	]*:?-{3,}:?[ 	]*(?:\\|[ 	]*:?-{3,}:?[ 	]*)+\\|?(?:
|\r
?)`;r.languages.markdown=r.languages.extend("markup",{}),r.languages.insertBefore("markdown","prolog",{"front-matter-block":{pattern:/(^(?:\s*[\r\n])?)---(?!.)[\s\S]*?[\r\n]---(?!.)/,lookbehind:!0,greedy:!0,inside:{punctuation:/^---|---$/,"front-matter":{pattern:/\S+(?:\s+\S+)*/,alias:["yaml","language-yaml"],inside:r.languages.yaml}}},blockquote:{pattern:/^>(?:[\t ]*>)*/m,alias:"punctuation"},table:{pattern:RegExp("^"+i+s+"(?:"+i+")*","m"),inside:{"table-data-rows":{pattern:RegExp("^("+i+s+")(?:"+i+")*$"),lookbehind:!0,inside:{"table-data":{pattern:RegExp(t),inside:r.languages.markdown},punctuation:/\|/}},"table-line":{pattern:RegExp("^("+i+")"+s+"$"),lookbehind:!0,inside:{punctuation:/\||:?-{3,}:?/}},"table-header-row":{pattern:RegExp("^"+i+"$"),inside:{"table-header":{pattern:RegExp(t),alias:"important",inside:r.languages.markdown},punctuation:/\|/}}}},code:[{pattern:/((?:^|\n)[ \t]*\n|(?:^|\r\n?)[ \t]*\r\n?)(?: {4}|\t).+(?:(?:\n|\r\n?)(?: {4}|\t).+)*/,lookbehind:!0,alias:"keyword"},{pattern:/^```[\s\S]*?^```$/m,greedy:!0,inside:{"code-block":{pattern:/^(```.*(?:\n|\r\n?))[\s\S]+?(?=(?:\n|\r\n?)^```$)/m,lookbehind:!0},"code-language":{pattern:/^(```).+/,lookbehind:!0},punctuation:/```/}}],title:[{pattern:/\S.*(?:\n|\r\n?)(?:==+|--+)(?=[ \t]*$)/m,alias:"important",inside:{punctuation:/==+$|--+$/}},{pattern:/(^\s*)#.+/m,lookbehind:!0,alias:"important",inside:{punctuation:/^#+|#+$/}}],hr:{pattern:/(^\s*)([*-])(?:[\t ]*\2){2,}(?=\s*$)/m,lookbehind:!0,alias:"punctuation"},list:{pattern:/(^\s*)(?:[*+-]|\d+\.)(?=[\t ].)/m,lookbehind:!0,alias:"punctuation"},"url-reference":{pattern:/!?\[[^\]]+\]:[\t ]+(?:\S+|<(?:\\.|[^>\\])+>)(?:[\t ]+(?:"(?:\\.|[^"\\])*"|'(?:\\.|[^'\\])*'|\((?:\\.|[^)\\])*\)))?/,inside:{variable:{pattern:/^(!?\[)[^\]]+/,lookbehind:!0},string:/(?:"(?:\\.|[^"\\])*"|'(?:\\.|[^'\\])*'|\((?:\\.|[^)\\])*\))$/,punctuation:/^[\[\]!:]|[<>]/},alias:"url"},bold:{pattern:e("\\b__(?:(?!_)<inner>|_(?:(?!_)<inner>)+_)+__\\b|\\*\\*(?:(?!\\*)<inner>|\\*(?:(?!\\*)<inner>)+\\*)+\\*\\*"),lookbehind:!0,greedy:!0,inside:{content:{pattern:/(^..)[\s\S]+(?=..$)/,lookbehind:!0,inside:{}},punctuation:/\*\*|__/}},italic:{pattern:e("\\b_(?:(?!_)<inner>|__(?:(?!_)<inner>)+__)+_\\b|\\*(?:(?!\\*)<inner>|\\*\\*(?:(?!\\*)<inner>)+\\*\\*)+\\*"),lookbehind:!0,greedy:!0,inside:{content:{pattern:/(^.)[\s\S]+(?=.$)/,lookbehind:!0,inside:{}},punctuation:/[*_]/}},strike:{pattern:e("(~~?)(?:(?!~)<inner>)+\\2"),lookbehind:!0,greedy:!0,inside:{content:{pattern:/(^~~?)[\s\S]+(?=\1$)/,lookbehind:!0,inside:{}},punctuation:/~~?/}},"code-snippet":{pattern:/(^|[^\\`])(?:``[^`\r\n]+(?:`[^`\r\n]+)*``(?!`)|`[^`\r\n]+`(?!`))/,lookbehind:!0,greedy:!0,alias:["code","keyword"]},url:{pattern:e('!?\\[(?:(?!\\])<inner>)+\\](?:\\([^\\s)]+(?:[	 ]+"(?:\\\\.|[^"\\\\])*")?\\)|[ 	]?\\[(?:(?!\\])<inner>)+\\])'),lookbehind:!0,greedy:!0,inside:{operator:/^!/,content:{pattern:/(^\[)[^\]]+(?=\])/,lookbehind:!0,inside:{}},variable:{pattern:/(^\][ \t]?\[)[^\]]+(?=\]$)/,lookbehind:!0},url:{pattern:/(^\]\()[^\s)]+/,lookbehind:!0},string:{pattern:/(^[ \t]+)"(?:\\.|[^"\\])*"(?=\)$)/,lookbehind:!0}}}}),["url","bold","italic","strike"].forEach(function(l){["url","bold","italic","strike","code-snippet"].forEach(function(c){l!==c&&(r.languages.markdown[l].inside.content.inside[c]=r.languages.markdown[c])})}),r.hooks.add("after-tokenize",function(l){l.language!=="markdown"&&l.language!=="md"||function c(m){if(m&&typeof m!="string")for(var f=0,S=m.length;f<S;f++){var v=m[f];if(v.type==="code"){var d=v.content[1],h=v.content[3];if(d&&h&&d.type==="code-language"&&h.type==="code-block"&&typeof d.content=="string"){var g=d.content.replace(/\b#/g,"sharp").replace(/\b\+\+/g,"pp"),u="language-"+(g=(/[a-z][\w-]*/i.exec(g)||[""])[0].toLowerCase());h.alias?typeof h.alias=="string"?h.alias=[h.alias,u]:h.alias.push(u):h.alias=[u]}}else c(v.content)}}(l.tokens)}),r.hooks.add("wrap",function(l){if(l.type==="code-block"){for(var c="",m=0,f=l.classes.length;m<f;m++){var S=l.classes[m],v=/language-(.+)/.exec(S);if(v){c=v[1];break}}var d=r.languages[c];if(d)l.content=r.highlight(l.content.replace(n,"").replace(/&(\w{1,8}|#x?[\da-f]{1,8});/gi,function(g,u){var p;return(u=u.toLowerCase())[0]==="#"?(p=u[1]==="x"?parseInt(u.slice(2),16):Number(u.slice(1)),a(p)):o[u]||g}),d,c);else if(c&&c!=="none"&&r.plugins.autoloader){var h="md-"+new Date().valueOf()+"-"+Math.floor(1e16*Math.random());l.attributes.id=h,r.plugins.autoloader.loadLanguages(c,function(){var g=document.getElementById(h);g&&(g.innerHTML=r.highlight(g.textContent,r.languages[c],c))})}}});var n=RegExp(r.languages.markup.tag.pattern.source,"gi"),o={amp:"&",lt:"<",gt:">",quot:'"'},a=String.fromCodePoint||String.fromCharCode;r.languages.md=r.languages.markdown})(Prism);(function(){if(typeof Prism<"u"&&typeof document<"u"){var r="line-numbers",e=/\n(?!$)/g,t=Prism.plugins.lineNumbers={getLine:function(n,o){if(n.tagName==="PRE"&&n.classList.contains(r)){var a=n.querySelector(".line-numbers-rows");if(a){var l=parseInt(n.getAttribute("data-start"),10)||1,c=l+(a.children.length-1);o<l&&(o=l),o>c&&(o=c);var m=o-l;return a.children[m]}}},resize:function(n){s([n])},assumeViewportIndependence:!0},i=void 0;window.addEventListener("resize",function(){t.assumeViewportIndependence&&i===window.innerWidth||(i=window.innerWidth,s(Array.prototype.slice.call(document.querySelectorAll("pre.line-numbers"))))}),Prism.hooks.add("complete",function(n){if(n.code){var o=n.element,a=o.parentNode;if(a&&/pre/i.test(a.nodeName)&&!o.querySelector(".line-numbers-rows")&&Prism.util.isActive(o,r)){o.classList.remove(r),a.classList.add(r);var l,c=n.code.match(e),m=c?c.length+1:1,f=new Array(m+1).join("<span></span>");(l=document.createElement("span")).setAttribute("aria-hidden","true"),l.className="line-numbers-rows",l.innerHTML=f,a.hasAttribute("data-start")&&(a.style.counterReset="linenumber "+(parseInt(a.getAttribute("data-start"),10)-1)),n.element.appendChild(l),s([a]),Prism.hooks.run("line-numbers",n)}}}),Prism.hooks.add("line-numbers",function(n){n.plugins=n.plugins||{},n.plugins.lineNumbers=!0})}function s(n){if((n=n.filter(function(a){var l,c=(l=a,l?window.getComputedStyle?getComputedStyle(l):l.currentStyle||null:null)["white-space"];return c==="pre-wrap"||c==="pre-line"})).length!=0){var o=n.map(function(a){var l=a.querySelector("code"),c=a.querySelector(".line-numbers-rows");if(l&&c){var m=a.querySelector(".line-numbers-sizer"),f=l.textContent.split(e);m||((m=document.createElement("span")).className="line-numbers-sizer",l.appendChild(m)),m.innerHTML="0",m.style.display="block";var S=m.getBoundingClientRect().height;return m.innerHTML="",{element:a,lines:f,lineHeights:[],oneLinerHeight:S,sizer:m}}}).filter(Boolean);o.forEach(function(a){var l=a.sizer,c=a.lines,m=a.lineHeights,f=a.oneLinerHeight;m[c.length-1]=void 0,c.forEach(function(S,v){if(S&&S.length>1){var d=l.appendChild(document.createElement("span"));d.style.display="block",d.textContent=S}else m[v]=f})}),o.forEach(function(a){for(var l=a.sizer,c=a.lineHeights,m=0,f=0;f<c.length;f++)c[f]===void 0&&(c[f]=l.children[m++].getBoundingClientRect().height)}),o.forEach(function(a){var l=a.sizer,c=a.element.querySelector(".line-numbers-rows");l.style.display="none",l.innerHTML="",a.lineHeights.forEach(function(m,f){c.children[f].style.height=m+"px"})})}}})();var _=window.Prism,St=class r{static LINE_NUMBERS_CLASS="line-numbers";static LINKABLE_LINE_NUMBERS_CLASS="linkable-line-numbers";static NEW_LINE_EXP=/\n(?!$)/g;static _isLineHeightRounded;$currentPreElem;static $$(e,t){return Array.prototype.slice.call((t||document).querySelectorAll(e))}static hasClass(e,t){return e.classList.contains(t)}static isLineHeightRounded(){if(typeof r._isLineHeightRounded<"u")return r._isLineHeightRounded;let e=document.createElement("div");return e.style.fontSize="13px",e.style.lineHeight="1.5",e.style.padding="0",e.style.border="0",e.innerHTML="&nbsp;<br />&nbsp;",document.body.appendChild(e),r._isLineHeightRounded=e.offsetHeight===38,document.body.removeChild(e),r._isLineHeightRounded}static getContentBoxTopOffset(e,t){let i=getComputedStyle(e),s=getComputedStyle(t);function n(o){return+o.substring(0,o.length-2)}return t.offsetTop+n(s.borderTopWidth)+n(s.paddingTop)-n(i.paddingTop)}static isActiveFor(e){return!e||!/pre/i.test(e.nodeName)?!1:!!(e.hasAttribute("data-line")||e.id&&_.util.isActive(e,r.LINKABLE_LINE_NUMBERS_CLASS))}highlightLines(e,t,i){t=typeof t=="string"?t:e.getAttribute("data-line")||"";let s=t.replace(/\s+/g,"").split(",").filter(Boolean),n=+e.getAttribute("data-line-offset")||0,a=(r.isLineHeightRounded()?parseInt:parseFloat)(getComputedStyle(e).lineHeight),l=_.util.isActive(e,r.LINE_NUMBERS_CLASS),c=e.querySelector("code"),m=l?e:c||e,f=[],S=c.textContent.match(r.NEW_LINE_EXP),v=S?S.length+1:1,d=!c||m==c?0:r.getContentBoxTopOffset(e,c);if(this.$currentPreElem=e,s.forEach(h=>{let g=h.split("-"),u=+g[0],p=+g[1]||u;if(p=Math.min(v+n,p),p<u)return;let P=e.querySelector('.line-highlight[data-range="'+h+'"]')||document.createElement("div");this._addRangeInitMutations(f,P,h,i),l&&_.plugins.lineNumbers?this._addRangeLineNumberMutations(e,u,p,d,f,P):this._addRangeNonLineNumberMutations(f,P,u,p,n,a,d),this._addRangeFinMutations(f,P,e,m)}),l&&_.util.isActive(e,r.LINKABLE_LINE_NUMBERS_CLASS)&&e.id){r.hasClass(e,r.LINKABLE_LINE_NUMBERS_CLASS)||f.push(()=>{e.classList.add(r.LINKABLE_LINE_NUMBERS_CLASS)});let h=parseInt(e.getAttribute("data-start")||"1");r.$$(".line-numbers-rows > span",e).forEach((g,u)=>{let p=u+h;g.id=`_ln${p}`,g.setAttribute("data-ln",String(p))})}return()=>{f.forEach(h=>h())}}_addRangeInitMutations(e,t,i,s){e.push(()=>{t.setAttribute("aria-hidden","true"),t.setAttribute("data-range",i),t.className=(s||"")+" line-highlight"})}_addRangeFinMutations(e,t,i,s){e.push(()=>{t.style.width=i.scrollWidth+"px"}),e.push(()=>{s.appendChild(t)})}_addRangeLineNumberMutations(e,t,i,s,n,o){let a=_.plugins.lineNumbers.getLine(e,t),l=_.plugins.lineNumbers.getLine(e,i);if(a){let c=a.offsetTop+s+"px";n.push(()=>{o.style.top=c})}if(l){let c=l.offsetTop-a.offsetTop+l.offsetHeight+"px";n.push(()=>{o.style.height=c})}}_addRangeNonLineNumberMutations(e,t,i,s,n,o,a){e.push(()=>{t.setAttribute("data-start",String(i)),s>i&&t.setAttribute("data-end",String(s)),t.style.top=(i-n-1)*o+a+"px",t.textContent=new Array(s-i+2).join(` 
`)})}static highlightLinesIfRqd(e){e||(e=_.plugins.lineHighlight.$currentPreElem),r.$$(".temporary.line-highlight").forEach(i=>{i.parentNode.removeChild(i)});let t=e.urlRoute.searchParams.get("highlightLineRanges");if(t){let i=t;i=(i.match(/([\d,-]+)$/)||[""])[0],e.hasAttribute("data-line")||e.setAttribute("data-line",""),_.plugins.lineHighlight.highlightLines(e,i,"temporary ")()}}static registerHooks(){let e=0;_.hooks.add("before-sanity-check",t=>{let i=t.element.parentElement;if(!r.isActiveFor(i))return;let s=0;r.$$(".line-highlight",i).forEach(n=>{s+=n.textContent.length,n.parentNode.removeChild(n)}),s&&/^(?: \n)+$/.test(t.code.slice(-s))&&(t.code=t.code.slice(0,-s))}),_.hooks.add("complete",function t(i){let s=i.element.parentElement;if(!r.isActiveFor(s))return;clearTimeout(e);let n=_.plugins.lineNumbers,o=i.plugins&&i.plugins.lineNumbers;r.hasClass(s,r.LINE_NUMBERS_CLASS)&&n&&!o?_.hooks.add("line-numbers",t):(_.plugins.lineHighlight.highlightLines(s)(),e=setTimeout(r.highlightLinesIfRqd,1))})}static{r.registerHooks(),_.plugins.lineHighlight=new r}},ne=class r{static keyswordsList;static registerLanguage(){let e=[];for(let t=0;t<r.keyswordsList.length;t++)e.push(new RegExp(`\\b${r.keyswordsList[t]}\\b`,"i"));_.languages.trackmd=_.languages.extend("markdown",{keyword:e})}static registerFeatures(){_.languages.insertBefore("trackmd","prolog",{strike:{pattern:/--[^-]+--/,lookbehind:!0,greedy:!0,inside:{content:{pattern:/(^~~)[\s\S]+(?=\1$)/,lookbehind:!0,inside:{}},punctuation:/~~/}},highlight:{pattern:/==[^=]+==/,lookbehind:!0,greedy:!0,inside:{content:{pattern:/(^==)[\s\S]+(?=\1$)/,lookbehind:!0,inside:{}},punctuation:/==/}}})}static registerHooks(){_.hooks.add("wrap",function(e){e.language==="trackmd"&&(e.type==="strike"?e.content=e.content.replaceAll('<span class="token punctuation">~~</span>',""):e.type==="highlight"&&(e.content=e.content.replaceAll('<span class="token punctuation">==</span>',"")))})}};var vt=class r extends C{static SELECTED_CSS="border-l-4 border-blue-600";static SUBCTX="/";static collections;model;view;textMarkers={mouseState:-1,begin:-1,end:-1,mobileMessageInterval:void 0};_onTextSelectionHandler=e=>{this._onCodeTextSelection()};_onWindowResizeHandler=e=>{this._onRefreshCursorPositionAndHighlighting()};constructor(e,t,i,s){super(e,t,i,s,r.SUBCTX,"./templates/track.html"),this.model=this.app.model.track}async asyncConstructor(){if(!r.collections){r.collections=[];for(let e of this.shell.app.catalog)r.collections.push(e.id)}if(!ne.keyswordsList){let e=await this.shell.app.albumStoreWorkerClient.selectKeywordsList();ne.keyswordsList=e.keywords,ne.registerLanguage(),ne.registerFeatures(),ne.registerHooks()}}async canHandle(e){if(!e.pathname.startsWith(r.SUBCTX))return!1;let t=e.pathname.substring(r.SUBCTX.length),i=t.lastIndexOf("/"),s=t.substring(0,i);i=r.collections.indexOf(s);let n=i>-1;return!n&&this.model.playlist.selectedPlaylistItem.trackRef?n=!0:n=(await this.app.albumStoreWorkerClient.selectTrackWhere({trackRef:t})).track!==void 0,n}async onEnter(e){await super.onEnter(e),document.addEventListener("selectionchange",this._onTextSelectionHandler),window.addEventListener("resize",this._onWindowResizeHandler)}async onExit(){await super.onExit(),document.removeEventListener("selectionchange",this._onTextSelectionHandler),window.removeEventListener("resize",this._onWindowResizeHandler)}_saveSearchParamPositionToModel(){this.model.cursorLinePosition=q.getSearchParamValueAsFloat(this.model.urlRoute.searchParams.get("cursorLinePosition"),void 0),!this.model.cursorLinePosition&&this.visitations===1&&(this.scrollYPos=0)}_saveSearchParamAudioPositionsToModel(){return this.model.prevAudioConfig=this.model.currAudioConfig,this.model.startAudio=q.getSearchParamValueAsFloat(this.model.urlRoute.searchParams.get("startAudio"),void 0),this.model.stopAudio=q.getSearchParamValueAsFloat(this.model.urlRoute.searchParams.get("stopAudio"),void 0),this.model.currAudioConfig=`${this.model.startAudio}_${this.model.stopAudio}`,this.model.currAudioConfig!==this.model.prevAudioConfig}_saveSearchParamHighlightLinesToModel(){this.model.urlRoute.cargo.rangeSelections=this.model.highlightLineRanges;let e=this.model.urlRoute.searchParams.get("highlightLineRanges");this.model.highlightLineRanges.toString()!==e&&this.model.highlightLineRanges.fromString(e??"")}_saveSearchParamMarkupsToModel(){let e=this.model.urlRoute.searchParams.get("markTextRanges");this.model.markTextRanges.toString()!==e&&(this.model.markTextRanges.fromString(e??""),this._prepareMarkTextMarkdown(e))}async setup(){await super.setup(),this.view=new zt(this),this._initialiseView(),this._registerListeners()}_initialiseView(){let e=new k(this.view.$actionsTrackPgDiv),t=new E(this.view.$actionsTrackPgBtn,e);this.eventRegistry.register(this.view.$actionsTrackPgBtn,"click",t.clickHandler),this.model.persistentModel.href&&(this.$menuItem.href=this.model.persistentModel.href)}_registerListeners(){this.eventRegistry.register(this.view.$textTrackPgCode,"mousedown",e=>{this._onCodeMouseDown(e)}),this.eventRegistry.register(this.view.$textTrackPgCode,"mouseup",e=>{this._onCodeMouseUp(e)}),this.eventRegistry.register(this.view.$textTrackPgCode,"click",e=>{this._onLineNumberClick(e)}),this.eventRegistry.register(this.view.$textTrackPgCode,"dblclick",e=>{this._onLineNumberDblClick(e)}),this.eventRegistry.register(this.view.$copyBookmarkTrackPgA,"click",e=>{e.preventDefault(),this._copyBookmark()}),this.eventRegistry.register(this.view.$toggleLineCursorTrackPgA,"click",e=>{e.preventDefault(),this._toggleLineCursor(!1)}),this.eventRegistry.register(this.view.$toggleTextSelTrackPgA,"click",e=>{e.preventDefault(),this._toggleTextMarkups(!1)}),this.eventRegistry.register(this.view.$toggleLineHighlightTrackPgA,"click",e=>{e.preventDefault(),this._toggleLineHighlight(!1)}),this.eventRegistry.register(this.view.$syncAudioTrackPgA,"click",e=>{e.preventDefault(),this._moveAudioToSelection()}),this.eventRegistry.register(this.view.$toggleAudStartTrackPgA,"click",e=>{e.preventDefault(),this.toggleAudioStart(!1)}),this.eventRegistry.register(this.view.$toggleAudStopTrackPgA,"click",e=>{e.preventDefault(),this.toggleAudioStop(!1)}),this.eventRegistry.register(this.view.$clearBookmakTrackPgSelect,"change",e=>{this._clearBookmarkSelectChange(e)}),this.eventRegistry.register(this.view.$autoScrollWithAudioTrackPgInput,"change",e=>{this.app.model.textSettings.autoScrollWithAudio=this.view.$autoScrollWithAudioTrackPgInput.checked})}_copyBookmark(){let e={trackRef:this.model.trackRef,cursorLinePosition:this.model.cursorLinePosition,highlightLineRanges:this.model.highlightLineRanges.toString(),markTextRanges:this.model.markTextRanges.toString(),startAudio:this.model.startAudio,stopAudio:this.model.stopAudio};this.shell.setBookmark(e)}_clearBookmarkSelectChange(e){let t=this.view.$clearBookmakTrackPgSelect.selectedIndex;this.view.$clearBookmakTrackPgSelect.selectedIndex=0,t===3&&this._toggleLineCursor(!0),(t===1||t===3)&&this._toggleTextMarkups(!0),(t===2||t===3)&&this._toggleLineHighlight(!0),t===3&&this.toggleAudioStart(!0),t===3&&this.toggleAudioStop(!0),this._reloadPageUsingQueryString()}_moveAudioToSelection(){if(!this.model.currMarkedTextSelection)return;let e=this.model.currMarkedTextSelection.toNumbers(),t=this.model.estimateAudioPosition(e[0]);this.app.shell.model.onAudioResetTimeTo(t)}_onCodeMouseDown(e){this.textMarkers.mouseState=1}_onCodeMouseUp(e){this._onFinaliseTextSelection()}_onCodeTextSelection(){this.textMarkers.mouseState<=0&&this._onCodeMouseDown(null);let e=window.getSelection();if(e.rangeCount>0){let t=e.getRangeAt(0),i=t.commonAncestorContainer,s=this._findNearestCodeElement(i);if(!s)return;this.textMarkers.mouseState=2;let n=this._getOffsetWithinElement(s,t.startContainer,t.startOffset),o=this._getOffsetWithinElement(s,t.endContainer,t.endOffset);this.textMarkers.begin=Math.min(n,o),this.textMarkers.end=Math.max(n,o),this.textMarkers.end>this.textMarkers.begin&&this.textMarkers.end--,B.IS_MOBILE_PLATFORM&&this.textMarkers.mouseState===2&&(clearTimeout(this.textMarkers.mobileMessageInterval),this.textMarkers.mobileMessageInterval=setTimeout(()=>{this._onCodeMouseUp(null)},3e3))}}_onFinaliseTextSelection(){this.textMarkers.mouseState===2&&(this.model.currMarkedTextSelection=new te().fromString(`${this.textMarkers.begin}-${this.textMarkers.end}`),this.textMarkers.begin===this.textMarkers.end?this.app.shell.showMessage("Cursor position marked for audio sync"):this._toggleTextMarkups(),this.textMarkers.mouseState=0)}_findNearestCodeElement(e){for(;e&&e!==document.body;){if(e.nodeType===Node.ELEMENT_NODE&&e.tagName==="CODE")return e;e=e.parentNode}return null}_getOffsetWithinElement(e,t,i){let s=0,n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);for(;n.nextNode();){let o=n.currentNode;if(o.nodeType===Node.TEXT_NODE?s+=o.nodeValue.length:s+=o.textContent.length,o===t){o.nodeType===Node.TEXT_NODE?s-=o.nodeValue.length-i:s-=o.textContent.length-i;break}}return s}toggleAudioStart(e=!1){this.model.startAudio!==void 0||e?(this.model.startAudio=void 0,this.model.urlRoute.searchParams.delete("startAudio")):(this.model.startAudio=this.shell.view.$controlShellPgAudio.currentTime,this.model.urlRoute.searchParams.set("startAudio",this.model.startAudio.toString())),this.view.$toggleAudStartTrackPgSpan.textContent="Toggle audio start "+(this.model.startAudio?this.model.startAudio.toFixed(2):""),e||this._reloadPageUsingQueryString()}toggleAudioStop(e=!1){this.model.stopAudio!==void 0||e?(this.model.stopAudio=void 0,this.model.urlRoute.searchParams.delete("stopAudio")):(this.model.stopAudio=this.shell.view.$controlShellPgAudio.currentTime,this.model.urlRoute.searchParams.set("stopAudio",this.model.stopAudio.toString())),this.view.$toggleAudStopTrackPgSpan.textContent="Toggle audio stop "+(this.model.stopAudio?this.model.stopAudio.toFixed(2):""),e||this._reloadPageUsingQueryString()}_toggleLineCursor(e=!1){let t=this.model.urlRoute.searchParams.get("cursorLinePosition");this.model.cursorLinePosition=e?void 0:this.model.lineWithPercRef,this.view.$prevLineCursorPos&&(this.view.$prevLineCursorPos.className=""),t!==null||e?this.model.urlRoute.searchParams.delete("cursorLinePosition"):this.model.urlRoute.searchParams.set("cursorLinePosition",`${this.model.lineWithPercRef}`),this.view.$toggleLineCursorTrackPgSpan.textContent="Toggle line cursor "+(this.model.cursorLinePosition??""),e||this._reloadPageUsingQueryString()}_toggleTextMarkups(e=!1){if(e)this.model.markTextRanges.selections.clear();else{if(!this.model.currMarkedTextSelection)return;this.model.currMarkedTextSelection.toNumbers().forEach((t,i,s)=>{this.model.markTextRanges.toggle(t)})}this.model.markTextRanges.selections.size===0?this.model.urlRoute.searchParams.delete("markTextRanges"):this.model.urlRoute.searchParams.set("markTextRanges",this.model.markTextRanges.toString()),this.model.markTextRanges.selections.clear(),e||this._reloadPageUsingQueryString()}_toggleLineHighlight(e=!1){e?this.model.highlightLineRanges.selections.clear():this.model.highlightLineRanges.toggle(parseInt(this.model.lineWithPercRef)),this.model.highlightLineRanges.selections.size===0?this.model.urlRoute.searchParams.delete("highlightLineRanges"):this.model.urlRoute.searchParams.set("highlightLineRanges",this.model.highlightLineRanges.toString()),e||this._reloadPageUsingQueryString()}_onLineNumberBase(e){let t=e.target,i=t.getAttribute("data-ln");if(!(t instanceof HTMLSpanElement)||!i)return!1;let{lineRef:s}=this._getLineClickInfo(e,t);return this.model.lineWithPercRef=s,!0}_onLineNumberClick(e){this._onLineNumberBase(e)&&this._toggleLineHighlight()}_onLineNumberDblClick(e){this._onLineNumberBase(e)&&this._toggleLineCursor()}_reloadPageUsingQueryString(){let e=this.model.urlRoute.prepareHumanReadableLink(!0);this.setLocationHash(e,!0)}_getLineClickInfo(e,t){let i=t.parentElement.getBoundingClientRect(),s=(e.clientY-i.top)/i.height,n=t.getBoundingClientRect(),o=n.height>30,a=parseInt(t.id.substring(3)),l=o?(e.clientY-n.top)/n.height:0,c=Math.round((a+l)*100)/100;return{overrallPerc:s,lineNumber:a,linePerc:l,lineRef:c}}async _fetchAndPrepareHeaderMarkdown(){let e=await this.app.albumStoreWorkerClient.readTrackAsMarkdown({trackRef:this.model.trackRef,markupHeaders:!0});if(e.err)throw new Error(`Track /text/suttas/${this.model.trackRef}.txt not found`);this.model.trackMarkdown=e.text;let t=L.lineLengths(this.model.trackMarkdown,this.model.lineStartPositions);return!0}_prepareMarkTextMarkdown(e){this.model.currTrackMarkups=Pt.markupContent(this.model.trackMarkdown,!1,e)}async _onShow(e){let t=e.urlRoute.pathname.substring(r.SUBCTX.length);if(t){let i=!1;this.model.urlRoute=e.urlRoute,this.model.urlRoute.cargo.pageController=this,this.model.lastLoadedPathname!==e.urlRoute.pathname&&(i=!0,this.model.trackRef=t,await this._fetchTrackRecord(),await this._fetchAndPrepareHeaderMarkdown(),this.visitations=1),this._saveSearchParamPositionToModel();let s=this._saveSearchParamAudioPositionsToModel();this._saveSearchParamHighlightLinesToModel(),this._saveSearchParamMarkupsToModel(),this._refreshTrackMetadata(e.urlRoute);let n=await this._refreshTrackText();await this._refreshTrackAudio(i,s),this._onRefreshCursorPositionAndHighlighting(),this.$menuItem.hash=this.model.urlRoute.prepareHumanReadableLink(!0),this.model.persistentModel.href=this.$menuItem.hash}await super._onShow(e)}_onRefreshCursorPositionAndHighlighting(){let e=this.scrollYPos;this.scrollToLineNumberIfRqd(),St.highlightLinesIfRqd(this.view.$textTrackPgPre),this.visitations>1&&this.setScrollPosition(void 0,e)}scrollToLineNumberIfRqd(){let e,t=this.model.urlRoute.searchParams.get("cursorLinePosition");if(t){e=parseInt(t);let i=this.scrollToLineNumberScrollYPos(parseFloat(t));i!==void 0&&(this.scrollYPos=i)}return e}scrollToLineNumberScrollYPos(e){let t,i=parseInt(`${e}`),s=e-i,n=document.getElementById(`_ln${i}`);if(this.view.$prevLineCursorPos&&this.view.$prevLineCursorPos!==n&&(this.view.$prevLineCursorPos.className=""),n){n.className=r.SELECTED_CSS;let o=n.scrollHeight,l=n.getBoundingClientRect().top+window.scrollY+o*s,c=window.innerHeight||document.documentElement.clientHeight;t=l-c/2,this.view.$prevLineCursorPos=n}return t}async _fetchTrackRecord(){let e=await this.app.albumStoreWorkerClient.selectTrackWhere({trackRef:this.model.trackRef});this.model.trackRecord=e.track}_refreshTrackMetadata(e){this.view.$trackRefTrackPgA.textContent=this.model.trackRef,this.view.$trackRefTrackPgA.href=G.toHref(this.model.trackRef),this.view.$toggleLineCursorTrackPgSpan.textContent="Toggle line cursor "+(this.model.cursorLinePosition??""),this.view.$toggleAudStartTrackPgSpan.textContent="Toggle audio start "+(this.model.startAudio?this.model.startAudio.toFixed(2):""),this.view.$toggleAudStopTrackPgSpan.textContent="Toggle audio stop "+(this.model.stopAudio?this.model.stopAudio.toFixed(2):""),this.view.$autoScrollWithAudioTrackPgInput.checked=this.shell.app.model.textSettings.autoScrollWithAudio}async _refreshTrackText(){let e=this.view.$textTrackPgPre,t="urlRoute"in e?e.urlRoute:void 0;return this.view.$textTrackPgPre.urlRoute=this.model.urlRoute,(this.model.lastLoadedPathname!==this.model.urlRoute.pathname||this.model.prevTrackMarkups!==this.model.currTrackMarkups)&&(this.view.$textTrackPgCode.textContent=this.model.currTrackMarkups,this.model.prevTrackMarkups=this.model.currTrackMarkups,_.highlightElement(this.view.$textTrackPgCode,!1)),this.model.lastLoadedPathname=this.model.urlRoute.pathname,t}async _refreshTrackAudio(e,t){this.shell.model.trackModel=this.model,this.shell.model.playlist||this.shell.model.mount(this.model.playlist,this),await this.app.model.shell.setAudioTrackSrc(e,t)}scrollToLineWithPerc(e){this.setScrollPosition(void 0,this.scrollToLineNumberScrollYPos(e)),super.moveToScrollPosition({urlRoute:this.model.urlRoute,restorePosition:!0})}},zt=class{$actionsTrackPgBtn=document.getElementById("actionsTrackPgBtn");$actionsTrackPgDiv=document.getElementById("actionsTrackPgDiv");$trackRefTrackPgA=document.getElementById("trackRefTrackPgA");$textTrackPgPre=document.getElementById("textTrackPgPre");$textTrackPgCode=document.getElementById("textTrackPgCode");$copyBookmarkTrackPgA=document.getElementById("copyBookmarkTrackPgA");$toggleLineCursorTrackPgA=document.getElementById("toggleLineCursorTrackPgA");$toggleLineCursorTrackPgSpan=document.getElementById("toggleLineCursorTrackPgSpan");$toggleTextSelTrackPgA=document.getElementById("toggleTextSelTrackPgA");$toggleLineHighlightTrackPgA=document.getElementById("toggleLineHighlightTrackPgA");$syncAudioTrackPgA=document.getElementById("syncAudioTrackPgA");$toggleAudStartTrackPgA=document.getElementById("toggleAudStartTrackPgA");$toggleAudStartTrackPgSpan=document.getElementById("toggleAudStartTrackPgSpan");$toggleAudStopTrackPgA=document.getElementById("toggleAudStopTrackPgA");$toggleAudStopTrackPgSpan=document.getElementById("toggleAudStopTrackPgSpan");$clearBookmakTrackPgSelect=document.getElementById("clearBookmakTrackPgSelect");$autoScrollWithAudioTrackPgInput=document.getElementById("autoScrollWithAudioTrackPgInput");$prevLineCursorPos;controller;constructor(e){this.controller=e}};var wt=class extends T{type="TextSettingsModel";autoScrollWithAudio=!1;findInPageCriteria=""},kt=class extends T{type="AudioSettingsModel";playbackRate=1;autoPlay=!0;playNext=!0;repeat=!1;skipSize=5;applyStopStartRange=!0},Tt=class extends T{type="GeneralSettingsModel";darkTheme=!1;useTransfer=0};var bt=class{audioState=-1;playlist;playlistController;trackModel;startTime;stopTime;currentTime;lastSyncTime=0;preventOnTimeUpdate=!1;onAudioPlayEnd;onAudioResetTimeTo;onAudioStateChange;onAudioTimeChange;onAudioTrackConfigChange;onAudioTrackSrcChange;onMountChange;onPlayToggle;onSkipWithinTrack;onSyncTextWithAudioIfReqd;onTrackIndexChange;mount(e,t){this.playlist===e&&this.playlistController===t||(this.audioState=-1,this.playlist=e,this.playlistController=t,this.onMountChange(e))}async setAudioTrackSrc(e,t){if((e||t)&&(this.startTime=this.trackModel.startAudio===void 0?0:this.trackModel.startAudio,this.stopTime=this.trackModel.stopAudio===void 0?this.trackModel.trackRecord.duration:this.trackModel.stopAudio,this.lastSyncTime=this.startTime),e){let i=q.queryTrackHtmlAudioSrcRef(this.trackModel.trackRef);await this.onAudioTrackSrcChange(i,this.playlist.selectedPlaylistItem)}else t&&this.onAudioTrackConfigChange()}async playToggle(e){await this.onPlayToggle(e)}hasPrevious(){return this.playlist?this.playlist.getSelectionItem()>0:!1}hasNext(){return this.playlist?this.playlist.getSelectionItem()<this.playlist.items.length-1:!1}playNext(){return this._playNextPrev(1)}playPrevious(){return this._playNextPrev(-1)}skipWithinTrack(e){e!==0&&this.onSkipWithinTrack(e)}async setAudioState(e){let t=this.audioState;this.audioState=e,this.onAudioStateChange(t,e),this.audioState===6&&await this.onAudioPlayEnd()}getAudioState(){return this.audioState}async receiveTimeUpdate(e,t){let[i,s]=this.adjustTimeWithinStartStopRangesIfReqd(e,t);if(i!==e){if(this.currentTime=i,s&&(this.audioState===4&&await this.playToggle(!0),await this.onAudioPlayEnd()))return;this.preventOnTimeUpdate=!0,this.onAudioResetTimeTo(i)}this.onAudioTimeChange(i),this._notifySyncTextWithAudioIfReqd(i)}adjustTimeWithinStartStopRangesIfReqd(e,t){let i=[e,!1];return t&&(e<this.startTime?i[0]=this.startTime:e>this.stopTime&&this.stopTime!==this.trackModel.trackRecord.duration&&(i[0]=this.stopTime,i[1]=!0)),i}_notifySyncTextWithAudioIfReqd(e){let t=e-this.lastSyncTime;if(Math.abs(t)>3){this.lastSyncTime=e;let i=e/this.trackModel.trackRecord.duration;this.onSyncTextWithAudioIfReqd(e,i)}}_playNextPrev(e){let t=e>0?this.hasNext():this.hasPrevious();if(t){let i=this.playlist.getSelectionItem();this.playlist.setSelectionItem(i+e),this.onTrackIndexChange(e,i,i+e)}return t}};var jt=class extends T{type="TrackPersistentModel";href},Rt=class{persistentModel=new jt;trackRef;cursorLinePosition;highlightLineRanges=new te;markTextRanges=new te;startAudio;stopAudio;trackRecord;trackMarkdown;lineStartPositions=[];currAudioConfig;prevAudioConfig;currTrackMarkups;prevTrackMarkups;urlRoute;lastLoadedPathname;lineWithPercRef;currMarkedTextSelection;playlist=new D(void 0,"1","Single track playlist");constructor(){this.playlist.items.push(this),this.playlist.setSelectionItem(0)}async save(e){await this.persistentModel.save(e)}async restore(e){await this.persistentModel.restore(e)}estimateAudioPosition(e){return e/this.lineStartPositions[this.lineStartPositions.length-1]*this.trackRecord.duration}estimateTextSyncPosition(e){let t=this.lineStartPositions[this.lineStartPositions.length-1]*e,i=this.getLineNumber(t),s=this.lineStartPositions[i]-this.lineStartPositions[i-1],n=t-this.lineStartPositions[i-1],o=Math.round(100*n/s)/100;return[i,o]}getLineNumber(e){let t=0;for(let i=0;i<this.lineStartPositions.length;i++)if(this.lineStartPositions[i]>e){t=i;break}return t}};var At=class{static bindRpc(e){let t=e;t.api||(t.api=0),t.bindRpcFunc(t,e.updateTrackCacheInfo,{}),t.bindRpcFunc(t,e.selectAllAlbums,{hasNoArgs:!0,hasReturn:!0}),t.bindRpcFunc(t,e.selectAlbumWhere,{hasReturn:!0}),t.bindRpcFunc(t,e.selectAllTracksForAlbumWhere,{hasReturn:!0}),t.bindRpcFunc(t,e.selectTrackWhere,{hasReturn:!0}),t.bindRpcFunc(t,e.selectTracksWhere,{hasReturn:!0}),t.bindRpcFunc(t,e.selectKeywordsList,{hasNoArgs:!0,hasReturn:!0}),t.bindRpcFunc(t,e.readFileAsText,{hasReturn:!0}),t.bindRpcFunc(t,e.readTrackAsMarkdown,{hasReturn:!0})}};var Et=class extends V{__getName__(){return"AlbumStoreWorkerClient"}_bindMethods(){super._bindMethods(),At.bindRpc(this)}async updateTrackCacheInfo(e){let t=this._prepareMessage(this.updateTrackCacheInfo,e),i=await this._postMessage(this._getRecipient(),t)}async selectAllAlbums(){let e=this._prepareMessage(this.selectAllAlbums);return(await this._postMessage(this._getRecipient(),e)).resp}async selectAlbumWhere(e){let t=this._prepareMessage(this.selectAlbumWhere,e);return(await this._postMessage(this._getRecipient(),t)).resp}async selectAllTracksForAlbumWhere(e){let t=this._prepareMessage(this.selectAllTracksForAlbumWhere,e);return(await this._postMessage(this._getRecipient(),t)).resp}async selectTrackWhere(e){let t=this._prepareMessage(this.selectTrackWhere,e);return(await this._postMessage(this._getRecipient(),t)).resp}async selectTracksWhere(e){let t=this._prepareMessage(this.selectTracksWhere,e);return(await this._postMessage(this._getRecipient(),t)).resp}async selectKeywordsList(){let e=this._prepareMessage(this.selectKeywordsList);return(await this._postMessage(this._getRecipient(),e)).resp}async readFileAsText(e){let t=this._prepareMessage(this.readFileAsText,e);return(await this._postMessage(this._getRecipient(),t)).resp}async readTrackAsMarkdown(e){let t=this._prepareMessage(this.readTrackAsMarkdown,e);return(await this._postMessage(this._getRecipient(),t)).resp}};var ve=class r{static queryServiceWorkerReadyState(e){if(e){if(e.active)return"active";if(e.installing)return"installing";if(e.waiting)return"waiting"}else return"unregistered";throw new Error("IllegalState: Unknown service worker ready state")}static async queryServiceWorkerRegistrations(e,t){let i=await navigator.serviceWorker.getRegistrations(),s={total:i.length,active:0,installing:0,waiting:0,registrations:Array.from(i)};return i.forEach((n,o,a)=>{r.updateUpdateFoundListener(n,t);let l=n.installing||n.active||n.waiting;r.updateStateChangeListener(l,e);let c=r.queryServiceWorkerReadyState(n);s[c]=s[c]+1}),s}static updateStateChangeListener(e,t,i){e.removeEventListener("statechange",i||t),e.addEventListener("statechange",t)}static updateUpdateFoundListener(e,t,i){e.removeEventListener("updatefound",i||t),e.addEventListener("updatefound",t)}};var Jt=class{shell=new bt;catalog=new G;search=new ye;playlists=new ge;track=new Rt;audioSettings=new kt;textSettings=new wt;generalSettings=new Tt;async saveAll(){let e=new U(new Y);for(let t in this){let i=this;"save"in i[t]&&await i[t].save(e),"commit"in i[t]&&await i[t].commit(e)}}async restoreAll(){let e=new U(new Y);for(let t in this){let i=this;"restore"in i[t]&&await i[t].restore(e)}}},tt=class r{static VERSION="2.1.2";isFactoryReset=!1;model=new Jt;appConfig;router;shell;catalog;trackPage;catalogPage;searchPage;playlistPage;aboutPage;helpPage;e404Page;pagesControllers=[];albumStoreWorkerClient;swRegStates;_onSwStateChange=e=>{e.target.state==="installed"&&(this.shell.showMessage("Precaching completed!"),this.swRegStates.total>0&&this.shell.showPrompt("A new App version is available! Select Okay to activate it now.",async i=>{let s=setInterval(()=>{let n=1;console.log(`trying after: ${n}s`),n++>10&&clearInterval(s),this.swRegStates.registrations[0].waiting&&(this.swRegStates.registrations[0].waiting.postMessage({type:"skipWaiting"}),window.location.reload(),clearInterval(s))},1e3)}))};_onSwRegUpdateFound=e=>{console.log(`updateFound > swRegStates: ${JSON.stringify(this.swRegStates)}`),this.swRegStates.total>0&&(this.shell.showMessage("Precaching App update in the background...",0),this.swRegStates.registrations[0].installing&&this.swRegStates.registrations[0].installing.addEventListener("statechange",this._onSwStateChange))};async asyncConstructor(){await this.model.restoreAll(),this.appConfig=await r._queryAppConfig(),this.router=new A(this.appConfig.appRoot,!0),this.shell=new et(this),this.shell.launch(),await this._manageServiceWorkerState(),this._registerRoutes(),this._registerWorkers();let e=await this.albumStoreWorkerClient.selectAllAlbums();this.catalog=e.albums;for(let t=0;t<this.pagesControllers.length;t++)await this.pagesControllers[t].asyncConstructor()}run(){console.log(`SuttaPlayer v${r.VERSION} started`),window.addEventListener("load",async()=>{await this.asyncConstructor(),await this.router.start()}),window.addEventListener("visibilitychange",async e=>{this.isFactoryReset?this.isFactoryReset=!1:await this.model.saveAll(),this.shell.terminate()})}async reset(){this.isFactoryReset=!0;try{this.appConfig.isProd&&await navigator.serviceWorker.ready.then(e=>e.unregister()),caches.keys().then(e=>Promise.all(e.map(t=>caches.delete(t)))),localStorage.clear(),window.location.reload()}catch(e){console.error("IllegalState: Failed to factory reset",e)}}async _manageServiceWorkerState(){this.swRegStates=await ve.queryServiceWorkerRegistrations(this._onSwStateChange,this._onSwRegUpdateFound);let e=this.router.getCurrentUrlRoute();this.appConfig.isProd&&e.searchParams.get("olo")!=="1"&&this.swRegStates.total===0&&await this._registerPrecacheAudioRouteServiceWorker()}async _registerPrecacheAudioRouteServiceWorker(){let e=this.appConfig.precacheAudioRouteServiceWorker,i=await new Promise(s=>{navigator.serviceWorker.register(e.scriptURL,{...e,name:"precacheAudioRouteServiceWorker"}).then(n=>{ve.updateUpdateFoundListener(n,this._onSwRegUpdateFound),n.installing&&this.shell.showMessage("Precaching App & sutta texts in the background...",0);let o=n.installing||n.active||n.waiting;o&&(ve.updateStateChangeListener(o,this._onSwStateChange),s(o))})})}_registerRoutes(){this.catalogPage=new lt(this,this.shell,"catalogPageSection","catMenuShellPgA"),this.searchPage=new mt(this,this.shell,"searchPageSection","srchMenuShellPgA"),this.playlistPage=new ht(this,this.shell,"playlistPageSection","playMenuShellPgA"),this.aboutPage=new st(this,this.shell,"aboutPageSection","abtMenuShellPgA"),this.helpPage=new ct(this,this.shell,"helpPageSection","hlpMenuShellPgA"),this.trackPage=new vt(this,this.shell,"trackPageSection","trackMenuShellPgA"),this.e404Page=new it(this,this.shell,"e404PageSection",null);let e=async(t,i,s,n)=>{let o={urlRoute:s,restorePosition:!1};t&&await t.onExit(),o.restorePosition=n<2,await i.onEnter(o)};this.router.onroutechange=e,this.router.onrouteerror=async(t,i)=>{this.shell.showMessage(i,500)}}_registerWorkers(){let e=this.appConfig.albumStoreWorker,t=new Worker(e.scriptURL,{...e,name:"albumStoreWorker"}),i=new J(t);this.albumStoreWorkerClient=new Et(i),this.albumStoreWorkerClient.startClient()}static async _queryAppConfig(){let i=`./bin/app-config${document.getElementById("importMapScript")!==null?"-dev":""}.json`,n=await(await fetch(i)).json(),o=location.host,a=n.hosts.indexOf(o),l="";return a>-1?l=n.appRoots[a]:(console.log(`registered hosts: ${n.hosts}`),console.log(`registered appRoots: ${n.appRoots}`)),console.log(`host: ${o}`),console.log(`appRoot: ${l}`),{...n,host:o,appRoot:l}}static{T.VER=r.VERSION,T.VER_TUPLE=T.toVersionTuple(T.VER),new r().run()}};})();
